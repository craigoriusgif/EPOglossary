<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPOS</title>
    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>
    
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background-color: var(--primary-bg);
        color: var(--text-main); height: 100vh; overflow: hidden; }

        #app-wrapper { display: flex; height: 100vh;
        width: 100vw; position: relative; }
        #main-section { flex: 2; padding: 15px; overflow: hidden;
        background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0;
        }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text);
        display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important;
        color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important;
        }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important;
        }

        .hidden { display: none !important;
        }
        .full-width { flex: 1 0 100% !important; border: none !important;
        }

        .side-pane { 
            position: absolute;
            left: 0; top: 0; bottom: 0; 
            width: 380px; background: white; z-index: 2000; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.15); 
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            padding: 25px;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .side-pane.active { transform: translateX(0);
        }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none;
        font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }

        .header-with-logo { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color); padding-bottom: 15px; gap: 8px; flex-shrink: 0; min-width: 0;
        }
        .header-center-filters { display: flex; flex-grow: 1; gap: 6px; align-items: center; min-width: 0;
        }
        
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
            cursor: pointer;
        }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px;
        border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0;
        }
        
        .btn-ui { height: 40px;
        padding: 0 8px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center;
        justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500;
        }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important;
        }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px;
        font-size: 10px; margin-left: 4px; }

        #today-list-container { display: flex; flex-direction: column; overflow: hidden;
        flex-grow: 1; }
        .today-sticky-header { position: sticky; top: 0; z-index: 100; background: inherit;
        padding-bottom: 10px; }
        #today-scroll-area { overflow-y: auto; flex-grow: 1;
        }

        .full-width #today-body, .full-width #pinned-body { display: block; columns: 2; column-gap: 50px;
        column-rule: 2px solid rgba(128,128,128,0.5); }
        .full-width #today-body tr, .full-width #pinned-body tr { display: flex;
        width: 100%; break-inside: avoid; border-bottom: 1px solid rgba(128,128,128,0.2); }
        .full-width #today-body td, .full-width #pinned-body td { flex: 1;
        padding: 10px 5px; }

        #today-section.full-width .list-table thead {
            display: block;
            width: calc(50% - 25px);
        }
        #today-section.full-width .list-table thead tr {
            display: flex;
            width: 100%;
        }

        .today-header-container { margin-bottom: 15px; border-bottom: 1px solid rgba(128,128,128,0.3);
        padding-bottom: 10px;
        }
        .patent-info-table { width: 100%; font-size: 12px; border-collapse: collapse; background: rgba(0,0,0,0.1);
        }
        .patent-info-table td { padding: 6px 10px; border: 1px solid rgba(128,128,128,0.2);
        }
        .info-label { font-weight: bold; color: #3498db; width: 40%;
        }
        .input-inline-edit { background: transparent; border: none; color: inherit; width: 100%; font-size: 12px;
        outline: none; }

        .list-table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed;
        }
        #today-section .list-table { background: transparent; color: inherit;
        }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1);
        text-align: left; font-size: 13px; overflow-wrap: break-word; }

        #main-section .list-table th {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .list-table th { position: relative;
        user-select: none; }
        .draggable-th { cursor: grab; transition: background 0.2s;
        }
        .draggable-th:active { cursor: grabbing;
        }
        .draggable-th.dragging { opacity: 0.5; background: #eef;
        }
        .draggable-th.drag-over { border-left: 2px solid var(--accent-blue);
        }
        
        .th-content { display: flex;
        align-items: center; gap: 5px; }
        .drag-handle { color: #999; cursor: grab; font-size: 14px;
        opacity: 0.5; }
        .drag-handle:hover { opacity: 1;
        }

        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat, #main-list.hide-def .col-def { display: none !important;
        }
        
        /* New style for the definition column: just wide enough for icon */
        .col-def { width: 35px;
        text-align: center; }
        
        /* New style for column close button */
        .col-close-btn { margin-left: auto;
        cursor: pointer; color: #999; padding: 0 4px; font-weight: bold; }
        .col-close-btn:hover { color: #dc3545;
        }

        .pane-controls { position: fixed; bottom: 20px; left: 20px; z-index: 3000;
        display: flex;
        gap: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid var(--border-color);
        align-items: center;
        transition: left 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out;
            width: auto; max-width: 95vw; overflow-x: auto; white-space: nowrap;
        flex-wrap: nowrap;
        }
        .pane-controls.shifted { left: 400px;
        }
        
        .pane-controls.collapsed { width: 90px;
        padding: 10px 5px; overflow: hidden; }

        .toggle-btn { padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; white-space: nowrap;
        }
        .toggle-btn.active { box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); background: #eee; border-color: #bbb;
        }
        /* Active layout state for menu buttons */
        .active-layout { 
            box-shadow: inset 0 4px 6px rgba(0,0,0,0.3) !important;
        background: #e0e0e0 !important;
            border-color: #999 !important;
        }

        .toggle-btn:not(.active) { box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .btn-gl { background: #7f8c8d !important; color: white !important;
        }
        .btn-cl { background: #2d3436 !important; color: white !important;
        }
        .btn-epc { background: #c0392b !important; color: white !important;
        }
        
        .theme-circle { width: 22px;
        height: 22px; border-radius: 50%; border: 1px solid #999; cursor: pointer; transition: transform 0.1s;
        }
        .theme-circle:hover { transform: scale(1.1);
        }

        .recent-list { margin-top: 25px; text-align: left;
        }
        .recent-item { padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main);
        }
        .recent-item:hover { background: #f9f9f9;
        }

        #drop-area.drag-over { border-color: var(--accent-blue) !important; background: rgba(0, 102, 204, 0.1) !important;
        }
        
        .inline-add-container { display: flex;
        gap: 4px; flex: 1; }
        .inline-add-container input { background: rgba(255,255,255,0.1);
        border: 1px solid rgba(128,128,128,0.3); color: inherit; padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; height: 40px;
        }
        
        .useful-links a { display: block;
        color: var(--accent-blue); text-decoration: none; margin-bottom: 8px; font-size: 13px; }
        .useful-links a:hover { text-decoration: underline;
        }

        /* Flashcard Styles */
        #flashcard-ui { border-bottom: 1px solid rgba(128,128,128,0.3);
        padding-bottom: 15px; margin-bottom: 15px; }

        #flashcard-container { background: rgba(255,255,255,0.1);
        border-radius: 12px; padding: 20px;
        text-align: center; min-height: 140px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(128,128,128,0.3);
        margin-bottom: 15px; cursor: pointer;
        }
        #flashcard-content { font-size: 18px; font-weight: bold;
        }
        #flashcard-lang { font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px;
        }
        .flash-lang-sel { background: rgba(0,0,0,0.2); color: inherit; border: 1px solid rgba(128,128,128,0.5); font-size: 10px;
        border-radius: 4px; padding: 2px; }

        .landing-header {
            display: flex;
        align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .landing-logo {
            height: 50px;
        width: auto;
        }

        @media only screen and (max-width: 768px) {
            #btn-gl, #btn-cl, #btn-epc, .pane-controls span {
                display: none !important;
        }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view.
        <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Click the <strong>Categories</strong> button to filter by legal or technical field.</p>
           
 
             <p><strong>‚ñ• Columns:</strong> Click the <strong>Columns</strong> button to show/hide languages or categories.
        <strong>Drag</strong> column headers to reorder them.</p>
            <p><strong>üí° Definitions:</strong> Click rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g.
        <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Click terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary).
        The button appears once you load today's vocab. Click the card to flip and test yourself.
        Mark done to remove the card from the deck. Click the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
        
            </div>
        </div>
    
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px;
        line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPOS!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0;
        padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Click the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                   
 
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently 
                    used 
glossary files will be remembered during your session. Click on a recently used file to re-open it.</li>
   
                 </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
        
            <p><strong>Oral proceedings</strong></p>
            <p>To import and 
            consult 
terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
        
            <p>Then switch to the <strong>Today's Vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
      
            <p>Ensure your 
            file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            
            <p>The 
Language Service has provided a template for you to use.</p>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
  
    
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue);
        margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic;
        color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px;
        margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <div class="landing-header">
            <img src="logo.jpg" alt="Logo" class="landing-logo">
            <h1 style="margin:0;">EPOS</h1>
        </div>
        <div style="position:relative;
        margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px;
        font-size:14px;">Load EPO Glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0;
        top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%;
        margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px;
        color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently Used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0;
        font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Click here and start typing to search... Tip:üí° Drag the columns to rearrange" style="flex:2;" onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="dropdown-container" style="position:relative;">
                     
                        <button class="btn-ui" onclick="toggleDrop('cat-drop', 
 
                        event)">üè∑Ô∏è Categories <span id="cat-badge-val" class="badge-inline hidden">0</span> <span id="cat-reset-btn" class="hidden" style="color:var(--accent-red);
        margin-left:8px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation();
                        resetCategories()">Reset √ó</span></button>
                        <div id="cat-drop" class="dropdown-options" style="position: absolute;
        top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <div id="master-cat-list"></div>
                        </div>
                    </div>
                   
 
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('col-drop', event)">‚ñ• Columns</button>
                        <div id="col-drop" class="dropdown-options" style="position: absolute;
        top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <label style="display:block;
        margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                            <label style="display:block;
        margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                            <label style="display:block;
        margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                            <label style="display:block;
        margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label>
                            <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('def', this.checked)"> Definition</label> 
                        </div> 
                    </div> 
             
 
                    <button class="btn-ui" onclick="location.reload()">üîÑ Load New</button> 
                    <button class="btn-ui btn-download" onclick="downloadMaster()">üì• Download</button> 
                    <button class="btn-ui" onclick="togglePane('help-pane', true)">‚ùì Help</button> 
                </div> 
       
 
   </div> 

        
            <div id="main-scroll-area" style="flex-grow:1;
        overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead id="master-head-row">
                            </thead> 
     
                  
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" 
class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%;
                height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper" class="hidden"> 
                <div style="display:flex;
        gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" onchange="handleHeaderChange()" style="height:30px;
        font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button id="add-meta-btn" onclick="addMetaRow()" class="btn-ui" style="height:30px;
        width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex;
        border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px;
        font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px;
        font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px;
        font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
 
           </div> 

     
            <div id="flashcard-ui" class="hidden">
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
       
                    <div style="position:absolute;
        bottom:10px; left:0; right:0; font-size:10px; opacity:0.5;">Click to Flip</div>
                </div>
                <div style="display:flex;
        gap:10px; align-items: center;">
                    <div style="display:flex;
        align-items:center; gap:5px; margin-right: auto;">
                        <span style="font-size:12px;
        font-weight:bold;">Study:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
              
                            <option value="fr">FR</option>
                        </select>
                        <span id="flash-count" style="font-size:10px;
        margin-left:8px; opacity:0.7;"></span>
                    </div>

                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1;
        background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5;
        background:var(--accent-green); color:white; border:none;">Mark Done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1;
        background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5);
        padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Click to import today's vocab here as a CSV or Word (.docx) file. Or just drag and drop.</div> 
            
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex;
        gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1;
        padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms... Tip:üí° Click rows to pin terms" onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                      
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                           
       
                              <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue);
        color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue);
        color:white; border:none;">[+] Add Term</button> 
                        
                        <div class="dropdown-container" style="position:relative;">
                            <button class="btn-ui btn-download" onclick="toggleDrop('export-drop', event)">üì• Export ‚ñæ</button>
                            <div id="export-drop" class="dropdown-options" style="position: absolute; top: 45px; right:0; background: white; border: 1px solid #d1d5db; z-index: 1000; width: 150px; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 5px;">
                                <button class="btn-ui" style="width:100%; border:none; text-align:left; justify-content:flex-start;" onclick="downloadToday('csv')">üìÑ CSV</button>
                                <button class="btn-ui" style="width:100%; border:none; text-align:left; justify-content:flex-start;" onclick="downloadToday('docx')">üìù Word (.docx)</button>
                                <button class="btn-ui" style="width:100%; border:none; text-align:left; justify-content:flex-start;" onclick="downloadToday('pdf')">üìë PDF</button>
                            </div>
                        </div>

                        <button onclick="resetTodayView()" class="btn-ui">üîÑ Load New</button>
                        <button onclick="togglePane('help-pane', true)" class="btn-ui">‚ùì Help</button>
           
                     </div> 
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
    
 
                <div id="today-scroll-area"> 
             
 
        <table class="list-table">
    
                        <thead id="today-head-row">
                            </thead>
       
                <tbody id="today-body" class="list"></tbody> 
        
  
           </table> 
    
             </div> 
            </div> 
            
            <div style="margin-top:auto;
        padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
                
                
                <div style="display:flex;
        gap:12px; align-items:center; margin-left:auto;"> 
                    <div style="font-size:12px;
        font-weight:600; opacity:0.8;">üí° Click rows to pin terms</div> 
                    <button onclick="setTheme('light')" style="width:20px;
        height:20px; border-radius:50%; background:#fff; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('dark')" style="width:20px;
        height:20px; border-radius:50%; background:#2d3436; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('sepia')" style="width:20px;
        height:20px; border-radius:50%; background:#f4ecd8; border:1px solid #999; cursor:pointer;"></button> 
                </div> 
            </div> 
        </section> 
    </div>

    <div class="pane-controls hidden" id="bottom-controls">
        <button id="btn-hide-menu" class="toggle-btn" style="background: #f0f2f5;
        font-size:16px; width:40px; justify-content:center;" onclick="toggleMenu(true)">‚óÇ</button>
        
        <button id="btn-expand-menu" class="toggle-btn hidden" style="background: var(--accent-blue);
        color: white; border: none;" onclick="toggleMenu(false)">Menu ‚ò∞</button>

        <button id="btn-split-view" class="toggle-btn" onclick="setLayout('split')">Split View</button>    
        <button id="nav-btn-master" class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <span id="sep-line-1" style="color:#666;
        margin: 0 5px;">|</span>
        <button id="nav-btn-today" class="toggle-btn" onclick="setLayout('today')">Today‚Äôs vocab</button>
        
        <button id="flashcard-btn-float" class="toggle-btn hidden" onclick="toggleFlashcards()" style="background:var(--accent-blue);
        color:white; border:none;">üé¥ Flashcards</button>
        
        <button id="patent-info-btn-float" class="toggle-btn" onclick="togglePatentInfo()" style="background:rgba(0,0,0,0.1);
        border:1px solid #999;">Patent Info ‚ñæ</button>

        <span id="sep-line-2" style="color:#666;
        margin: 0 5px;">|</span>
        
        <div id="theme-toggles" style="display:flex;
        gap:5px; margin: 0 10px;">
             <div class="theme-circle" style="background:#fff;" onclick="setTheme('light')" title="Light"></div>
             <div class="theme-circle" style="background:#2d3436;" onclick="setTheme('dark')" title="Dark"></div>
             <div class="theme-circle" style="background:#f4ecd8;" onclick="setTheme('sepia')" title="Sepia"></div>
        </div>
        
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html', 'Guidelines')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law/2025/index.html', 'Case Law')">Case Law 
        ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html', 'EPC')">EPC ‚ñ¥</button>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
   
        let activeFlashcards = [];
        let previousLayout = 'master';
        let masterCols = [
            { id: 'en', label: 'English', cls: 'col-en' },
            { id: 'de', label: 'German', cls: 'col-de' },
            { id: 'fr', label: 'French', cls: 'col-fr' },
            { id: 'def', label: 'üí°', cls: 'col-def' },
            { id: 'cat', label: 'Category', cls: 'col-cat' }
  ];
        const allTodayCols = [
            { id: 'en', label: 'English', cls: 'en' },
            { id: 'de', label: 'German', cls: 'de' },
            { id: 'fr', label: 'French', cls: 'fr' }
        ];
        let todayCols = [...allTodayCols];

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
   
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
 
    
       pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" 
            }
        };
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
        const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
        itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
 
 
                    itemsDiv.appendChild(div);
                });
        }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
        const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
        localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) { 
            document.getElementById(id).classList.toggle('active', show);
        const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target=\"_blank\">${url}</a>`);
        }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
        document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ?
        linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
        sel.innerHTML = '<option value="" disabled selected>Click to add patent information then press + to add</option>';
        Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = headerTranslations[k][currentMetaLang]; sel.appendChild(opt);
            });
        }

        function handleHeaderChange() {
            const sel = document.getElementById('header-select');
        const selectedText = sel.options[sel.selectedIndex].text;
            if (sel.value) {
                // Update select to show "Click + to add X" instructions
                sel.options[0].textContent = `Click + to add ${selectedText}`;
        sel.value = sel.value; // Keep the actual selection
            }
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
        document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type; const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow(type = null, value = '') {
            if (!type) type = document.getElementById('header-select').value;
        if (!type) return; // Prevent adding if nothing selected
            const table = document.getElementById('meta-table-body');
        let num = ''; if(['opp', 'res', 'apl'].includes(type)) num = table.querySelectorAll(`tr[data-type="${type}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = type;
        tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[type][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" value="${value}" placeholder="..."></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            // Auto switch layout if in master fullscreen mode
            if (previousLayout === 'master' && document.getElementById('main-section').classList.contains('full-width')) {
                setLayout('split');
            }

            const wrapper = document.getElementById('patent-info-wrapper');
            const btn = document.getElementById('patent-info-btn-float');
            const isHidden = wrapper.classList.toggle('hidden');
            btn.textContent = isHidden ? 'Patent Info ‚ñæ' : 'Patent Info ‚ñ¥';
            btn.classList.toggle('active', !isHidden);
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
        Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                const clean = r.data.map(row => ({
                    en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                    definition: row.Definition || row.definition || '',
        
 
            category: (row.Category || row.category || '').replace(/[\[\]"]/g, '').split(',').map(s => s.trim()).filter(s => s).join(', ')
                }));
                saveToHistory(file.name, clean); launchApp(clean);
            }});
        };

        function renderHeaders(type) {
            
            const 
isMaster = type === 'master';
            const cols = isMaster ? masterCols : todayCols;
            const container = document.getElementById(isMaster ? 'master-head-row' : 'today-head-row');
            
            container.innerHTML = '';
            const tr = document.createElement('tr');
    
    
       cols.forEach((col, index) => {
                const th = document.createElement('th');
        th.className = `draggable-th ${col.cls}`;
                th.draggable = !col.pinned;
                
                if (type === 'today') {
                    th.style.width = (100 / cols.length) + '%';
        }

                let closeBtn = '';
        if (type === 'today') {
                    closeBtn = `<span class="col-close-btn" onclick="hideTodayCol('${col.id}', event)">√ó</span>`;
        }

                th.innerHTML = `
                    <div class="th-content">
                        <span class="drag-handle" title="Drag to reorder">‚ãÆ</span>
                        <span style="flex-grow:1">${col.label}</span>
        
                        ${closeBtn}
                   </div>
                `;
        if (!col.pinned) {
                    th.ondragstart = (e) => {
                        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify({type, index}));
                        th.classList.add('dragging');
                    };
                    th.ondragend = () => th.classList.remove('dragging');
        }
                
                th.ondragover = (e) => {
                    e.preventDefault();
        if(!col.pinned) th.classList.add('drag-over');
                };
                th.ondragleave = () => th.classList.remove('drag-over');
                
                th.ondrop = (e) => {
                    e.preventDefault();
        th.classList.remove('drag-over');
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (data.type === type && data.index !== index && !col.pinned) {
                        moveColumn(type, data.index, index);
        }
                };
                
                tr.appendChild(th);
            });
            container.appendChild(tr);
        }

        function hideTodayCol(id, e) {
            e.stopPropagation();
        todayCols = todayCols.filter(c => c.id !== id);
            renderHeaders('today');
            reorderRows('today');
        }

        function moveColumn(type, fromIndex, toIndex) {
            const cols = type === 'master' ?
        masterCols : todayCols;
            const item = cols.splice(fromIndex, 1)[0];
            cols.splice(toIndex, 0, item);
            
            renderHeaders(type);
            reorderRows(type);
        }

        function reorderRows(type) {
            const isMaster = type === 'master';
        const cols = isMaster ? masterCols : todayCols;
            const tbody = document.querySelector(isMaster ? '#main-list .list' : '#today-body');
        Array.from(tbody.children).forEach(tr => {
                const cells = Array.from(tr.children);
                cells.forEach(c => c.remove());
                cols.forEach(col => {
                    let targetClass = col.id;
                    
                    if(type === 'master') {
                        if (col.id === 'cat') targetClass = 'category';
                        if (col.id === 'def') targetClass = 'definition';
                 
           }
                    
                    const cell = cells.find(c => c.classList.contains(targetClass));
                    if(cell) {
                       
          if(type === 'today') cell.style.width = (100 
        / cols.length) + '%';
                          tr.appendChild(cell);
                    }
                });
            });
        }

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
        document.getElementById('app-wrapper').classList.remove('hidden');
            document.querySelector('.pane-controls').classList.remove('hidden');
            
            renderHeaders('master');
            
            masterList = new List('main-section', { 
                valueNames: ['en', 'de', 'fr', 'category', 'definition'], 
                item: `<tr class="master-row"><td class="en col-en"></td><td class="de col-de"></td><td class="fr col-fr"></td><td class="category col-cat"></td><td class="definition col-def"></td></tr>` 
           
            }, data);
        masterList.on('updated', () => reorderRows('master'));
            
            masterList.items.forEach(item => {
                const v = item.values();
                // Set text for languages and category as usual
                item.elm.querySelector('.category').textContent = v.category || '';
                
                // Handle Definition Column (Icon only)
                if (v.definition && v.definition.trim()) {
                    item.elm.querySelector('.definition').innerHTML = 'üí°';
                } else {
                    item.elm.querySelector('.definition').innerHTML = '';
                }

                item.elm.onclick = () => openRowDetails(v);
            });
        const cats = [...new Set(data.flatMap(i => i.category.split(',').map(s => s.trim())))].filter(s => s).sort();
            const filterEl = document.getElementById('master-cat-list'); filterEl.innerHTML = '';
        cats.forEach(c => {
                const label = document.createElement('label'); label.style.display = 'block'; label.innerHTML = `<input type="checkbox" value="${c}" class="cat-chk"> ${c}`;
                label.querySelector('input').onchange = updateFilters; filterEl.appendChild(label);
            });
        setLayout('master');
        }

        function updateFilters() {
            const sel = Array.from(document.querySelectorAll('.cat-chk:checked')).map(i => i.value);
        const badge = document.getElementById('cat-badge-val');
            const resetBtn = document.getElementById('cat-reset-btn');
            if(sel.length > 0) { badge.classList.remove('hidden'); badge.textContent = sel.length; resetBtn.classList.remove('hidden');
        } else { badge.classList.add('hidden'); resetBtn.classList.add('hidden'); }
            masterList.filter(item => sel.length === 0 || sel.every(s => item.values().category.includes(s)));
        }

        function resetCategories() { document.querySelectorAll('.cat-chk').forEach(c => c.checked = false); updateFilters();
        }
        function toggleCol(col, show) { document.getElementById('main-list').classList.toggle(`hide-${col}`, !show);
        }
        function downloadMaster() { const csv = Papa.unparse(masterList.items.map(i => i.values()));
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
        a.download = 'glossary_export.csv'; a.click(); }

        const dropArea = document.getElementById('drop-area');
        dropArea.onclick = () => { let i = document.createElement('input'); i.type='file'; i.onchange=(e)=>handleToday(e.target.files[0]); i.click(); };
        dropArea.ondragover = (e) => { e.preventDefault(); e.stopPropagation();
        };
        dropArea.ondragenter = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drag-over'); };
        dropArea.ondragleave = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); };
        dropArea.ondrop = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleToday(e.dataTransfer.files[0]); };
        function handleToday(file) {
            const ext = file.name.split('.').pop().toLowerCase();
        const processData = (rawData) => {
                const metaTable = document.getElementById('meta-table-body');
        metaTable.innerHTML = '';
                
                const vocab = [];
                rawData.forEach(row => {
                    let en = '', de = '', fr = '';
                    Object.keys(row).forEach(k => { 
                        const l = k.toLowerCase(); 
           
                        if(l==='en'||l==='english') en=row[k];
                        if(l==='de'||l==='german') de=row[k]; 
                        if(l==='fr'||l==='french') fr=row[k]; 
                    });
   
           
                    
                    let matchedKey = null;
                    for (const key in headerTranslations) {
                     
           if (en.toLowerCase().includes(headerTranslations[key].en.toLowerCase())) {
                    
                        matchedKey = key;
                            break;
             
                    
           }
                    }

                  
                    if (matchedKey) {
                     
           addMetaRow(matchedKey, de || fr || '');
        
            } else if (en || de || fr) {
                        vocab.push({ en, de, fr });
        }
                });
                initToday(vocab);
            };
        if (ext === 'csv') {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => processData(r.data) });
        } else if (ext === 'docx') {
                const r = new FileReader();
        r.onload = (e) => mammoth.convertToHtml({arrayBuffer: e.target.result}).then(res => {
                    const temp = document.createElement('div'); temp.innerHTML = res.value; const rows = Array.from(temp.querySelectorAll('tr'));
                    if (rows.length < 1) return; 
                    const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());
             
                    const data = rows.slice(1).map(tr => { 
                        let o = {}; tr.querySelectorAll('td').forEach((td, i) => { if(headers[i]) o[headers[i]] = td.innerText.trim(); }); 
                        return o; 
           
                 });
    
                processData(data);
                });
        r.readAsArrayBuffer(file);
            }
        }

        function initToday(data) {
            document.getElementById('drop-area').classList.add('hidden');
        document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn-float').classList.remove('hidden');
            document.getElementById('today-body').innerHTML = '';
            renderHeaders('today');
            const width = 100 / todayCols.length;
        const itemTpl = `<tr onclick="togglePin(this)" style="cursor:pointer;">${todayCols.map(c => `<td class="${c.id}" style="width:${width}%"></td>`).join('')}</tr>`;
        todayList = new List('today-section', { valueNames: ['en', 'de', 'fr'], item: itemTpl }, data);
            todayList.on('updated', () => reorderRows('today'));
        }

        function toggleInlineAdd() {
            const header = document.getElementById('inline-add-header');
        const search = document.getElementById('today-search');
            const btn = document.getElementById('btn-toggle-add');
            const isAdding = header.classList.toggle('hidden');
            search.classList.toggle('hidden', !isAdding);
            btn.textContent = isAdding ?
        '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value.trim(), de = document.getElementById('new-de').value.trim(), fr = document.getElementById('new-fr').value.trim();
        if (!en) return;
            if (!todayList) initToday([{ en, de, fr }]); else todayList.add({ en, de, fr });
            document.getElementById('new-en').value = '';
        document.getElementById('new-de').value = ''; document.getElementById('new-fr').value = '';
            toggleInlineAdd();
        }

        function togglePin(row) {
            const getVal = (cls) => {
                const el = row.querySelector('.' + cls);
        return el ? el.textContent : '';
            };
            const item = { en: getVal('en'), de: getVal('de'), fr: getVal('fr') };
        const idx = pinnedItems.findIndex(i => i.en === item.en); 
            if (idx > -1) pinnedItems.splice(idx, 1); 
            else pinnedItems.push(item);
            renderPinned();
        }

        function renderPinned() {
            const area = document.getElementById('today-pinned-area'), body = document.getElementById('pinned-body');
        body.innerHTML = ''; 
            area.classList.toggle('hidden', !pinnedItems.length);
            const width = 100 / todayCols.length;
        pinnedItems.forEach(item => {
                const tr = document.createElement('tr'); 
                tr.style.background = 'rgba(0,102,204,0.2)';
                tr.onclick = () => { pinnedItems = pinnedItems.filter(i => i.en !== item.en); renderPinned(); };
                let html = '';
            
                todayCols.forEach((col, idx) => {
                    const isFirst = idx === 0;
                    const val = item[col.id] || '';
                    html += `<td style="width:${width}%;">${isFirst ? 'üìå ' : ''}${val}</td>`;
   
            
                 });
                tr.innerHTML = html;
                body.appendChild(tr);
            });
        }
        
        function resetTodayView() {
            document.getElementById('today-list-container').classList.add('hidden');
        document.getElementById('drop-area').classList.remove('hidden');
            document.getElementById('flashcard-btn-float').classList.add('hidden');
            document.getElementById('patent-info-wrapper').classList.add('hidden');
            todayList = null; 
            pinnedItems = []; 
            
            // Close and reset flashcards
            document.getElementById('flashcard-ui').classList.add('hidden');
            document.getElementById('flashcard-btn-float').classList.remove('active');
            activeFlashcards = [];
            flashcardIndex = 0;

            renderPinned();
            document.getElementById('today-search').value = '';
        }

        function resetFlashcards() {
            if (!todayList || todayList.items.length === 0) return;
        activeFlashcards = [...todayList.items.map(i => i.values())];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
        [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            flashcardIndex = 0;
        showFlashcard();
        }

        function toggleFlashcards() {
            // Auto switch layout if in master fullscreen mode
            if (previousLayout === 'master' && document.getElementById('main-section').classList.contains('full-width')) {
                setLayout('split');
            }
            
            const flashcardUI = document.getElementById('flashcard-ui');
            const btn = document.getElementById('flashcard-btn-float');
            const isVisible = flashcardUI.classList.contains('hidden');
            
            if (isVisible) {
                flashcardUI.classList.remove('hidden');
        btn.classList.add('active');
                resetFlashcards();
            } else {
                flashcardUI.classList.add('hidden');
        btn.classList.remove('active');
            }
        }

        function showFlashcard() {
            const content = document.getElementById('flashcard-content');
        const langLabel = document.getElementById('flashcard-lang');
            const countLabel = document.getElementById('flash-count');
            if (activeFlashcards.length === 0) { langLabel.textContent = "Finished";
        content.textContent = "All terms learned!"; countLabel.textContent = "0 left"; return;
        }
            const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
        isFlashcardFlipped = false;
            langLabel.textContent = source === 'en' ? 'English' : (source === 'de' ? 'German' : 'French');
        content.textContent = item[source] || '';
            countLabel.textContent = `${activeFlashcards.length} left`;
        }

        function flipFlashcard() {
            if (activeFlashcards.length === 0) return;
        const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
            const content = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            isFlashcardFlipped = !isFlashcardFlipped;
        if (isFlashcardFlipped) {
                // Only show labels/values for columns currently visible in today's view
                const targets = ['en', 'de', 'fr'].filter(l => l !== source && todayCols.some(c => c.id === l));
                const langMap = { en: "English", de: "German", fr: "French" };
                
                if (targets.length === 0) {
                    langLabel.textContent = "Translation";
                    content.innerHTML = "Other columns are hidden.";
                } else if (targets.length === 1) {
                    langLabel.textContent = langMap[targets[0]];
                    content.innerHTML = item[targets[0]] || '-';
                } else {
                    const t1 = item[targets[0]] || '';
                    const t2 = item[targets[1]] || '';
                    langLabel.textContent = `${langMap[targets[0]]} & ${langMap[targets[1]]}`;
                    content.innerHTML = `${t1}<br><span style="font-weight:normal; opacity:0.7;">${t2}</span>`;
                }
            } else { 
                showFlashcard();
            }
        }

        function markFlashcardDone() {
            if (activeFlashcards.length === 0) return;
        activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = 0;
            showFlashcard();
        }

        function nextFlashcard() { if (activeFlashcards.length === 0) return;
        flashcardIndex = (flashcardIndex + 1) % activeFlashcards.length; showFlashcard(); }
        function prevFlashcard() { if (activeFlashcards.length === 0) return;
        flashcardIndex = (flashcardIndex - 1 + activeFlashcards.length) % activeFlashcards.length; showFlashcard();
        }

        function setLayout(mode) {
            const m = document.getElementById('main-section'), t = document.getElementById('today-section');
        const btnSplit = document.getElementById('btn-split-view');
            const btnMaster = document.getElementById('nav-btn-master');
            const btnToday = document.getElementById('nav-btn-today');

            m.classList.remove('hidden', 'full-width'); t.classList.remove('hidden', 'full-width');
            btnSplit.classList.remove('active-layout');
            btnMaster.classList.remove('active-layout');
            btnToday.classList.remove('active-layout');

            document.querySelector('.header-with-logo').classList.remove('hidden');
        document.getElementById('main-list').classList.remove('hidden'); 
            document.getElementById('legal-iframe-container').classList.add('hidden');
            document.getElementById('main-title').textContent = 'Glossary';
            
            const themeToggles = document.getElementById('theme-toggles');
            if(mode === 'master') { 
                t.classList.add('hidden');
        m.classList.add('full-width'); 
                previousLayout = 'master';
                themeToggles.style.display = 'none';
                btnMaster.classList.add('active-layout');
            }
            if(mode === 'today') { 
                m.classList.add('hidden');
        t.classList.add('full-width');
                previousLayout = 'today'; 
                themeToggles.style.display = 'flex';
                if(todayList) reorderRows('today');
                btnToday.classList.add('active-layout');
        }
            if(mode === 'split') {
                 previousLayout = 'split';
        themeToggles.style.display = 'flex';
                 btnSplit.classList.add('active-layout');
            }
        }

        function showLegal(url, title) {
            const container = document.getElementById('legal-iframe-container'), iframe = document.getElementById('legal-frame');
        const btnId = title === 'Guidelines' ? 'btn-gl' : (title === 'Case Law' ? 'btn-cl' : 'btn-epc'), btn = document.getElementById(btnId);
        const m = document.getElementById('main-section'), t = document.getElementById('today-section');
            
            if (!container.classList.contains('hidden') && iframe.src === url) { 
                setLayout(previousLayout);
        return; 
            }
            if (t.classList.contains('full-width')) {
                 m.classList.remove('hidden');
        t.classList.remove('full-width');
            }
            document.querySelector('.header-with-logo').classList.add('hidden');
            document.getElementById('main-list').classList.add('hidden'); 
            container.classList.remove('hidden'); 
            iframe.src = url;
        document.getElementById('main-title').textContent = title;
        }

        function setTheme(t) {
            const el = document.getElementById('today-section');
        const isFull = el.classList.contains('full-width');
            el.classList.remove('theme-light', 'theme-dark', 'theme-sepia');
            el.classList.add('theme-' + t);
            if(isFull) el.classList.add('full-width');
        }

        function toggleDrop(id, e) { e.stopPropagation(); const el = document.getElementById(id);
        const isVis = el.style.display === 'block'; document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); el.style.display = isVis ? 'none' : 'block';
        }
        
        function downloadToday(type) {
            if (!todayList || todayList.items.length === 0) return;
            const items = todayList.items.map(i => i.values());
            
            // Only export columns currently visible in today's view
            const exportHeaders = todayCols.map(c => c.label);
            const exportData = items.map(item => todayCols.map(c => item[c.id] || ""));

            if (type === 'csv') {
                const csvData = [exportHeaders, ...exportData];
                const csvString = Papa.unparse(csvData);
                const blob = new Blob([csvString], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'today_glossary.csv';
                a.click();
            } 
            else if (type === 'docx') {
                const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType } = docx;
                
                const tableRows = [
                    new TableRow({
                        children: exportHeaders.map(header => 
                            new TableCell({ children: [new Paragraph({text: header, bold: true})] })
                        )
                    })
                ];

                exportData.forEach(row => {
                    tableRows.push(
                        new TableRow({
                            children: row.map(cell => 
                                new TableCell({ children: [new Paragraph(cell)] })
                            ),
                        })
                    );
                });

                const doc = new Document({
                    sections: [{
                        children: [
                            new Table({
                                rows: tableRows,
                                width: { size: 100, type: WidthType.PERCENTAGE },
                            }),
                        ],
                    }],
                });

                Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'today_glossary.docx';
                    a.click();
                });
            } 
            else if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.autoTable({
                    head: [exportHeaders],
                    body: exportData,
                });
                
                doc.save('today_glossary.pdf');
            }
        }

        window.onload = () => { 
            loadHistory();
        populateHeaderSelect();
        };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
        
        function toggleMenu(collapsed) {
            const controls = document.getElementById('bottom-controls');
        const hideBtn = document.getElementById('btn-hide-menu');
            const expandBtn = document.getElementById('btn-expand-menu');
            const otherElements = controls.querySelectorAll('.toggle-btn:not(#btn-hide-menu):not(#btn-expand-menu), span, #theme-toggles');
        if (collapsed) {
                controls.classList.add('collapsed');
                hideBtn.classList.add('hidden');
        expandBtn.classList.remove('hidden');
                otherElements.forEach(el => el.classList.add('hidden'));
            } else {
                controls.classList.remove('collapsed');
        hideBtn.classList.remove('hidden');
                expandBtn.classList.add('hidden');
                otherElements.forEach(el => {
                    if (el.id === 'flashcard-btn-float' && (!todayList || todayList.items.length === 0)) return; 
                    if (el.id === 'theme-toggles' && previousLayout === 'master') return;
                    el.classList.remove('hidden');
                });
        const themeToggles = document.getElementById('theme-toggles');
                if (previousLayout === 'today' || previousLayout === 'split') {
                    themeToggles.style.display = 'flex';
        }
            }
        }
    </script>
</body>
</html>
