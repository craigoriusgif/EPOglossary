<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EPOS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; 
            padding: 0; 
            background-color: var(--primary-bg); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        #app-wrapper { 
            display: flex;
            height: 100vh; 
            width: 100vw; 
            position: relative; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #main-section { flex: 2; padding: 15px; overflow: hidden; background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0; }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text); display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important; color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important; }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important; }

        .hidden { display: none !important; }

        /* --- Landscape Handling for Today's View (Change 1) --- */
        .full-width #today-body, .full-width #pinned-body { display: table-row-group; }
        .full-width #today-body tr, .full-width #pinned-body tr { display: table-row; width: 100%; }

        @media only screen and (orientation: landscape) {
            /* Enable 2-column Grid for Today's View */
            .full-width #today-body { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 15px; 
            }
            
            /* Hide the main table header in landscape grid mode to avoid misalignment */
            .full-width #today-table thead { display: none; }

            /* Style the rows as individual cards */
            .full-width #today-body tr { 
                display: flex; 
                flex-direction: column; 
                width: 100%; 
                background: rgba(255,255,255,0.05); 
                border: 1px solid rgba(128,128,128,0.3);
                border-radius: 8px;
                padding: 10px;
                box-sizing: border-box;
            }

            /* Light theme adjustments for landscape cards */
            #today-section.theme-light .full-width #today-body tr {
                background: #f8f9fa;
                border: 1px solid #ddd;
            }
            #today-section.theme-sepia .full-width #today-body tr {
                background: rgba(0,0,0,0.05);
            }

            .full-width #today-body td { 
                display: block; 
                padding: 4px 0; 
                width: 100%; 
                border: none;
            }

            /* Add labels to cells so data maps to headers visibly */
            .full-width #today-body td.en::before { content: "EN"; font-size: 9px; font-weight: bold; opacity: 0.6; display: block; margin-bottom: 2px; color: var(--accent-blue); }
            .full-width #today-body td.de::before { content: "DE"; font-size: 9px; font-weight: bold; opacity: 0.6; display: block; margin-bottom: 2px; color: var(--accent-blue); }
            .full-width #today-body td.fr::before { content: "FR"; font-size: 9px; font-weight: bold; opacity: 0.6; display: block; margin-bottom: 2px; color: var(--accent-blue); }
            
            /* --- Landscape Header Scrolling for Glossary (Change 4) --- */
            #main-section .list-table th { position: static !important; }
        }

        /* Updated Z-Index to 4000 to be above menu (3000) */
        .side-pane { position: absolute; left: 0; top: 0; bottom: 0; width: 380px; background: white; z-index: 4000; box-shadow: 5px 0 15px rgba(0,0,0,0.15); transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding: 25px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); color: var(--text-main); }
        .side-pane.active { transform: translateX(0); }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none; font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .header-with-logo { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-shrink: 0; min-width: 0; }
        
        /* Layout for Glossary Header (Change 3) */
        .header-top-row { display: flex; align-items: center; width: 100%; gap: 15px; justify-content: space-between; }
        .header-center-filters { display: flex; width: 100%; gap: 8px; align-items: center; min-width: 0; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; }
        .header-center-filters::-webkit-scrollbar { display: none; }
        
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; height: 16px; width: 16px; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E"); cursor: pointer; }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0; }
        #master-search { flex-grow: 1; margin-left: 10px; }

        .btn-ui { height: 40px; padding: 0 12px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500; }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important; }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px; font-size: 10px; margin-left: 4px; }

        #today-list-container { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        .today-sticky-header { position: sticky; top: 0; z-index: 100; background: inherit; padding-bottom: 10px; }
        #today-scroll-area { overflow-y: auto; flex-grow: 1; }

        .today-header-container { margin-bottom: 15px; border-bottom: 1px solid rgba(128,128,128,0.3); padding-bottom: 10px; }
        .patent-info-table { width: 100%; font-size: 12px; border-collapse: collapse; background: rgba(0,0,0,0.1); }
        .patent-info-table td { padding: 6px 10px; border: 1px solid rgba(128,128,128,0.2); }
        .info-label { font-weight: bold; color: #3498db; width: 40%; }
        .input-inline-edit { background: transparent; border: none; color: inherit; width: 100%; font-size: 12px; outline: none; }

        .list-table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        #today-section .list-table { background: transparent; color: inherit; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1); text-align: left; font-size: 13px; overflow: hidden; text-overflow: ellipsis; }
        
        .list-table th { position: sticky; top: 0; z-index: 10; cursor: move; user-select: none; border-bottom: 2px solid var(--accent-blue); }
        #main-section .list-table th { background-color: #ffffff; }
        #today-section.theme-dark .list-table th { background-color: #2d3436; color: #dfe6e9; }
        #today-section.theme-light .list-table th { background-color: #ffffff; color: #1c1e21; }
        #today-section.theme-sepia .list-table th { background-color: #f4ecd8; color: #5b4636; }

        .list-table th:hover { background-color: rgba(0,0,0,0.05); }
        .list-table th.dragging { opacity: 0.5; background: #e0e0e0; }
        
        .list-table th.pinned { position: sticky; left: 0; z-index: 20; border-right: 2px solid var(--accent-blue); }
        #main-section .list-table th.pinned { background-color: #ffffff; }
        #today-section.theme-dark .list-table th.pinned { background-color: #2d3436; }
        #today-section.theme-light .list-table th.pinned { background-color: #ffffff; }
        #today-section.theme-sepia .list-table th.pinned { background-color: #f4ecd8; }

        .list-table td.pinned { position: sticky; left: 0; z-index: 5; background: inherit; border-right: 2px solid rgba(128,128,128,0.2); }
        #main-section .list-table td.pinned { background-color: #ffffff; }
        #today-section.theme-dark .list-table td.pinned { background-color: #2d3436; }
        #today-section.theme-light .list-table td.pinned { background-color: #ffffff; }
        #today-section.theme-sepia .list-table td.pinned { background-color: #f4ecd8; }

        .pin-icon { float: right; cursor: pointer; font-size: 10px; margin-left: 5px; opacity: 0.5; }
        .pin-icon:hover, .pinned .pin-icon { opacity: 1; color: var(--accent-blue); }
        
        .drag-handle { color: #999; margin-right: 5px; cursor: move; font-size: 14px; }

        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat { display: none !important; }

        #menu-btn-trigger {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 20px;
            z-index: 2999;
            background: var(--accent-blue);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pane-controls { 
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 20px; 
            z-index: 3000; 
            display: flex; 
            gap: 10px; 
            background: rgba(255,255,255,0.98); 
            padding: 10px; 
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            border: 1px solid var(--border-color); 
            align-items: center; 
            transition: left 0.3s ease-in-out;
            max-width: calc(100vw - 40px);
            overflow-x: auto;
            white-space: nowrap;
        }
        .pane-controls::-webkit-scrollbar { display: none; }
        
        .toggle-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; flex-shrink: 0; }
        .btn-gl { background: #7f8c8d !important; color: white !important; }
        .btn-epc { background: #c0392b !important; color: white !important; }
        /* New Style for Case Law Button */
        .btn-cl { background: white !important; color: black !important; border: 2px solid black !important; font-weight: bold; }

        .recent-list { margin-top: 25px; text-align: left; }
        .recent-item { padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
        .recent-item:hover { background: #f9f9f9; }

        #drop-area.drag-over { border-color: var(--accent-blue) !important; background: rgba(0, 102, 204, 0.1) !important; }
        
        .inline-add-container { display: flex; gap: 4px; flex: 1; }
        .inline-add-container input { background: rgba(255,255,255,0.1); border: 1px solid rgba(128,128,128,0.3); color: inherit; padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; height: 40px; }
        
        .useful-links a { display: block; color: var(--accent-blue); text-decoration: none; margin-bottom: 8px; font-size: 13px; }
        .useful-links a:hover { text-decoration: underline; }

        #flashcard-container { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; min-height: 140px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(128,128,128,0.3); margin-bottom: 15px; cursor: pointer; }
        #flashcard-content { font-size: 18px; font-weight: bold; }
        #flashcard-lang { font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px; }
        .flash-lang-sel { background: rgba(0,0,0,0.2); color: inherit; border: 1px solid rgba(128,128,128,0.5); font-size: 10px; border-radius: 4px; padding: 2px; }

        @media only screen and (max-width: 768px) {
            #btn-split-view, .pane-controls span { display: none !important; }
            .inline-add-container { flex-direction: column; width: 100%; gap: 8px; }
            .inline-add-container input { width: 100%; }
            #inline-add-header { height: auto; padding-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view.
             <strong>EPO Glossary</strong> is a comprehensive terminology reference.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Tap the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Drag headers (use the ‚ãÆ‚ãÆ handle) to reorder. Click the pin icon to freeze the first column. Tap the <strong>Columns</strong> button to show/hide languages.</p>
     
            <p><strong>üí° Definitions:</strong> Tap rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g.
            <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Tap terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary).
            The button appears once you load today's vocab. Tap the card to flip and test yourself.
            Mark done to remove the card from the deck. Tap the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://www.epo.org/en/legal/guidelines-epc/2025/index.html" target="_blank">Guidelines</a>
                <a href="https://www.epo.org/en/legal/case-law/2025/index.html" target="_blank">Case Law</a>
                <a href="https://www.epo.org/en/legal/epc/2020/convention.html" target="_blank">EPC</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
      
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPOS!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                   
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
   
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To import and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
        
            <p>Then switch to the <strong>Today's Vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
            <p>Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            <p>The Language Service has provided a template for you to use.</p>
        </div>
    </div>
    
    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPOS</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently Used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <div class="header-top-row">
                    <h2 id="main-title" style="margin:0; font-size:18px; white-space:nowrap;">Glossary</h2>
                    <input type="search" id="master-search" placeholder="Tap to search terms..." onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                </div>
                <div class="header-center-filters">
                    <div class="dropdown-container" style="position:relative; flex-shrink: 0;">
                        <button class="btn-ui" onclick="toggleDrop('cat-drop', event)">üè∑Ô∏è Cats <span id="cat-badge-val" class="badge-inline hidden">0</span></button>
                        <div id="cat-reset-btn" class="hidden" style="position: absolute; top: -15px; right: 0; color:var(--accent-red); font-size: 10px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</div>
                        <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <div id="master-cat-list"></div>
                        </div>
                    </div>
       
                    <div class="dropdown-container" style="position:relative; flex-shrink: 0;">
                        <button class="btn-ui" onclick="toggleDrop('col-drop', event)">‚ñ• Cols</button>
                        <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                            <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                        </div> 
                    </div> 
 
                    <button class="btn-ui" onclick="location.reload()" style="flex-shrink: 0;">üîÑ Load new</button> 
                    <button class="btn-ui btn-download" onclick="downloadMaster()" style="flex-shrink: 0;">üì• Download</button> 
                    <button class="btn-ui" onclick="togglePane('help-pane', true)" style="flex-shrink: 0;">‚ùì</button> 
                </div> 
            </div> 
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table" id="master-table"> 
                        <thead>
                            <tr id="master-header-row">
                                <th class="col-en" draggable="true" data-col="en"><span class="drag-handle">‚ãÆ‚ãÆ</span>English <span class="pin-icon" onclick="togglePinColumn('master-table', 'en')">üìå</span></th>
                                <th class="col-de" draggable="true" data-col="de"><span class="drag-handle">‚ãÆ‚ãÆ</span>German <span class="pin-icon" onclick="togglePinColumn('master-table', 'de')">üìå</span></th>
                                <th class="col-fr" draggable="true" data-col="fr"><span class="drag-handle">‚ãÆ‚ãÆ</span>French <span class="pin-icon" onclick="togglePinColumn('master-table', 'fr')">üìå</span></th>
                                <th class="col-cat" draggable="true" data-col="category"><span class="drag-handle">‚ãÆ‚ãÆ</span>Category <span class="pin-icon" onclick="togglePinColumn('master-table', 'category')">üìå</span></th>
                            </tr>
                        </thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper" class="hidden"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 

            <div id="flashcard-ui" class="hidden">
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
                    <div style="position:absolute; bottom:10px; left:10px; font-size:10px; opacity:0.5;">Click to Flip</div>
                    <div id="flash-count" style="position:absolute; bottom:10px; right:10px; font-size:10px; opacity:0.7;"></div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">Study:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
                            <option value="fr">FR</option>
                        </select>
                    </div>
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark Done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5); padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Tap to import CSV or Word (.docx) table</div> 
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1; padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms..." onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                            <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue); color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue); color:white; border:none;">[+] Add Term</button> 
                        
                        <div class="dropdown-container" style="position:relative;">
                            <button class="btn-ui btn-download" onclick="toggleDrop('today-export-drop', event)">üì• Export</button>
                            <div id="today-export-drop" class="dropdown-options" style="position: absolute; top: 45px; right: 0; background: white; border: 1px solid #d1d5db; z-index: 1000; width: 140px; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21; border-bottom: 1px solid #eee;" onclick="downloadToday('csv')">CSV (.csv)</div>
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21; border-bottom: 1px solid #eee;" onclick="downloadToday('docx')">Word (.docx)</div>
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21;" onclick="downloadToday('pdf')">PDF (.pdf)</div>
                            </div>
                        </div>
                    </div> 
                    
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table" id="today-table">
                        <thead>
                            <tr id="today-header-row">
                                <th class="col-en" draggable="true" data-col="en"><span class="drag-handle">‚ãÆ‚ãÆ</span>English <span class="pin-icon" onclick="togglePinColumn('today-table', 'en')">üìå</span></th>
                                <th class="col-de" draggable="true" data-col="de"><span class="drag-handle">‚ãÆ‚ãÆ</span>German <span class="pin-icon" onclick="togglePinColumn('today-table', 'de')">üìå</span></th>
                                <th class="col-fr" draggable="true" data-col="fr"><span class="drag-handle">‚ãÆ‚ãÆ</span>French <span class="pin-icon" onclick="togglePinColumn('today-table', 'fr')">üìå</span></th>
                            </tr>
                        </thead>
                        <tbody id="today-body" class="list"></tbody> 
                    </table> 
                </div> 
            </div> 
    
            
            <div style="margin-top:auto; padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
                <div style="font-size:12px; font-weight:600; opacity:0.8;">üí° Click rows to pin terms</div> 
                <div style="display:flex; gap:12px; align-items:center;"> 
                    <button id="flashcard-btn" class="btn-ui hidden" onclick="toggleFlashcards()" style="height:25px; background:var(--accent-blue); color:white; border:none; padding:0 12px;">Flashcards</button>
                    <button onclick="setTheme('light')" style="width:20px; height:20px; border-radius:50%; background:#fff; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('dark')" style="width:20px; height:20px; border-radius:50%; background:#2d3436; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('sepia')" style="width:20px; height:20px; border-radius:50%; background:#f4ecd8; border:1px solid #999; cursor:pointer;"></button> 
                </div> 
            </div> 
        </section> 
    </div>

    <button id="menu-btn-trigger" class="hidden" onclick="toggleMenu(true)">Menu ‚ñ¥</button>

    <div id="bottom-menu" class="pane-controls hidden">
        <button onclick="toggleMenu(false)" style="margin-right:5px; border:none; background:transparent; font-size:14px; cursor:pointer;">‚ñº</button>
        <button id="btn-split-view" class="toggle-btn" onclick="setLayout('split')">Split View</button>
        <button class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <button class="toggle-btn" onclick="setLayout('today')">Today's Vocab</button>
        <button class="toggle-btn" onclick="setLayout('today'); togglePatentInfo();">Patent Info ‚ñ¥</button>
        <button id="btn-flash-mobile" class="toggle-btn hidden" onclick="setLayout('today'); toggleFlashcards();" style="background: var(--accent-blue); color: white;">üé¥ Flashcards</button>
        <span style="color:#666; margin: 0 5px;">|</span>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law')">Case Law ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html')">EPC ‚ñ¥</button>
        <span style="color:#ccc; font-weight:bold; margin-left:10px;">&gt;&gt;</span>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
        let activeFlashcards = [];
        // Track the active layout for returning from Legal view (Change 2)
        let lastActiveView = 'master'; 

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
            
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
            pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" }
        };

        // --- Drag and Drop Logic ---
        let dragSrcEl = null;

        function enableDragAndDrop(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th[draggable="true"]');
            
            headers.forEach(header => {
                header.addEventListener('dragstart', handleDragStart, false);
                header.addEventListener('dragover', handleDragOver, false);
                header.addEventListener('drop', handleDrop, false);
                header.addEventListener('dragend', handleDragEnd, false);
            });
        }

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                // Get indexes
                const srcIndex = Array.from(this.parentNode.children).indexOf(dragSrcEl);
                const targetIndex = Array.from(this.parentNode.children).indexOf(this);
                const table = this.closest('table');
                
                // Reorder Header
                if (srcIndex < targetIndex) {
                    this.parentNode.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(dragSrcEl, this);
                }

                // Reorder Body Rows
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = Array.from(row.children);
                    if(cells.length > Math.max(srcIndex, targetIndex)) {
                        const srcCell = cells[srcIndex];
                        const targetCell = cells[targetIndex];
                        // If we are moving forward
                        if (srcIndex < targetIndex) {
                            row.insertBefore(srcCell, targetCell.nextSibling);
                        } else {
                            row.insertBefore(srcCell, targetCell);
                        }
                    }
                });
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            const tableId = this.closest('table').id;
            document.querySelectorAll(`#${tableId} th`).forEach(th => th.classList.remove('dragging'));
        }

        function togglePinColumn(tableId, colType) {
            const table = document.getElementById(tableId);
            const th = table.querySelector(`th[data-col="${colType}"]`);
            const index = Array.from(th.parentNode.children).indexOf(th);
            const isPinned = th.classList.contains('pinned');
            
            // Unpin all first
            table.querySelectorAll('.pinned').forEach(el => el.classList.remove('pinned'));
            
            if (!isPinned) {
                th.classList.add('pinned');
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    if (row.children[index]) row.children[index].classList.add('pinned');
                });
            }
        }

        function toggleMenu(show) {
            const bar = document.getElementById('bottom-menu');
            const trigger = document.getElementById('menu-btn-trigger');
            if (show) {
                bar.classList.remove('hidden');
                trigger.classList.add('hidden');
                bar.scrollLeft = 0; // Reset scroll to far left
            } else {
                bar.classList.add('hidden');
                trigger.classList.remove('hidden');
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
                itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
                    itemsDiv.appendChild(div);
                });
            }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
            localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) { 
            document.getElementById(id).classList.toggle('active', show);
            const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target=\"_blank\">${url}</a>`);
        }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
            document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ?
            linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            sel.innerHTML = '';
            Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = headerTranslations[k][currentMetaLang]; sel.appendChild(opt);
            });
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
            document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type; const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow() {
            const type = document.getElementById('header-select').value;
            const table = document.getElementById('meta-table-body');
            let num = ''; if(['opp', 'res', 'apl'].includes(type)) num = table.querySelectorAll(`tr[data-type="${type}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = type; tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[type][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" placeholder="..."></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            document.getElementById('patent-info-wrapper').classList.toggle('hidden');
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                const clean = r.data.map(row => ({
                    en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                    definition: row.Definition || row.definition || '',
        
                    category: (row.Category || row.category || '').replace(/[\[\]"]/g, '').split(',').map(s => s.trim()).filter(s => s).join(', ')
                }));
                saveToHistory(file.name, clean); launchApp(clean);
            }});
        };

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
 
            document.getElementById('app-wrapper').classList.remove('hidden');
            toggleMenu(true);
            
            // Re-render item logic to keep data attributes for filtering
            masterList = new List('main-section', { 
                valueNames: ['en', 'de', 'fr', 'category', 'definition'], 
                item: `<tr class="master-row"><td class="en col-en" data-col="en"></td><td class="de col-de" data-col="de"></td><td class="fr col-fr" data-col="fr"></td><td class="category col-cat" data-col="category"></td></tr>` 
            }, data);

            masterList.items.forEach(item => {
                const v = item.values(); if (v.definition && v.definition.trim()) item.elm.querySelector('.en').innerHTML += 'üí°';
                item.elm.onclick = () => openRowDetails(v);
            });
            const cats = [...new Set(data.flatMap(i => i.category.split(',').map(s => s.trim())))].filter(s => s).sort();
            const filterEl = document.getElementById('master-cat-list'); filterEl.innerHTML = '';
            cats.forEach(c => {
                const label = document.createElement('label'); label.style.display = 'block'; label.innerHTML = `<input type="checkbox" value="${c}" class="cat-chk"> ${c}`;
                label.querySelector('input').onchange = updateFilters; filterEl.appendChild(label);
            });
            enableDragAndDrop('master-table');
            if (window.innerWidth <= 768) setLayout('master');
        }

        function updateFilters() {
            const sel = Array.from(document.querySelectorAll('.cat-chk:checked')).map(i => i.value);
            const badge = document.getElementById('cat-badge-val');
            const resetBtn = document.getElementById('cat-reset-btn');
            if(sel.length > 0) { badge.classList.remove('hidden'); badge.textContent = sel.length; resetBtn.classList.remove('hidden');
            } 
            else { badge.classList.add('hidden'); resetBtn.classList.add('hidden');
            }
            masterList.filter(item => sel.length === 0 || sel.every(s => item.values().category.includes(s)));
        }

        function resetCategories() { document.querySelectorAll('.cat-chk').forEach(c => c.checked = false); updateFilters();
        }
        function toggleCol(col, show) { document.getElementById('main-list').classList.toggle(`hide-${col}`, !show);
        }

        // --- NEW WORKING CAPACITOR DOWNLOAD LOGIC ---
        async function performDownload(csvData, fileName) {
            if (window.Capacitor && Capacitor.Plugins.Filesystem) {
                try {
                    const { Filesystem, Share } = Capacitor.Plugins;
                    const result = await Filesystem.writeFile({
                        path: fileName,
                        data: csvData,
                        directory: 'DOCUMENTS',
                        encoding: 'utf8'
                    });
                    if (Share) {
                        await Share.share({
                            title: 'Export Glossary',
                            url: result.uri,
                            dialogTitle: 'Share CSV file'
                        });
                    } else {
                        alert("File saved to Documents: " + fileName);
                    }
                } catch (err) {
                    console.error('Download failed', err);
                    alert("Export failed: " + err.message);
                }
            } else {
                const blob = new Blob(["\ufeff" + csvData], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Master Download trigger
        function downloadMaster() { 
            if (!masterList || masterList.items.length === 0) return;
            const csvData = Papa.unparse(masterList.visibleItems.map(item => {
                const v = item.values();
                return { EN: v.en, DE: v.de, FR: v.fr, Category: v.category, Definition: v.definition };
            }));
            performDownload(csvData, "epo_master_glossary.csv");
        }

        const dropArea = document.getElementById('drop-area');
        dropArea.onclick = () => { let i = document.createElement('input'); i.type='file'; i.onchange=(e)=>handleToday(e.target.files[0]); i.click(); };
        dropArea.ondragover = (e) => { e.preventDefault(); e.stopPropagation();
        };
        dropArea.ondragenter = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drag-over'); };
        dropArea.ondragleave = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); };
        dropArea.ondrop = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleToday(e.dataTransfer.files[0]); };
        function handleToday(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'csv') {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                    const norm = r.data.map(row => {
                        let o = { en: '', de: '', fr: '' }; 
                        Object.keys(row).forEach(k => { 
                            const l = k.toLowerCase(); 
                            if(l==='en'||l==='english') o.en=row[k]; 
                            if(l==='de'||l==='german') o.de=row[k]; 
                            if(l==='fr'||l==='french') o.fr=row[k]; 
                        });
                        return o;
                     });
                    initToday(norm);
                }});
            } else if (ext === 'docx') {
                const r = new FileReader();
                r.onload = (e) => mammoth.convertToHtml({arrayBuffer: e.target.result}).then(res => {
                    const temp = document.createElement('div'); temp.innerHTML = res.value; 
                    const rows = Array.from(temp.querySelectorAll('tr'));
                    if (rows.length < 1) return; 
                    const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());
                    initToday(rows.slice(1).map(tr => { 
                        let o = { en: '', de: '', fr: '' }; 
                        tr.querySelectorAll('td').forEach((td, i) => { 
                             if(headers[i].includes('en') || headers[i].includes('english')) o.en = td.innerText.trim();
                            if(headers[i].includes('de') || headers[i].includes('german')) o.de = td.innerText.trim();
                            if(headers[i].includes('fr') || headers[i].includes('french')) o.fr = td.innerText.trim();
                        }); 
                        return o; 
                    }));
                });
                r.readAsArrayBuffer(file);
            }
        }

        function initToday(data) {
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn').classList.remove('hidden');
            if (window.innerWidth <= 768) document.getElementById('btn-flash-mobile').classList.remove('hidden');

            const hasEn = data.some(row => row.en && row.en.trim() !== "");
            const hasDe = data.some(row => row.de && row.de.trim() !== "");
            const hasFr = data.some(row => row.fr && row.fr.trim() !== "");
            
            // Re-render template to ensure data mapping
            let rowTemplate = '<tr onclick="togglePin(this)" style="cursor:pointer;">';
            if (hasEn) rowTemplate += '<td class="en" data-col="en"></td>';
            if (hasDe) rowTemplate += '<td class="de" data-col="de"></td>';
            if (hasFr) rowTemplate += '<td class="fr" data-col="fr"></td>';
            rowTemplate += '</tr>';

            todayList = new List('today-section', { valueNames: ['en', 'de', 'fr'], item: rowTemplate }, data);
            
            // Hide headers if no data
            if(!hasEn) document.querySelector('#today-header-row .col-en').style.display='none';
            if(!hasDe) document.querySelector('#today-header-row .col-de').style.display='none';
            if(!hasFr) document.querySelector('#today-header-row .col-fr').style.display='none';

            enableDragAndDrop('today-table');
        }

        function toggleInlineAdd() {
            const header = document.getElementById('inline-add-header');
            const search = document.getElementById('today-search');
            const btn = document.getElementById('btn-toggle-add');
            const isAdding = header.classList.toggle('hidden');
            search.classList.toggle('hidden', !isAdding);
            btn.textContent = isAdding ?
            '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value.trim(), de = document.getElementById('new-de').value.trim(), fr = document.getElementById('new-fr').value.trim();
            if (!en) return;
            if (!todayList) initToday([{ en, de, fr }]); else todayList.add({ en, de, fr });
            document.getElementById('new-en').value = '';
            document.getElementById('new-de').value = ''; document.getElementById('new-fr').value = '';
            toggleInlineAdd();
        }

        function togglePin(row) {
            const item = { en: row.querySelector('.en')?.textContent ||
            '', de: row.querySelector('.de')?.textContent || '', fr: row.querySelector('.fr')?.textContent || '' };
            const idx = pinnedItems.findIndex(i => i.en === item.en);
            if (idx > -1) pinnedItems.splice(idx, 1); else pinnedItems.push(item);
            renderPinned();
        }

        function renderPinned() {
            const area = document.getElementById('today-pinned-area'), body = document.getElementById('pinned-body');
            body.innerHTML = ''; area.classList.toggle('hidden', !pinnedItems.length);
            pinnedItems.forEach(item => {
                const tr = document.createElement('tr'); tr.style.background = 'rgba(0,102,204,0.2)';
                tr.onclick = () => { pinnedItems = pinnedItems.filter(i => i.en !== item.en); renderPinned(); };
                tr.innerHTML = `<td style=\"width:33%;\">üìå ${item.en}</td><td style=\"width:33%;\">${item.de}</td><td style=\"width:33%;\">${item.fr}</td>`;
                body.appendChild(tr);
            });
        }

        function resetFlashcards() {
            if (!todayList || todayList.items.length === 0) return;
            activeFlashcards = [...todayList.items.map(i => i.values())];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            flashcardIndex = 0;
            showFlashcard();
        }

        function toggleFlashcards() {
            const isVisible = document.getElementById('flashcard-ui').classList.toggle('hidden');
            if (!isVisible) resetFlashcards();
        }

        function showFlashcard() {
            const content = document.getElementById('flashcard-content'), langLabel = document.getElementById('flashcard-lang'), countLabel = document.getElementById('flash-count');
            if (activeFlashcards.length === 0) {
                langLabel.textContent = "Finished";
                content.textContent = "All terms learned!"; countLabel.textContent = "0 left"; return;
            }
            const item = activeFlashcards[flashcardIndex], source = document.getElementById('flash-source-lang').value;
            isFlashcardFlipped = false;
            langLabel.textContent = source === 'en' ? 'English' : (source === 'de' ? 'German' : 'French');
            content.textContent = item[source];
            countLabel.textContent = `${activeFlashcards.length} left`;
        }

        function flipFlashcard() {
            if (activeFlashcards.length === 0) return;
            const item = activeFlashcards[flashcardIndex], source = document.getElementById('flash-source-lang').value;
            const content = document.getElementById('flashcard-content'), langLabel = document.getElementById('flashcard-lang');
            isFlashcardFlipped = !isFlashcardFlipped;
            if (isFlashcardFlipped) {
                const targets = ['en', 'de', 'fr'].filter(l => l !== source);
                langLabel.textContent = "Translations";
                content.innerHTML = `${item[targets[0]]}<br><span style="font-weight:normal; font-size:14px; opacity:0.7;">${item[targets[1]]}</span>`;
            } else showFlashcard();
        }

        function markFlashcardDone() {
            if (activeFlashcards.length === 0) return;
            activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = 0;
            showFlashcard();
        }

        function nextFlashcard() { if (activeFlashcards.length === 0) return;
            flashcardIndex = (flashcardIndex + 1) % activeFlashcards.length; showFlashcard(); }
        function prevFlashcard() { if (activeFlashcards.length === 0) return;
            flashcardIndex = (flashcardIndex - 1 + activeFlashcards.length) % activeFlashcards.length; showFlashcard();
        }

        function setLayout(mode) {
            // If setting a specific view, record it (unless it's 'split', which we treat as a special case or default to master for memory)
            if (mode === 'master' || mode === 'today') {
                lastActiveView = mode;
            }

            const m = document.getElementById('main-section'), t = document.getElementById('today-section');
            m.classList.remove('hidden', 'full-width'); t.classList.remove('hidden', 'full-width');
            document.getElementById('main-list').classList.remove('hidden'); 
            
            // Reset full screen legal view stuff
            document.querySelector('.header-with-logo').classList.remove('hidden');
            document.getElementById('legal-iframe-container').classList.add('hidden');
            
            document.getElementById('main-title').textContent = 'Glossary';
            if(mode === 'master') { t.classList.add('hidden'); m.classList.add('full-width');
            }
            if(mode === 'today') { m.classList.add('hidden'); t.classList.add('full-width');
            }
        }

        // Updated showLegal for Change 2
        function showLegal(url) {
            const container = document.getElementById('legal-iframe-container');
            const iframe = document.getElementById('legal-frame');
            const isVisible = !container.classList.contains('hidden');
            const isSameUrl = iframe.src === url;

            if (isVisible && isSameUrl) {
                // If it's already showing this URL, toggle back to previous view
                setLayout(lastActiveView);
            } else {
                // Open full screen (no header)
                document.getElementById('main-list').classList.add('hidden');
                container.classList.remove('hidden'); 
                iframe.src = url; 
                document.querySelector('.header-with-logo').classList.add('hidden');
            }
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t;
        }
        function toggleDrop(id, e) { e.stopPropagation(); const el = document.getElementById(id);
        const isVis = el.style.display === 'block'; document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); el.style.display = isVis ? 'none' : 'block';
        }

        // Metadata extraction for exports
        function getPatentMetadata() {
            const meta = [];
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const label = tr.querySelector('.info-label')?.textContent || "";
                const value = tr.querySelector('.input-inline-edit')?.value || "";
                if (value) meta.push(`${label}: ${value}`);
            });
            return meta;
        }

        // Enhanced Export for Today View
        async function downloadToday(format) { 
            if (!todayList || todayList.items.length === 0) return;
            const items = todayList.items.map(i => i.values());
            const metadata = getPatentMetadata();
            const timestamp = new Date().toISOString().slice(0,10);
            const fileName = `today_vocab_${timestamp}`;
            if (format === 'csv') {
                const csvData = Papa.unparse(items);
                // Also utilizing the Capacitor-friendly download here
                performDownload(csvData, `${fileName}.csv`);
            } 
            
            else if (format === 'docx') {
                const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun } = window.docx;
                const metaParagraphs = metadata.map(line => new Paragraph({
                    children: [new TextRun({ text: line, size: 20 })]
                }));
                const rows = items.map(item => new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph(item.en || "")] }),
                        new TableCell({ children: [new Paragraph(item.de || "")] }),
                        new TableCell({ children: [new Paragraph(item.fr || "")] }),
                    ],
                }));
                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({ text: "Vocabulary List Export", heading: "Heading1" }),
                            ...metaParagraphs,
                            new Paragraph({ text: "", spacing: { before: 200 } }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ text: "English", bold: true })] }),
                                            new TableCell({ children: [new Paragraph({ text: "German", bold: true })] }),
                                            new TableCell({ children: [new Paragraph({ text: "French", bold: true })] }),
                                        ],
                                    }),
                                    ...rows
                                ],
                            }),
                        ],
                    }],
                });
                Packer.toBlob(doc).then(blob => saveAs(blob, `${fileName}.docx`));
            } 
            
            else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text("Vocabulary List Export", 14, 15);
                
                doc.setFontSize(10);
                let currentY = 22;
                metadata.forEach(line => {
                    doc.text(line, 14, currentY);
                    currentY += 6;
                });
                const body = items.map(i => [i.en, i.de, i.fr]);
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['English', 'German', 'French']],
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 102, 204] }
                });
                doc.save(`${fileName}.pdf`);
            }
        }

        window.onload = () => { loadHistory();
        populateHeaderSelect(); ['pat', 'app', 'tit'].forEach(id => { document.getElementById('header-select').value = id; addMetaRow(); }); };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
    </script>
</body>
</html>
