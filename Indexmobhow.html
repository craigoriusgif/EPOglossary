<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EPOS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--primary-bg); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        #app-wrapper { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
            position: relative; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #main-section { flex: 2; padding: 15px; overflow: hidden; background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0; }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text); display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important; color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important; }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important; }

        .hidden { display: none !important; }

        .full-width #today-body, .full-width #pinned-body { display: table-row-group; columns: 1; }
        .full-width #today-body tr, .full-width #pinned-body tr { display: table-row; width: 100%; }

        @media only screen and (orientation: landscape) {
            .full-width #today-body, .full-width #pinned-body { display: block; columns: 2; column-gap: 30px; column-rule: 2px solid rgba(128,128,128,0.5); }
            .full-width #today-body tr, .full-width #pinned-body tr { display: flex; width: 100%; break-inside: avoid; border-bottom: 1px solid rgba(128,128,128,0.2); box-sizing: border-box; }
            .full-width #today-body td, .full-width #pinned-body td { flex: 1; padding: 10px 5px; min-width: 0; word-break: break-word; }
        }

        .side-pane { position: absolute; left: 0; top: 0; bottom: 0; width: 380px; background: white; z-index: 2000; box-shadow: 5px 0 15px rgba(0,0,0,0.15); transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding: 25px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); color: var(--text-main); }
        .side-pane.active { transform: translateX(0); }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none; font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .header-with-logo { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; gap: 8px; flex-shrink: 0; min-width: 0; }
        .header-center-filters { display: flex; flex-grow: 1; gap: 6px; align-items: center; min-width: 0; }
        
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; height: 16px; width: 16px; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E"); cursor: pointer; }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0; }
        
        .btn-ui { height: 40px; padding: 0 8px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500; }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important; }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px; font-size: 10px; margin-left: 4px; }

        /* Card View Styles from index37working3.html */
        #main-list.card-view .list-table thead { display: none; }
        #main-list.card-view .list-table tbody, #main-list.card-view .list-table tr, #main-list.card-view .list-table td { display: block; width: 100%; }
        #main-list.card-view .list-table tr { border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px; background: #fff; padding: 14px; cursor: pointer; }
        #main-list.card-view .list-table td { display: flex; justify-content: space-between; padding: 8px 0; border: none; }
        #main-list.card-view .list-table td::before { content: attr(data-label); font-weight: 700; color: #4b5563; font-size: 12px; text-transform: uppercase; margin-right: 10px; }
        #main-list.card-view .list-table tr.has-def td.col-en::after { content: " üí°"; }

        .list-table { width: 100%; border-collapse: collapse; background: white; }
        #today-section .list-table { background: transparent; color: inherit; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1); text-align: left; font-size: 13px; }
        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat { display: none !important; }

        .pane-controls { position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 20px; z-index: 3000; display: flex; gap: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid var(--border-color); align-items: center; transition: left 0.3s ease-in-out; }
        .pane-controls.shifted { left: 400px; }
        .toggle-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; }

        @media only screen and (max-width: 768px) {
            #main-list { padding: 0 5px; }
            .header-with-logo { flex-direction: column; align-items: stretch; gap: 10px; }
            .header-center-filters { flex-direction: column; align-items: stretch; }
            #master-search { width: 100%; margin-bottom: 8px; }
            .header-center-filters-row { display: flex; gap: 4px; width: 100%; }
            .pane-controls { bottom: calc(10px + env(safe-area-inset-bottom)); left: 10px; right: 10px; width: auto; justify-content: space-around; }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> and <strong>Today's Vocab</strong>. <strong>Card View</strong> is available for the Glossary to help on smaller screens.</p>
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
            </div>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPOS</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Tap to search terms..." onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="header-center-filters-row">
                        <button class="btn-ui" onclick="toggleViewMode()" id="view-mode-btn">üì± Card View</button>
                        <div class="dropdown-container" style="position:relative; flex: 1;">
                            <button class="btn-ui" onclick="toggleDrop('cat-drop', event)" style="width: 100%;">üè∑Ô∏è Cats <span id="cat-badge-val" class="badge-inline hidden">0</span></button>
                            <div id="cat-drop" class="dropdown-options" style="display: none; padding: 10px;">
                                <div id="master-cat-list"></div>
                            </div>
                        </div>
                        <button class="btn-ui btn-download" onclick="downloadMaster()" style="flex: 1;">üì• Download</button> 
                        <button class="btn-ui" onclick="togglePane('help-pane', true)" style="flex: 0.5;">‚ùì</button> 
                    </div>
                </div> 
            </div> 
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="today-list-container">
                 <h2 style="padding: 15px 0;">Today's Vocab</h2>
                 <div id="today-scroll-area"><table class="list-table"><tbody class="list" id="today-body"></tbody></table></div>
            </div>
        </section> 
    </div>

    <div class="pane-controls" id="pane-ctrls">
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="switchMainView('gl')">GLOSSARY</button>
        <button id="btn-cl" class="toggle-btn" onclick="switchMainView('cl')">TODAY</button>
        <button id="btn-split-view" class="toggle-btn" onclick="toggleSplit()">SPLIT</button>
    </div>

    <script>
        let masterList, todayList;
        let isCardView = false;

        function toggleViewMode() {
            isCardView = !isCardView;
            const listContainer = document.getElementById('main-list');
            const btn = document.getElementById('view-mode-btn');
            listContainer.classList.toggle('card-view', isCardView);
            btn.textContent = isCardView ? 'üìä Table View' : 'üì± Card View';
            masterList.update();
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    initMasterList(results.data);
                    document.getElementById('upload-screen').classList.add('hidden');
                    document.getElementById('app-wrapper').classList.remove('hidden');
                }
            });
        };

        function initMasterList(data) {
            const options = {
                valueNames: [
                    { name: 'en', attr: 'data-en' },
                    { name: 'de', attr: 'data-de' },
                    { name: 'fr', attr: 'data-fr' },
                    { name: 'cat', attr: 'data-cat' }
                ],
                item: (values) => `
                    <tr class="${values.def ? 'has-def' : ''}" onclick="showDetail('${values.en}', '${values.de}', '${values.fr}', '${values.cat}', '${values.def || ''}')">
                        <td class="en col-en" data-label="EN">${values.en}</td>
                        <td class="de col-de" data-label="DE">${values.de}</td>
                        <td class="fr col-fr" data-label="FR">${values.fr}</td>
                        <td class="cat col-cat" data-label="CAT">${values.cat}</td>
                    </tr>`
            };
            masterList = new List('main-list', options, data);
        }

        function showDetail(en, de, fr, cat, def) {
            document.getElementById('det-en').textContent = en;
            document.getElementById('det-de').textContent = de;
            document.getElementById('det-fr').textContent = fr;
            document.getElementById('det-cat').textContent = cat;
            document.getElementById('det-def').textContent = def || '-';
            togglePane('details-pane', true);
        }

        function togglePane(id, show) {
            document.getElementById(id).classList.toggle('active', show);
            document.getElementById('pane-ctrls').classList.toggle('shifted', show);
        }

        function switchMainView(v) {
            const main = document.getElementById('main-section');
            const today = document.getElementById('today-section');
            if (v === 'gl') { main.classList.remove('hidden'); today.classList.add('hidden'); }
            else { main.classList.add('hidden'); today.classList.remove('hidden'); }
        }

        function toggleSplit() {
            const today = document.getElementById('today-section');
            const main = document.getElementById('main-section');
            main.classList.remove('hidden');
            today.classList.remove('hidden');
        }

        function toggleDrop(id, e) {
            e.stopPropagation();
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        window.onclick = () => {
            document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        };
    </script>
</body>
</html>
