<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EPOS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--primary-bg); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        #app-wrapper { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
            position: relative; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #main-section { flex: 2; padding: 15px; overflow: hidden; background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0; }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text); display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important; color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important; }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important; }

        .hidden { display: none !important; }

        .full-width #today-body, .full-width #pinned-body { display: table-row-group; columns: 1; }
        .full-width #today-body tr, .full-width #pinned-body tr { display: table-row; width: 100%; }

        @media only screen and (orientation: landscape) {
            .full-width #today-body, .full-width #pinned-body { display: block; columns: 2; column-gap: 30px; column-rule: 2px solid rgba(128,128,128,0.5); }
            .full-width #today-body tr, .full-width #pinned-body tr { display: flex; width: 100%; break-inside: avoid; border-bottom: 1px solid rgba(128,128,128,0.2); box-sizing: border-box; }
            .full-width #today-body td, .full-width #pinned-body td { flex: 1; padding: 10px 5px; min-width: 0; word-break: break-word; }
        }

        .side-pane { position: absolute; left: 0; top: 0; bottom: 0; width: 380px; background: white; z-index: 2000; box-shadow: 5px 0 15px rgba(0,0,0,0.15); transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding: 25px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); color: var(--text-main); }
        .side-pane.active { transform: translateX(0); }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none; font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .header-with-logo { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; gap: 8px; flex-shrink: 0; min-width: 0; }
        .header-center-filters { display: flex; flex-grow: 1; gap: 6px; align-items: center; min-width: 0; }
        
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; height: 16px; width: 16px; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E"); cursor: pointer; }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0; }
        
        .btn-ui { height: 40px; padding: 0 8px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500; }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important; }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px; font-size: 10px; margin-left: 4px; }

        #today-list-container { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        .today-sticky-header { position: sticky; top: 0; z-index: 100; background: inherit; padding-bottom: 10px; }
        #today-scroll-area { overflow-y: auto; flex-grow: 1; }

        .today-header-container { margin-bottom: 15px; border-bottom: 1px solid rgba(128,128,128,0.3); padding-bottom: 10px; }
        .patent-info-table { width: 100%; font-size: 12px; border-collapse: collapse; background: rgba(0,0,0,0.1); }
        .patent-info-table td { padding: 6px 10px; border: 1px solid rgba(128,128,128,0.2); }
        .info-label { font-weight: bold; color: #3498db; width: 40%; }
        .input-inline-edit { background: transparent; border: none; color: inherit; width: 100%; font-size: 12px; outline: none; }

        .list-table { width: 100%; border-collapse: collapse; background: white; }
        #today-section .list-table { background: transparent; color: inherit; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1); text-align: left; font-size: 13px; }
        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat { display: none !important; }

        /* --- CARD VIEW STYLES (From index37working3) --- */
        #main-list.card-view .list-table thead { display: none; }
        #main-list.card-view .list-table tbody, 
        #main-list.card-view .list-table tr, 
        #main-list.card-view .list-table td { display: block; width: 100%; }
        #main-list.card-view .list-table tr { 
            border: 1px solid #e5e7eb; border-radius: 12px; 
            margin-bottom: 16px; background: #fff; padding: 14px; cursor: pointer; 
        }
        #main-list.card-view .list-table td { display: flex; justify-content: space-between; padding: 8px 0; border: none; }
        #main-list.card-view .list-table td::before { 
            content: attr(data-label); font-weight: 700; color: #4b5563; 
            font-size: 12px; text-transform: uppercase; 
        }
        #main-list.card-view .list-table tr.has-def td.col-en::after { content: " üí°"; color: var(--accent-blue); }

        .pane-controls { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 20px; 
            z-index: 3000; 
            display: flex; 
            gap: 10px; 
            background: rgba(255,255,255,0.95); 
            padding: 10px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            border: 1px solid var(--border-color); 
            align-items: center; 
            transition: left 0.3s ease-in-out; 
        }
        .pane-controls.shifted { left: 400px; }
        .toggle-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; }
        .btn-gl { background: #7f8c8d !important; color: white !important; }
        .btn-epc { background: #c0392b !important; color: white !important; }

        .recent-list { margin-top: 25px; text-align: left; }
        .recent-item { padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
        .recent-item:hover { background: #f9f9f9; }

        #drop-area.drag-over { border-color: var(--accent-blue) !important; background: rgba(0, 102, 204, 0.1) !important; }
        
        .inline-add-container { display: flex; gap: 4px; flex: 1; }
        .inline-add-container input { background: rgba(255,255,255,0.1); border: 1px solid rgba(128,128,128,0.3); color: inherit; padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; height: 40px; }
        
        .useful-links a { display: block; color: var(--accent-blue); text-decoration: none; margin-bottom: 8px; font-size: 13px; }
        .useful-links a:hover { text-decoration: underline; }

        #flashcard-container { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; min-height: 140px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(128,128,128,0.3); margin-bottom: 15px; cursor: pointer; }
        #flashcard-content { font-size: 18px; font-weight: bold; }
        #flashcard-lang { font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px; }
        .flash-lang-sel { background: rgba(0,0,0,0.2); color: inherit; border: 1px solid rgba(128,128,128,0.5); font-size: 10px; border-radius: 4px; padding: 2px; }

        @media only screen and (max-width: 768px) {
            #btn-split-view, #btn-gl, #btn-cl, #btn-epc, .pane-controls span { display: none !important; }
            .header-with-logo { flex-direction: column; align-items: stretch; gap: 10px; }
            .header-center-filters { flex-direction: column; align-items: stretch; }
            #master-search { width: 100%; margin-bottom: 8px; }
            .header-center-filters-row { display: flex; gap: 4px; width: 100%; }
            .inline-add-container { flex-direction: column; width: 100%; gap: 8px; }
            .inline-add-container input { width: 100%; }
            #inline-add-header { height: auto; padding-bottom: 10px; }
            .pane-controls { bottom: calc(10px + env(safe-area-inset-bottom)); left: 10px; right: 10px; width: auto; justify-content: space-around; }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> and <strong>Today's Vocab</strong>. <strong>Card View</strong> is available for the Glossary to help on smaller screens.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Tap the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Tap the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Tap rows with a <strong>light bulb</strong> to see more information.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology.</p>
            <p><strong>üìå Pinning:</strong> Tap terms in <strong>Today's Vocab</strong> list to keep terms visible at the top.</p>
            <p><strong>üé¥ Flashcards:</strong> Practice your vocab for today's OP.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://www.epo.org/en/legal/guidelines-epc/2025/index.html" target="_blank">Guidelines</a>
                <a href="https://www.epo.org/en/legal/case-law/2025/index.html" target="_blank">Case Law</a>
                <a href="https://www.epo.org/en/legal/epc/2020/convention.html" target="_blank">EPC</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPOS!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button.</li>
                    <li>Open your CSV file.</li>
                </ol>
            </div>
        </div>
    </div>
    
    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPOS</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently Used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Tap to search terms..." onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="header-center-filters-row">
                        <button class="btn-ui" onclick="toggleViewMode()" id="view-mode-btn">üì± Card View</button>

                        <div class="dropdown-container" style="position:relative; flex: 1;">
                            <button class="btn-ui" onclick="toggleDrop('cat-drop', event)" style="width: 100%;">üè∑Ô∏è Cats <span id="cat-badge-val" class="badge-inline hidden">0</span></button>
                            <div id="cat-reset-btn" class="hidden" style="position: absolute; top: -15px; right: 0; color:var(--accent-red); font-size: 10px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</div>
                            <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <div id="master-cat-list"></div>
                            </div>
                        </div>
                        <div class="dropdown-container" style="position:relative; flex: 1;">
                            <button class="btn-ui" onclick="toggleDrop('col-drop', event)" style="width: 100%;">‚ñ• Cols</button>
                            <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                                <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                            </div> 
                        </div> 
                        <button class="btn-ui" onclick="location.reload()" style="flex: 1;">üîÑ Load New</button> 
                        <button class="btn-ui btn-download" onclick="downloadMaster()" style="flex: 1;">üì• Download</button> 
                        <button class="btn-ui" onclick="togglePane('help-pane', true)" style="flex: 0.5;">‚ùì</button> 
                    </div>
                </div> 
            </div> 
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper" class="hidden"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                    <button onclick="togglePatentInfo()" class="btn-ui" style="height:30px; font-size:10px; padding:0 8px; background:rgba(255,255,255,0.1); color:inherit;">Hide ‚ñ¥</button> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 
            <div id="flashcard-ui" class="hidden"> 
                <div id="flashcard-container" onclick="flipFlashcard()"> 
                    <div id="flashcard-lang">---</div> 
                    <div id="flashcard-content">No terms loaded</div> 
                    <div style="position:absolute; bottom:10px; left:10px; font-size:10px; opacity:0.5;">Click to Flip</div> 
                    <div id="flash-count" style="position:absolute; bottom:10px; right:10px; font-size:10px; opacity:0.7;"></div> 
                </div> 
                <div style="display:flex; gap:10px; align-items:center;"> 
                    <div style="display:flex; align-items:center; gap:5px;"> 
                        <span style="font-size:12px; font-weight:bold;">Study:</span> 
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()"> 
                            <option value="en" selected>EN</option> 
                            <option value="de">DE</option> 
                            <option value="fr">FR</option> 
                        </select> 
                    </div> 
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button> 
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark Done ‚úÖ</button> 
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Next</button> 
                </div> 
                <div style="margin: 15px 0; border-top: 1px solid rgba(128,128,128,0.2);"></div> 
            </div> 
            <div id="today-list-container"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"> 
                        <h2 style="margin:0; font-size:18px;">Today's Vocab</h2> 
                        <div style="display:flex; gap:5px;"> 
                            <button class="btn-ui" onclick="toggleTheme()" style="background:rgba(255,255,255,0.1); color:inherit;">üåì Theme</button> 
                            <button class="btn-ui" onclick="toggleFullWidth()" style="background:rgba(255,255,255,0.1); color:inherit;">‚Üî Width</button> 
                        </div> 
                    </div> 
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;"> 
                        <div style="position:relative; flex:1;"> 
                            <button class="btn-ui" style="width:100%; background:var(--accent-blue); color:white; border:none;">üìÇ Load Vocab</button> 
                            <input type="file" id="today-file-input" accept=".csv,.docx" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;"> 
                        </div> 
                        <button class="btn-ui btn-download" onclick="exportToday()">üì§ Export</button> 
                    </div> 
                    <div id="inline-add-header" class="header-with-logo" style="border-bottom:none; padding-bottom:0;"> 
                        <div class="inline-add-container"> 
                            <input type="text" id="add-en" placeholder="English..."> 
                            <input type="text" id="add-de" placeholder="German..."> 
                            <input type="text" id="add-fr" placeholder="French..."> 
                            <button onclick="addEntry()" class="btn-ui" style="background:var(--accent-green); color:white; border:none; height:40px; padding:0 15px;">Add</button> 
                        </div> 
                    </div> 
                    <div style="margin-top:10px;"> 
                        <input type="search" id="today-search" class="input-today-header" style="width:100%; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.5);" placeholder="Search today's terms..."> 
                    </div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table"> 
                        <tbody class="list" id="pinned-body" style="border-bottom: 2px solid var(--accent-blue);"></tbody> 
                        <tbody class="list" id="today-body"></tbody> 
                    </table> 
                </div> 
            </div> 
        </section> 
    </div>

    <div class="pane-controls" id="pane-ctrls">
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="switchMainView('gl')">GLOSSARY</button>
        <button id="btn-cl" class="toggle-btn" onclick="switchMainView('cl')">TODAY</button>
        <button id="btn-split-view" class="toggle-btn" onclick="toggleSplit()">SPLIT</button>
        <button class="toggle-btn btn-epc" onclick="loadLegal('https://www.epo.org/en/legal/epc/2020/convention.html')">EPC</button>
        <button class="toggle-btn btn-epc" onclick="loadLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html')">GL</button>
        <button class="toggle-btn btn-epc" onclick="loadLegal('https://www.epo.org/en/legal/case-law/2025/index.html')">CL</button>
        <span style="font-size:10px; color:#666; margin-left:10px;">v25.12-Stable</span>
    </div>

    <script>
        let masterList, todayList;
        let recentFiles = [];
        let isCardView = false; // Flag for card view

        // Toggle View Mode (Integrated from index37working3)
        function toggleViewMode() {
            isCardView = !isCardView;
            const mainListDiv = document.getElementById('main-list');
            const viewBtn = document.getElementById('view-mode-btn');
            
            if (isCardView) {
                mainListDiv.classList.add('card-view');
                viewBtn.textContent = "üìä Table View";
            } else {
                mainListDiv.classList.remove('card-view');
                viewBtn.textContent = "üì± Card View";
            }
            // Trigger a list update to ensure proper rendering
            if (masterList) masterList.update();
        }

        const storageKey = 'epos_recent_glossaries';
        const loadHistory = () => {
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                recentFiles = JSON.parse(stored);
                renderRecent();
            }
        };

        const saveRecent = (name, data) => {
            recentFiles = [{ name, data, date: new Date().toLocaleDateString() }, ...recentFiles.filter(f => f.name !== name)].slice(0, 3);
            localStorage.setItem(storageKey, JSON.stringify(recentFiles));
            renderRecent();
        };

        const renderRecent = () => {
            const container = document.getElementById('recent-items');
            container.innerHTML = '';
            if (recentFiles.length > 0) {
                document.getElementById('recent-container').classList.remove('hidden');
                recentFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>${file.name}</span><span style="font-size:10px; color:#999">${file.date}</span>`;
                    div.onclick = () => { initMasterList(file.data); document.getElementById('upload-screen').classList.add('hidden'); document.getElementById('app-wrapper').classList.remove('hidden'); };
                    container.appendChild(div);
                });
            }
        };

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: (results) => {
                    const data = results.data.map(row => ({
                        en: row.EN || row.en || '',
                        de: row.DE || row.de || '',
                        fr: row.FR || row.fr || '',
                        cat: row.Category || row.cat || '',
                        def: row.Definition || row.def || ''
                    }));
                    saveRecent(file.name, data);
                    initMasterList(data);
                    document.getElementById('upload-screen').classList.add('hidden');
                    document.getElementById('app-wrapper').classList.remove('hidden');
                }
            });
        };

        function initMasterList(data) {
            const options = {
                valueNames: [
                    { name: 'en', attr: 'data-en' },
                    { name: 'de', attr: 'data-de' },
                    { name: 'fr', attr: 'data-fr' },
                    { name: 'cat', attr: 'data-cat' }
                ],
                // Updated item template to include data-labels for Card View
                item: (values) => `
                    <tr class="${values.def ? 'has-def' : ''}" onclick="showDetail('${values.en.replace(/'/g, "\\'")}', '${values.de.replace(/'/g, "\\'")}', '${values.fr.replace(/'/g, "\\'")}', '${values.cat.replace(/'/g, "\\'")}', '${(values.def || '').replace(/'/g, "\\'")}')">
                        <td class="en col-en" data-label="EN">${values.en}</td>
                        <td class="de col-de" data-label="DE">${values.de}</td>
                        <td class="fr col-fr" data-label="FR">${values.fr}</td>
                        <td class="cat col-cat" data-label="CAT">${values.cat}</td>
                    </tr>`
            };
            masterList = new List('main-list', options, data);
            populateCategories(data);
        }

        function populateCategories(data) {
            const cats = [...new Set(data.map(item => item.cat))].filter(Boolean).sort();
            const container = document.getElementById('master-cat-list');
            container.innerHTML = '';
            cats.forEach(cat => {
                const label = document.createElement('label');
                label.style = 'display:block; margin-bottom:8px; font-size:12px; cursor:pointer;';
                label.innerHTML = `<input type="checkbox" value="${cat}" onchange="filterMaster()"> ${cat}`;
                container.appendChild(label);
            });
        }

        function filterMaster() {
            const checked = Array.from(document.querySelectorAll('#master-cat-list input:checked')).map(i => i.value);
            document.getElementById('cat-badge-val').textContent = checked.length;
            document.getElementById('cat-badge-val').classList.toggle('hidden', checked.length === 0);
            document.getElementById('cat-reset-btn').classList.toggle('hidden', checked.length === 0);
            if (checked.length === 0) { masterList.filter(); }
            else { masterList.filter(item => checked.includes(item.values().cat)); }
        }

        function resetCategories() {
            document.querySelectorAll('#master-cat-list input').forEach(i => i.checked = false);
            filterMaster();
        }

        function toggleCol(col, show) {
            document.getElementById('main-list').classList.toggle(`hide-${col}`, !show);
        }

        function showDetail(en, de, fr, cat, def) {
            document.getElementById('det-en').textContent = en;
            document.getElementById('det-de').textContent = de;
            document.getElementById('det-fr').textContent = fr;
            document.getElementById('det-cat').textContent = cat;
            document.getElementById('det-def').textContent = def || '-';
            togglePane('details-pane', true);
        }

        function togglePane(id, show) {
            document.getElementById(id).classList.toggle('active', show);
            document.getElementById('pane-ctrls').classList.toggle('shifted', show);
        }

        function switchMainView(v) {
            const main = document.getElementById('main-section');
            const today = document.getElementById('today-section');
            const list = document.getElementById('main-list');
            const frame = document.getElementById('legal-iframe-container');
            const title = document.getElementById('main-title');

            if (v === 'gl') {
                main.classList.remove('hidden'); today.classList.add('hidden');
                list.classList.remove('hidden'); frame.classList.add('hidden');
                title.textContent = "Glossary";
            } else {
                main.classList.add('hidden'); today.classList.remove('hidden');
            }
        }

        function toggleSplit() {
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('today-section').classList.remove('hidden');
        }

        function loadLegal(url) {
            switchMainView('gl');
            document.getElementById('main-list').classList.add('hidden');
            document.getElementById('legal-iframe-container').classList.remove('hidden');
            document.getElementById('legal-frame').src = url;
            document.getElementById('main-title').textContent = url.includes('convention') ? "EPC" : url.includes('guidelines') ? "Guidelines" : "Case Law";
        }

        function toggleDrop(id, e) {
            e.stopPropagation();
            const el = document.getElementById(id);
            const isVisible = el.style.display === 'block';
            document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
            el.style.display = isVisible ? 'none' : 'block';
        }

        function downloadMaster() {
            const visible = masterList.visibleItems.map(i => i.values());
            const csv = Papa.unparse(visible.map(i => ({ EN: i.en, DE: i.de, FR: i.fr, Category: i.cat, Definition: i.def })));
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `EPOS_Export_${new Date().toISOString().slice(0,10)}.csv`);
        }

        // --- TODAY SECTION LOGIC ---
        let currentTheme = 'dark';
        const toggleTheme = () => {
            const ts = document.getElementById('today-section');
            if (currentTheme === 'dark') { ts.className = 'theme-light'; currentTheme = 'light'; }
            else if (currentTheme === 'light') { ts.className = 'theme-sepia'; currentTheme = 'sepia'; }
            else { ts.className = 'theme-dark'; currentTheme = 'dark'; }
        };

        const toggleFullWidth = () => document.getElementById('app-wrapper').classList.toggle('full-width');
        const togglePatentInfo = () => {
            const content = document.getElementById('patent-table-content');
            const btn = event.target;
            const isHidden = content.classList.toggle('hidden');
            btn.textContent = isHidden ? "Show ‚ñæ" : "Hide ‚ñ¥";
        };

        document.getElementById('today-file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    mammoth.convertToHtml({ arrayBuffer: event.target.result })
                        .then(result => {
                            const temp = document.createElement('div');
                            temp.innerHTML = result.value;
                            const rows = Array.from(temp.querySelectorAll('tr'));
                            if (rows.length > 1) {
                                const data = rows.slice(1).map(tr => {
                                    const tds = tr.querySelectorAll('td');
                                    return {
                                        en: tds[0]?.innerText?.trim() || '',
                                        de: tds[1]?.innerText?.trim() || '',
                                        fr: tds[2]?.innerText?.trim() || '',
                                        cat: tds[3]?.innerText?.trim() || '',
                                        def: tds[4]?.innerText?.trim() || '',
                                        pinned: false
                                    };
                                });
                                initTodayList(data);
                            }
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                Papa.parse(file, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const data = results.data.map(row => ({
                            en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                            cat: row.Category || row.cat || '', def: row.Definition || row.def || '', pinned: false
                        }));
                        initTodayList(data);
                    }
                });
            }
        };

        function initTodayList(data) {
            const options = {
                valueNames: ['en', 'de', 'fr', 'cat', 'def', { name: 'pinned', attr: 'data-pinned' }],
                item: (values) => `
                    <tr onclick="togglePin(this)">
                        <td class="en">${values.en}</td>
                        <td class="de">${values.de}</td>
                        <td class="fr">${values.fr}</td>
                    </tr>`
            };
            todayList = new List('today-list-container', options, data);
            document.getElementById('flashcard-ui').classList.remove('hidden');
            resetFlashcards();
        }

        function togglePin(rowEl) {
            const en = rowEl.querySelector('.en').textContent;
            const item = todayList.items.find(i => i.values().en === en);
            const vals = item.values();
            vals.pinned = !vals.pinned;
            item.values(vals);
            
            const pinnedBody = document.getElementById('pinned-body');
            const todayBody = document.getElementById('today-body');
            
            if (vals.pinned) {
                rowEl.style.background = 'rgba(255,255,0,0.1)';
                pinnedBody.appendChild(rowEl);
            } else {
                rowEl.style.background = 'transparent';
                todayBody.appendChild(rowEl);
            }
        }

        function addEntry() {
            const en = document.getElementById('add-en').value;
            const de = document.getElementById('add-de').value;
            const fr = document.getElementById('add-fr').value;
            if (!en) return;
            todayList.add({ en, de, fr, cat: '', def: '', pinned: false });
            document.getElementById('add-en').value = '';
            document.getElementById('add-de').value = '';
            document.getElementById('add-fr').value = '';
        }

        // Flashcard Logic
        let flashDeck = [];
        let flashIdx = 0;
        let isFlipped = false;

        function resetFlashcards() {
            flashDeck = [...todayList.items.map(i => i.values())];
            flashIdx = 0;
            isFlipped = false;
            showFlashcard();
        }

        function showFlashcard() {
            const container = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            const countLabel = document.getElementById('flash-count');
            
            if (flashDeck.length === 0) {
                container.textContent = "All Done! üéâ";
                langLabel.textContent = "---";
                countLabel.textContent = "";
                return;
            }

            const item = flashDeck[flashIdx];
            const sourceLang = document.getElementById('flash-source-lang').value;
            
            if (!isFlipped) {
                langLabel.textContent = sourceLang;
                container.textContent = item[sourceLang];
            } else {
                const targets = ['en', 'de', 'fr'].filter(l => l !== sourceLang);
                langLabel.textContent = targets.join(' / ');
                container.textContent = targets.map(l => item[l]).join(' | ');
            }
            countLabel.textContent = `${flashIdx + 1} / ${flashDeck.length}`;
        }

        function flipFlashcard() { isFlipped = !isFlipped; showFlashcard(); }
        function nextFlashcard() { isFlipped = false; flashIdx = (flashIdx + 1) % flashDeck.length; showFlashcard(); }
        function prevFlashcard() { isFlipped = false; flashIdx = (flashIdx - 1 + flashDeck.length) % flashDeck.length; showFlashcard(); }
        function markFlashcardDone() {
            flashDeck.splice(flashIdx, 1);
            if (flashIdx >= flashDeck.length) flashIdx = 0;
            isFlipped = false;
            showFlashcard();
        }

        // Export/Metadata Logic
        const metadataKeys = [
            { id: 'pat', label: 'Patent No.' }, { id: 'app', label: 'Applicant' },
            { id: 'tit', label: 'Title' }, { id: 'opp', label: 'Opponent' },
            { id: 'date', label: 'Date' }, { id: 'div', label: 'Division' }
        ];

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            metadataKeys.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k.id; opt.textContent = k.label;
                sel.appendChild(opt);
            });
        }

        function addMetaRow() {
            const sel = document.getElementById('header-select');
            const key = sel.value;
            const label = metadataKeys.find(k => k.id === key).label;
            const table = document.getElementById('meta-table-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="info-label">${label}</td><td><input type="text" class="input-inline-edit" placeholder="..."></td>`;
            table.appendChild(tr);
        }

        async function exportToday() {
            const items = todayList.items.map(i => i.values());
            const metadata = Array.from(document.querySelectorAll('#meta-table-body tr')).map(tr => {
                return `${tr.querySelector('.info-label').textContent}: ${tr.querySelector('input').value}`;
            });

            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel } = window.docx;
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "Vocabulary List", heading: HeadingLevel.HEADING_1 }),
                        ...metadata.map(m => new Paragraph({ text: m })),
                        new Paragraph({ text: "" }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph("English")] }),
                                        new TableCell({ children: [new Paragraph("German")] }),
                                        new TableCell({ children: [new Paragraph("French")] })
                                    ]
                                }),
                                ...items.map(i => new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph(i.en)] }),
                                        new TableCell({ children: [new Paragraph(i.de)] }),
                                        new TableCell({ children: [new Paragraph(i.fr)] })
                                    ]
                                }))
                            ]
                        })
                    ]
                }]
            });

            const blob = await Packer.toBlob(doc);
            saveAs(blob, "Today_Vocab_Export.docx");
        }

        window.onload = () => { 
            loadHistory(); 
            populateHeaderSelect(); 
            ['pat', 'app', 'tit'].forEach(id => { 
                document.getElementById('header-select').value = id; 
                addMetaRow(); 
            }); 
        };

        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value, ['en', 'de', 'fr']);
    </script>
</body>
</html>
