<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EPOS - Enhanced Glossary</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --text-main: #1c1e21;
            --text-muted: #65676b;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--primary-bg);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
        }

        #app-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
            transition: opacity 0.3s ease;
        }

        /* Master Section Styles */
        #main-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            position: relative;
        }

        /* Today Section Styles */
        #today-section {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            background: var(--today-bg);
            color: var(--today-text);
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .header-bar {
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .today-header {
            padding: 16px 20px;
            background: #1e272e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Draggable Table Styles */
        .list-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .list-table th {
            text-align: left;
            padding: 12px 15px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8f9fa;
            border-bottom: 2px solid var(--border-color);
            cursor: grab;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }

        .list-table th:active { cursor: grabbing; }

        #today-section .list-table th {
            background: #3d3d3d;
            color: #fff;
            border-bottom: 2px solid #555;
        }

        .dragging { opacity: 0.4; background: #e0e0e0 !important; }
        .drag-over { border-left: 3px solid var(--accent-blue) !important; }

        .list-table td {
            padding: 14px 15px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
            word-wrap: break-word;
            vertical-align: top;
        }

        #today-section .list-table td {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* Row Hover Effects */
        tbody tr:hover { background: #f1f8ff; cursor: pointer; }
        #today-section tbody tr:hover { background: rgba(255,255,255,0.05); }

        /* Search & Controls */
        .search-container { position: relative; flex-grow: 1; max-width: 400px; margin: 0 15px; }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            outline: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }

        /* Utility Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; }
        .btn-ghost { background: transparent; color: white; border: 1px solid rgba(255,255,255,0.2); }

        /* Scrollable Areas */
        .scroll-area { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }

        /* Modal/Overlay for initial upload */
        #upload-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .hidden { display: none !important; }

        /* Meta Data Table - Original Functionality */
        .meta-container { padding: 10px 20px; background: #fafafa; border-bottom: 1px solid #eee; }
        .meta-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .meta-row input { flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Drop zone for Today Mode */
        #today-drop-zone {
            margin: 15px;
            padding: 20px;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: #aaa;
        }
        #today-drop-zone:hover { border-color: var(--accent-green); color: white; }

    </style>
</head>
<body>

    <div id="upload-overlay">
        <div class="upload-card">
            <h1 style="color:var(--accent-blue); font-size: 42px; margin-bottom: 10px;">EPOS</h1>
            <p style="color:var(--text-muted); margin-bottom: 30px;">Load the master EPO Glossary (CSV) to begin.</p>
            <input type="file" id="master-csv-input" accept=".csv" class="hidden">
            <button class="btn btn-primary" onclick="document.getElementById('master-csv-input').click()" style="width: 100%; justify-content: center; padding: 15px;">
                Choose Master CSV File
            </button>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <header class="header-bar">
                <h2 style="margin:0; font-size: 18px;">EPO Glossary</h2>
                <div class="search-container">
                    <input type="text" id="master-search" class="search-input" placeholder="Search across all columns...">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="exportData('csv')">CSV</button>
                    <button class="btn btn-outline" onclick="exportData('pdf')">PDF</button>
                </div>
            </header>

            <div class="meta-container" id="meta-data-fields">
                </div>

            <div class="scroll-area" id="master-list-container">
                <table class="list-table" id="master-table">
                    <thead>
                        <tr id="master-header-row">
                            <th class="en" draggable="true">English</th>
                            <th class="de" draggable="true">German</th>
                            <th class="fr" draggable="true">French</th>
                            <th class="cat" draggable="true">Category</th>
                        </tr>
                    </thead>
                    <tbody class="list" id="master-body">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="today-section">
            <header class="today-header">
                <h2 style="margin:0; font-size: 18px;">Today Mode</h2>
                <div style="display:flex; gap: 8px;">
                    <button class="btn btn-ghost" id="today-search-btn">üîç</button>
                    <button class="btn btn-ghost" onclick="clearToday()">Clear</button>
                </div>
            </header>

            <div id="today-search-bar" class="hidden" style="padding:10px 20px;">
                <input type="text" id="today-search" class="search-input" placeholder="Search today's list..." style="background: #444; color: white; border: none;">
            </div>

            <div id="today-drop-zone">
                <p>Drop file or tap to load<br><small>Supports .csv, .docx</small></p>
                <input type="file" id="today-file-input" accept=".csv,.docx" class="hidden">
            </div>

            <div class="scroll-area" id="today-list-container">
                <table class="list-table" id="today-table">
                    <thead>
                        <tr id="today-header-row">
                            <th class="en" draggable="true">English</th>
                            <th class="de" draggable="true">German</th>
                            <th class="fr" draggable="true">French</th>
                        </tr>
                    </thead>
                    <tbody class="list" id="today-body">
                        </tbody>
                </table>
            </div>

            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-primary" style="width:100%; justify-content: center; background: var(--accent-green);" onclick="generateSessionPDF()">
                    Export Session Summary (PDF)
                </button>
            </div>
        </section>
    </div>

    <script>
        /**
         * GLOBAL STATE & CONFIG
         */
        let masterList = null;
        let todayList = null;
        let dragSrcEl = null;

        const MASTER_OPTIONS = {
            valueNames: [
                { name: 'en', target: 'td.en' },
                { name: 'de', target: 'td.de' },
                { name: 'fr', target: 'td.fr' },
                { name: 'cat', target: 'td.cat' }
            ],
            item: `<tr>
                    <td class="en"></td>
                    <td class="de"></td>
                    <td class="fr"></td>
                    <td class="cat"></td>
                   </tr>`
        };

        const TODAY_OPTIONS = {
            valueNames: ['en', 'de', 'fr'],
            item: `<tr><td class="en"></td><td class="de"></td><td class="fr"></td></tr>`
        };

        /**
         * INITIALIZATION
         */
        document.getElementById('master-csv-input').addEventListener('change', handleMasterUpload);
        document.getElementById('today-file-input').addEventListener('change', handleTodayUpload);
        document.getElementById('today-drop-zone').onclick = () => document.getElementById('today-file-input').click();
        document.getElementById('today-search-btn').onclick = () => document.getElementById('today-search-bar').classList.toggle('hidden');

        function handleMasterUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    initMasterApp(results.data);
                }
            });
        }

        function initMasterApp(data) {
            document.getElementById('upload-overlay').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');

            // Format data to match our valueNames
            const formattedData = data.map(row => ({
                en: row.English || row.EN || '',
                de: row.German || row.DE || '',
                fr: row.French || row.FR || '',
                cat: row.Category || ''
            }));

            masterList = new List('main-section', MASTER_OPTIONS, formattedData);
            initDraggableColumns('master-header-row', 'master-table');
            addMetaRow("Patent No");
            addMetaRow("Applicant");
        }

        /**
         * DRAG AND DROP LOGIC (COLUMN REARRANGING)
         */
        function initDraggableColumns(rowId, tableId) {
            const row = document.getElementById(rowId);
            const headers = row.querySelectorAll('th');

            headers.forEach(header => {
                header.addEventListener('dragstart', handleDragStart, false);
                header.addEventListener('dragenter', handleDragEnter, false);
                header.addEventListener('dragover', handleDragOver, false);
                header.addEventListener('dragleave', handleDragLeave, false);
                header.addEventListener('drop', (e) => handleDrop(e, tableId), false);
                header.addEventListener('dragend', handleDragEnd, false);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e, tableId) {
            if (e.stopPropagation) e.stopPropagation();

            if (dragSrcEl !== this) {
                const row = dragSrcEl.parentNode;
                const children = Array.from(row.children);
                const fromIdx = children.indexOf(dragSrcEl);
                const toIdx = children.indexOf(this);

                // Move Header
                if (fromIdx < toIdx) {
                    this.after(dragSrcEl);
                } else {
                    this.before(dragSrcEl);
                }

                // Move all data columns in the body
                reorderTableColumns(tableId, fromIdx, toIdx);
            }
            return false;
        }

        function handleDragEnd(e) {
            const ths = document.querySelectorAll('th');
            ths.forEach(th => {
                th.classList.remove('dragging');
                th.classList.remove('drag-over');
            });
        }

        function reorderTableColumns(tableId, fromIdx, toIdx) {
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach(tr => {
                const cells = Array.from(tr.children);
                const fromCell = cells[fromIdx];
                const toCell = cells[toIdx];

                if (fromIdx < toIdx) {
                    toCell.after(fromCell);
                } else {
                    toCell.before(fromCell);
                }
            });
        }

        /**
         * TODAY MODE LOGIC
         */
        async function handleTodayUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    complete: (results) => renderTodayList(results.data)
                });
            } else if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer });
                parseTodayHtml(result.value);
            }
        }

        function renderTodayList(data) {
            const formatted = data.map(row => ({
                en: row.English || row.EN || '',
                de: row.German || row.DE || '',
                fr: row.French || row.FR || ''
            }));

            if (todayList) {
                todayList.clear();
                todayList.add(formatted);
            } else {
                todayList = new List('today-section', TODAY_OPTIONS, formatted);
                initDraggableColumns('today-header-row', 'today-table');
            }
            document.getElementById('today-drop-zone').classList.add('hidden');
        }

        function parseTodayHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('tr'));
            
            const data = rows.map(tr => {
                const tds = tr.querySelectorAll('td');
                if (tds.length >= 3) {
                    return {
                        en: tds[0].innerText.trim(),
                        de: tds[1].innerText.trim(),
                        fr: tds[2].innerText.trim()
                    };
                }
                return null;
            }).filter(x => x);

            renderTodayList(data);
        }

        function clearToday() {
            if (todayList) todayList.clear();
            document.getElementById('today-drop-zone').classList.remove('hidden');
        }

        /**
         * METADATA FUNCTIONS
         */
        function addMetaRow(label = "") {
            const container = document.getElementById('meta-data-fields');
            const div = document.createElement('div');
            div.className = 'meta-row';
            div.innerHTML = `
                <input type="text" placeholder="Field (e.g. Patent No)" value="${label}">
                <input type="text" placeholder="Value">
                <button onclick="this.parentElement.remove()" style="border:none; background:none; cursor:pointer;">‚úï</button>
            `;
            container.appendChild(div);
        }

        /**
         * EXPORT LOGIC
         */
        function exportData(format) {
            const data = masterList.items.map(item => item.values());
            const meta = Array.from(document.querySelectorAll('.meta-row')).map(row => {
                const inputs = row.querySelectorAll('input');
                return `${inputs[0].value}: ${inputs[1].value}`;
            });

            if (format === 'csv') {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, "EPO_Export.csv");
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("EPO Glossary Export", 14, 15);
                
                let y = 25;
                meta.forEach(m => {
                    doc.setFontSize(10);
                    doc.text(m, 14, y);
                    y += 7;
                });

                doc.autoTable({
                    startY: y + 5,
                    head: [['English', 'German', 'French', 'Category']],
                    body: data.map(d => [d.en, d.de, d.fr, d.cat])
                });
                doc.save("EPO_Export.pdf");
            }
        }

        function generateSessionPDF() {
            if (!todayList || todayList.items.length === 0) return alert("Today list is empty.");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Today's Vocabulary Session", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);

            const body = todayList.items.map(i => [i.values().en, i.values().de, i.values().fr]);
            
            doc.autoTable({
                startY: 35,
                head: [['English', 'German', 'French']],
                body: body,
                headStyles: { fillColor: [40, 167, 69] }
            });

            doc.save(`Session_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        /**
         * SEARCH BINDING
         */
        document.getElementById('master-search').oninput = (e) => {
            if (masterList) masterList.search(e.target.value);
        };
        document.getElementById('today-search').oninput = (e) => {
            if (todayList) todayList.search(e.target.value);
        };

    </script>
</body>
</html>
