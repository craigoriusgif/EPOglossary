<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPO Interpreter Dashboard</title>
    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
}
</script>
    
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background-color: var(--primary-bg); color: var(--text-main); height: 100vh; overflow: hidden; }

        #app-wrapper { display: flex; height: 100vh; width: 100vw; position: relative; }
        #main-section { flex: 2; padding: 15px; overflow: hidden; background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0; }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text); display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important; color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important; }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important; }

        .hidden { display: none !important; }
        .full-width { flex: 1 0 100% !important; border: none !important; }
        
        /* RESTORED SPLIT VIEW CSS */
        #app-wrapper.split-view #main-section,
        #app-wrapper.split-view #today-section {
            display: flex !important;
            flex: 1 !important;
        }
        #app-wrapper.split-view #main-section { border-right: 2px solid var(--border-color); }

        .side-pane { 
            position: absolute;
            left: 0; top: 0; bottom: 0; 
            width: 380px; background: white; z-index: 2000; 
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            padding: 25px; display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .side-pane.active { transform: translateX(0); }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none; font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .header-with-logo { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; gap: 8px; flex-shrink: 0; min-width: 0; }
        .header-center-filters { display: flex; flex-grow: 1; gap: 6px; align-items: center; min-width: 0; }
        
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
            cursor: pointer;
        }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0; }
        
        .btn-ui { height: 40px; padding: 0 8px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500; }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important; }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px; font-size: 10px; margin-left: 4px; }

        #today-list-container { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        .today-sticky-header { position: sticky; top: 0; z-index: 100; background: inherit; padding-bottom: 10px; }
        #today-scroll-area { overflow-y: auto; flex-grow: 1; }

        .full-width #today-body, .full-width #pinned-body { display: block; columns: 2; column-gap: 50px; column-rule: 2px solid rgba(128,128,128,0.5); }
        .full-width #today-body tr, .full-width #pinned-body tr { display: flex; width: 100%; break-inside: avoid; border-bottom: 1px solid rgba(128,128,128,0.2); }
        .full-width #today-body td, .full-width #pinned-body td { flex: 1; padding: 10px 5px; }

        .today-header-container { margin-bottom: 15px; border-bottom: 1px solid rgba(128,128,128,0.3); padding-bottom: 10px; }
        .patent-info-table { width: 100%; font-size: 12px; border-collapse: collapse; background: rgba(0,0,0,0.1); }
        .patent-info-table td { padding: 6px 10px; border: 1px solid rgba(128,128,128,0.2); }
        .info-label { font-weight: bold; color: #3498db; width: 40%; }
        .input-inline-edit { background: transparent; border: none; color: inherit; width: 100%; font-size: 12px; outline: none; }

        .list-table { width: 100%; border-collapse: collapse; background: white; }
        #today-section .list-table { background: transparent; color: inherit; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1); text-align: left; font-size: 13px; }
        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat { display: none !important; }

        .pane-controls { position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: flex; gap: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border-color); align-items: center; transition: left 0.3s ease-in-out; }
        .pane-controls.shifted { left: 400px; }
        
        .toggle-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; }
        .toggle-btn.active { box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); background: #eee; border-color: #bbb; }
        .toggle-btn:not(.active) { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .btn-gl { background: #7f8c8d !important; color: white !important; }
        .btn-cl { background: #2d3436 !important; color: white !important; }
        .btn-epc { background: #c0392b !important; color: white !important; }
        
        .theme-circle { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; cursor: pointer; transition: transform 0.1s; }
        .theme-circle:hover { transform: scale(1.1); }

        .recent-list { margin-top: 25px; text-align: left; }
        .recent-item { padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
        .recent-item:hover { background: #f9f9f9; }

        #drop-area.drag-over { border-color: var(--accent-blue) !important; background: rgba(0, 102, 204, 0.1) !important; }
        
        .inline-add-container { display: flex; gap: 4px; flex: 1; }
        .inline-add-container input { background: rgba(255,255,255,0.1); border: 1px solid rgba(128,128,128,0.3); color: inherit; padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; height: 40px; }
        
        .useful-links a { display: block; color: var(--accent-blue); text-decoration: none; margin-bottom: 8px; font-size: 13px; }
        .useful-links a:hover { text-decoration: underline; }

        /* Flashcard Styles */
        #flashcard-container { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; min-height: 140px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(128,128,128,0.3); margin-bottom: 15px; cursor: pointer; }
        #flashcard-content { font-size: 18px; font-weight: bold; }
        #flashcard-lang { font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px; }
        .flash-lang-sel { background: rgba(0,0,0,0.2); color: inherit; border: 1px solid rgba(128,128,128,0.5); font-size: 10px; border-radius: 4px; padding: 2px; }

        /* Mobile specific hiding logic */
        @media only screen and (max-width: 768px) {
            #btn-split-view, #btn-gl, #btn-cl, #btn-epc, .pane-controls span {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view. <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Tap the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Tap the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Tap rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g. <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Tap terms in <strong>Today's vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary). The button appears once you load today's vocab. Tap the card to flip and test yourself. Mark done to remove the card from the deck. Tap the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPO Interpreter Dashboard!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To prepare and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
            <p>Then switch to the <strong>Today's vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
            <p>Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            <p>The Language Service has provided a template for you to use.</p>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPO Interpreter Dashboard</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO Glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">‚ùì Getting started</button>
        <div id="recent-container" class="recent-list"></div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Search Glossary..." style="flex-grow:2;">
                    <div style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('drop-cat', event)">Categories</button>
                        <div id="drop-cat" class="dropdown-options" style="display:none; position:absolute; top:45px; right:0; background:white; border:1px solid #ddd; border-radius:8px; z-index:1001; min-width:180px; box-shadow:0 4px 12px rgba(0,0,0,0.15); max-height:300px; overflow-y:auto; padding:10px;"></div>
                    </div>
                    <div style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('drop-cols', event)">Columns</button>
                        <div id="drop-cols" class="dropdown-options" style="display:none; position:absolute; top:45px; right:0; background:white; border:1px solid #ddd; border-radius:8px; z-index:1001; min-width:150px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:10px;">
                            <label style="display:block; margin:8px 0;"><input type="checkbox" checked onchange="toggleCol('en')"> English</label>
                            <label style="display:block; margin:8px 0;"><input type="checkbox" checked onchange="toggleCol('de')"> German</label>
                            <label style="display:block; margin:8px 0;"><input type="checkbox" checked onchange="toggleCol('fr')"> French</label>
                            <label style="display:block; margin:8px 0;"><input type="checkbox" checked onchange="toggleCol('cat')"> Category</label>
                        </div>
                    </div>
                    <button class="btn-ui btn-download" onclick="downloadMaster()">Download <span id="master-count" class="badge-inline">0</span></button>
                </div>
            </div>
            <div style="flex-grow:1; overflow-y:auto; border-radius:8px;">
                <table id="main-list" class="list-table">
                    <thead><tr><th class="col-en">EN</th><th class="col-de">DE</th><th class="col-fr">FR</th><th class="col-cat">Category</th><th style="width:40px;"></th></tr></thead>
                    <tbody class="list"></tbody>
                </table>
            </div>
        </section>

        <section id="today-section" class="hidden">
            <div id="today-list-container">
                <div class="today-sticky-header">
                    <div class="header-with-logo" style="border-bottom:1px solid rgba(128,128,128,0.3);">
                        <div class="header-center-filters">
                            <input type="search" id="today-search" class="input-today-header" placeholder="Filter today's vocab..." style="flex:1;">
                            <button id="flashcard-toggle" class="btn-ui" style="display:none;" onclick="toggleFlashcards()">üé¥ Practice</button>
                            <button class="btn-ui btn-download" onclick="downloadToday()">Export</button>
                            <div style="display:flex; gap:8px; align-items:center; margin-left:10px;">
                                <div class="theme-circle" style="background:#ffffff;" onclick="setTheme('light')"></div>
                                <div class="theme-circle" style="background:#2d3436;" onclick="setTheme('dark')"></div>
                                <div class="theme-circle" style="background:#f4ecd8;" onclick="setTheme('sepia')"></div>
                            </div>
                        </div>
                    </div>

                    <div id="flash-area" class="hidden">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <select id="flash-source-lang" class="flash-lang-sel" onchange="initFlashcards()">
                                <option value="en">Source: EN</option>
                                <option value="de">Source: DE</option>
                                <option value="fr">Source: FR</option>
                            </select>
                            <span id="flash-stats" style="font-size:10px; opacity:0.7;"></span>
                            <button class="btn-ui" style="height:24px; padding:0 10px;" onclick="toggleFlashcards()">Close</button>
                        </div>
                        <div id="flashcard-container" onclick="flipCard()">
                            <div id="flashcard-lang"></div>
                            <div id="flashcard-content">Load a list to start</div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-ui" style="flex:1; background:var(--accent-green); color:white; border:none;" onclick="markFlashDone(event)">Mark Done</button>
                            <button class="btn-ui" style="flex:1;" onclick="nextCard(event)">Next Card</button>
                        </div>
                    </div>

                    <div class="today-header-container">
                        <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                            <div id="drop-area" style="flex:1; border: 2px dashed rgba(128,128,128,0.5); border-radius:12px; height:60px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:13px; transition:0.2s;">
                                üìÇ Drag & Drop Vocab (.csv / .docx)
                                <input type="file" id="today-file-input" accept=".csv,.docx" style="display:none;">
                            </div>
                            <button class="btn-ui" onclick="togglePane('help-pane', true)">Help</button>
                        </div>
                        <table class="patent-info-table" id="metadata-table"></table>
                    </div>
                    
                    <div style="margin-bottom:15px; display:flex; gap:10px;">
                        <div class="inline-add-container">
                            <input type="text" id="add-en" placeholder="EN">
                            <input type="text" id="add-de" placeholder="DE">
                            <input type="text" id="add-fr" placeholder="FR">
                            <button class="btn-ui" onclick="addTodayTerm()" style="background:var(--accent-blue); color:white; border:none; width:40px;">+</button>
                        </div>
                    </div>
                </div>

                <div id="today-scroll-area">
                    <table class="list-table">
                        <tbody id="pinned-body" style="background:rgba(255,255,255,0.05);"></tbody>
                        <tbody id="today-body" class="list"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div class="pane-controls">
        <span>VIEW:</span>
        <button id="btn-view-main" class="toggle-btn active" onclick="switchView('main')">EPO Glossary</button>
        <button id="btn-view-today" class="toggle-btn" onclick="switchView('today')">Today's vocab</button>
        <button id="btn-split-view" class="toggle-btn" onclick="toggleSplitView()">Split View</button>
        <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="toggleDrop('drop-gl', event)">GL ‚ñæ</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="toggleDrop('drop-cl', event)">Case Law ‚ñæ</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="toggleDrop('drop-epc', event)">EPC ‚ñæ</button>
    </div>

    <div id="drop-gl" class="dropdown-options" style="display:none; position:fixed; bottom:65px; left:330px; background:white; border:1px solid #ddd; border-radius:12px; z-index:3001; min-width:200px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:10px;"></div>
    <div id="drop-cl" class="dropdown-options" style="display:none; position:fixed; bottom:65px; left:390px; background:white; border:1px solid #ddd; border-radius:12px; z-index:3001; min-width:200px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:10px;"></div>
    <div id="drop-epc" class="dropdown-options" style="display:none; position:fixed; bottom:65px; left:480px; background:white; border:1px solid #ddd; border-radius:12px; z-index:3001; min-width:200px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:10px;"></div>

    <script>
        let masterList, todayList, currentView = 'main';
        let pinnedItems = new Set();
        let flashcards = [], currentFlashIdx = 0, flashFlipped = false;

        const GL_LINKS = [
            { t: "GL (Full)", u: "https://www.epo.org/en/legal/guidelines-epc" },
            { t: "Part A - Formalities", u: "https://www.epo.org/en/legal/guidelines-epc/2024/a_i.html" },
            { t: "Part B - Search", u: "https://www.epo.org/en/legal/guidelines-epc/2024/b_i.html" },
            { t: "Part C - Substantive Exam", u: "https://www.epo.org/en/legal/guidelines-epc/2024/c_i.html" },
            { t: "Part D - Opposition", u: "https://www.epo.org/en/legal/guidelines-epc/2024/d_i.html" },
            { t: "Part E - General Matters", u: "https://www.epo.org/en/legal/guidelines-epc/2024/e_i.html" },
            { t: "Part F - Application", u: "https://www.epo.org/en/legal/guidelines-epc/2024/f_i.html" },
            { t: "Part G - Patentability", u: "https://www.epo.org/en/legal/guidelines-epc/2024/g_i.html" },
            { t: "Part H - Amendments", u: "https://www.epo.org/en/legal/guidelines-epc/2024/h_i.html" }
        ];
        const CL_LINKS = [
            { t: "Case Law (Full)", u: "https://www.epo.org/en/legal/case-law/2022" },
            { t: "I. Patentability", u: "https://www.epo.org/en/legal/case-law/2022/clr_i.html" },
            { t: "II. Application", u: "https://www.epo.org/en/legal/case-law/2022/clr_ii.html" },
            { t: "III. Procedure", u: "https://www.epo.org/en/legal/case-law/2022/clr_iii.html" },
            { t: "IV. Proceedings (Dept)", u: "https://www.epo.org/en/legal/case-law/2022/clr_iv.html" },
            { t: "V. Appeals", u: "https://www.epo.org/en/legal/case-law/2022/clr_v.html" },
            { t: "VI. Boards", u: "https://www.epo.org/en/legal/case-law/2022/clr_vi.html" }
        ];
        const EPC_LINKS = [
            { t: "EPC Articles", u: "https://www.epo.org/en/legal/epc/2020/ma1.html" },
            { t: "EPC Rules", u: "https://www.epo.org/en/legal/epc/2020/ma2.html" },
            { t: "Cross-Reference Table", u: "https://www.epo.org/en/legal/epc/2020/ma3.html" }
        ];

        function initGLButtons() {
            const fill = (id, list) => {
                const el = document.getElementById(id);
                el.innerHTML = list.map(link => `<a href="${link.u}" target="_blank" style="display:block; padding:10px; color:var(--text-main); text-decoration:none; font-size:12px; border-bottom:1px solid #eee;">${link.t}</a>`).join('');
                el.querySelectorAll('a').forEach(a => {
                    a.onclick = (e) => {
                        const btn = document.getElementById('btn-' + id.split('-')[1]);
                        const baseText = id.includes('gl') ? 'GL' : (id.includes('cl') ? 'Case Law' : 'EPC');
                        btn.textContent = baseText + ' : ' + e.target.textContent + ' ‚ñæ';
                        el.style.display = 'none';
                    };
                });
            };
            fill('drop-gl', GL_LINKS); fill('drop-cl', CL_LINKS); fill('drop-epc', EPC_LINKS);
        }

        function togglePane(id, show) {
            document.getElementById(id).classList.toggle('active', show);
            document.querySelector('.pane-controls').classList.toggle('shifted', show && window.innerWidth > 800);
        }

        function switchView(view) {
            currentView = view;
            const m = document.getElementById('main-section');
            const t = document.getElementById('today-section');
            const w = document.getElementById('app-wrapper');
            const bM = document.getElementById('btn-view-main');
            const bT = document.getElementById('btn-view-today');
            const bS = document.getElementById('btn-split-view');

            w.classList.remove('split-view');
            bS.classList.remove('active');
            
            if (view === 'main') {
                m.classList.remove('hidden'); m.classList.add('full-width');
                t.classList.add('hidden');
                bM.classList.add('active'); bT.classList.remove('active');
            } else {
                t.classList.remove('hidden'); t.classList.add('full-width');
                m.classList.add('hidden');
                bT.classList.add('active'); bM.classList.remove('active');
            }
        }

        /* RESTORED SPLIT VIEW FUNCTION */
        function toggleSplitView() {
            const wrapper = document.getElementById('app-wrapper');
            const main = document.getElementById('main-section');
            const today = document.getElementById('today-section');
            const btn = document.getElementById('btn-split-view');

            const isSplit = wrapper.classList.toggle('split-view');
            
            if (isSplit) {
                main.classList.remove('hidden', 'full-width');
                today.classList.remove('hidden', 'full-width');
                btn.classList.add('active');
                document.getElementById('btn-view-main').classList.remove('active');
                document.getElementById('btn-view-today').classList.remove('active');
            } else {
                switchView(currentView);
            }
        }

        function toggleCol(c) { document.getElementById('main-list').classList.toggle('hide-' + c); }

        function loadMaster(data) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            masterList = new List('main-section', {
                valueNames: ['col-en', 'col-de', 'col-fr', 'col-cat', { name: 'def', attr: 'data-def' }],
                item: '<tr><td class="col-en"></td><td class="col-de"></td><td class="col-fr"></td><td class="col-cat"></td><td><button class="btn-ui" style="border:none; background:none; font-size:16px;" onclick="showDetail(this)">üí°</button></td></tr>'
            }, data.map(r => ({ 'col-en': r.EN, 'col-de': r.DE, 'col-fr': r.FR, 'col-cat': r.Category, 'def': r.Definition })));
            
            const cats = [...new Set(data.map(r => r.Category))].filter(Boolean).sort();
            document.getElementById('drop-cat').innerHTML = `<label style="display:block; margin:8px 0;"><input type="checkbox" checked onchange="filterCat()"> (All)</label>` + 
                cats.map(c => `<label style="display:block; margin:8px 0;"><input type="checkbox" checked value="${c}" onchange="filterCat()"> ${c}</label>`).join('');
            
            document.getElementById('master-count').textContent = data.length;
            initGLButtons();
        }

        function filterCat() {
            const checked = Array.from(document.querySelectorAll('#drop-cat input:checked')).map(i => i.value);
            masterList.filter(item => checked.includes(item.values()['col-cat']) || (checked.includes('on') && !item.values()['col-cat']));
            document.getElementById('master-count').textContent = masterList.filtered ? masterList.matchingItems.length : masterList.items.length;
        }

        function showDetail(btn) {
            const vals = masterList.get('col-en', btn.closest('tr').querySelector('.col-en').textContent)[0].values();
            document.getElementById('det-en').textContent = vals['col-en'];
            document.getElementById('det-de').textContent = vals['col-de'] || '-';
            document.getElementById('det-fr').textContent = vals['col-fr'] || '-';
            document.getElementById('det-cat').textContent = vals['col-cat'] || '-';
            document.getElementById('det-def').textContent = vals['def'] || 'No definition available.';
            togglePane('details-pane', true);
        }

        function loadToday(data) {
            const items = data.map((r, idx) => ({ id: Date.now() + idx, en: r.EN||'', de: r.DE||'', fr: r.FR||'' }));
            todayList = new List('today-section', {
                valueNames: ['col-en', 'col-de', 'col-fr'],
                item: (v) => `<tr data-id="${v.id}" onclick="togglePin(${v.id})"><td class="col-en">${v.en}</td><td class="col-de">${v.de}</td><td class="col-fr">${v.fr}</td></tr>`
            }, items);
            document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
            if(items.length > 1) {
                document.getElementById('flashcard-toggle').style.display = 'flex';
                initFlashcards();
            }
        }

        function togglePin(id) {
            if (pinnedItems.has(id)) pinnedItems.delete(id); else pinnedItems.add(id);
            renderToday();
        }

        function renderToday() {
            const query = document.getElementById('today-search').value.toLowerCase();
            const allItems = todayList.items.map(i => i.values());
            const filtered = allItems.filter(i => !query || [i.en, i.de, i.fr].some(v => v.toLowerCase().includes(query)));
            
            document.getElementById('pinned-body').innerHTML = filtered.filter(i => pinnedItems.has(i.id))
                .map(i => `<tr style="background:rgba(52,152,219,0.2)" onclick="togglePin(${i.id})"><td>${i.en}</td><td>${i.de}</td><td>${i.fr}</td></tr>`).join('');
            
            document.getElementById('today-body').innerHTML = filtered.filter(i => !pinnedItems.has(i.id))
                .map(i => `<tr onclick="togglePin(${i.id})"><td>${i.en}</td><td>${i.de}</td><td>${i.fr}</td></tr>`).join('');
        }

        function addTodayTerm() {
            const en = document.getElementById('add-en'), de = document.getElementById('add-de'), fr = document.getElementById('add-fr');
            if (!en.value && !de.value) return;
            todayList.add({ id: Date.now(), en: en.value, de: de.value, fr: fr.value });
            en.value = ''; de.value = ''; fr.value = '';
            renderToday();
            initFlashcards();
        }

        function toggleFlashcards() {
            const area = document.getElementById('flash-area');
            area.classList.toggle('hidden');
            if (!area.classList.contains('hidden')) initFlashcards();
        }

        function initFlashcards() {
            flashcards = todayList.items.map(i => i.values()).filter(i => i.en || i.de || i.fr);
            if (flashcards.length === 0) return;
            currentFlashIdx = 0;
            showFlashcard();
        }

        function showFlashcard() {
            if (flashcards.length === 0) {
                document.getElementById('flashcard-content').textContent = "Session Complete!";
                return;
            }
            const item = flashcards[currentFlashIdx];
            const src = document.getElementById('flash-source-lang').value;
            document.getElementById('flashcard-lang').textContent = src;
            document.getElementById('flashcard-content').textContent = item[src] || '(blank)';
            document.getElementById('flash-stats').textContent = `${currentFlashIdx + 1} / ${flashcards.length}`;
            flashFlipped = false;
        }

        function flipCard() {
            const item = flashcards[currentFlashIdx];
            const src = document.getElementById('flash-source-lang').value;
            const targets = ['en', 'de', 'fr'].filter(l => l !== src);
            if (!flashFlipped) {
                document.getElementById('flashcard-lang').textContent = targets.join(' / ').toUpperCase();
                document.getElementById('flashcard-content').textContent = targets.map(t => item[t]).filter(Boolean).join(' / ') || '---';
            } else {
                document.getElementById('flashcard-lang').textContent = src.toUpperCase();
                document.getElementById('flashcard-content').textContent = item[src];
            }
            flashFlipped = !flashFlipped;
        }

        function nextCard(e) { e.stopPropagation(); currentFlashIdx = (currentFlashIdx + 1) % flashcards.length; showFlashcard(); }
        function markFlashDone(e) { e.stopPropagation(); flashcards.splice(currentFlashIdx, 1); if (currentFlashIdx >= flashcards.length) currentFlashIdx = 0; showFlashcard(); }

        const historyKey = 'glossary_history';
        function saveToHistory(name, data) {
            let hist = JSON.parse(localStorage.getItem(historyKey) || '[]');
            hist = hist.filter(h => h.name !== name);
            hist.unshift({ name, data, date: new Date().toLocaleDateString() });
            localStorage.setItem(historyKey, JSON.stringify(hist.slice(0, 5)));
            loadHistory();
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem(historyKey) || '[]');
            document.getElementById('recent-container').innerHTML = hist.length ? '<h3>Recently Used</h3>' + 
                hist.map(h => `<div class="recent-item" onclick='loadMaster(${JSON.stringify(h.data)})'><span>${h.name}</span><small>${h.date}</small></div>`).join('') : '';
        }

        function addMetaRow(id = '') {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="info-label"><input class="input-inline-edit" value="${id}"></td><td><input class="input-inline-edit" placeholder="..."></td>`;
            document.getElementById('metadata-table').appendChild(row);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            if(!sel) return;
            const options = { pat: 'Patent No', app: 'Applicant', tit: 'Title', opp: 'Opponent', rep: 'Representative', ivn: 'Inventor' };
            Object.entries(options).forEach(([v, t]) => { const opt = document.createElement('option'); opt.value = v; opt.textContent = t; sel.appendChild(opt); });
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => { loadMaster(r.data); saveToHistory(file.name, r.data); } });
        };

        const dropZone = document.getElementById('drop-area');
        dropZone.onclick = () => document.getElementById('today-file-input').click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleTodayFile(e.dataTransfer.files[0]); };
        document.getElementById('today-file-input').onchange = (e) => handleTodayFile(e.target.files[0]);

        async function handleTodayFile(file) {
            if (file.name.endsWith('.docx')) {
                const res = await file.arrayBuffer();
                const { value } = await mammoth.convertToHtml({ arrayBuffer: res });
                const div = document.createElement('div'); div.innerHTML = value;
                const rows = Array.from(div.querySelectorAll('tr')).map(tr => {
                    const tds = Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
                    return { EN: tds[0]||'', DE: tds[1]||'', FR: tds[2]||'' };
                });
                loadToday(rows.slice(1));
            } else {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => loadToday(r.data) });
            }
        }

        function downloadMaster() {
            const data = (masterList.filtered ? masterList.matchingItems : masterList.items).map(i => i.values());
            const csv = Papa.unparse(data.map(i => ({ EN: i['col-en'], DE: i['col-de'], FR: i['col-fr'], Category: i['col-cat'], Definition: i['def'] })));
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'filtered_glossary.csv'; a.click();
        }

        function downloadToday() {
            if (!todayList || todayList.items.length === 0) return;
            const csv = Papa.unparse(todayList.items.map(i => i.values()));
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'today_glossary.csv'; a.click();
        }

        function toggleDrop(id, e) {
            e.stopPropagation();
            const el = document.getElementById(id);
            const isVis = el.style.display === 'block';
            document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
            
            // Re-label logic for GL/EPC drops
            if (id.includes('gl') || id.includes('cl') || id.includes('epc')) {
                const btn = document.getElementById('btn-' + id.split('-')[1]);
                const title = id.includes('gl') ? 'Guidelines' : (id.includes('cl') ? 'Case Law' : 'EPC');
                if (isVis) {
                    const baseText = title === 'Guidelines' ? 'GL' : (title === 'Case Law' ? 'Case Law' : 'EPC');
                    btn.textContent = baseText + ' ‚ñæ';
                } else {
                    btn.textContent = title + ' ‚ñ¥';
                }
            }
            el.style.display = isVis ? 'none' : 'block';
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t; }

        window.onload = () => { 
            loadHistory();
            populateHeaderSelect();
            ['pat', 'app', 'tit'].forEach(id => addMetaRow(id)); 
        };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['col-en', 'col-de', 'col-fr']);
    </script>
</body>
</html>
