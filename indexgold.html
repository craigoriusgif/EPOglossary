<!DOCTYPE html>
<html lang="en">
<head>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EPO Interpreter Dashboard</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js');
        });
      }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* 1. Default Styles (Copy the :root and general styles here) */
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        /* 2. Layout Visibility Logic */
        .mobile-only, .tablet-only, .desktop-only { display: none !important; }

        @media (max-width: 480px) { .mobile-only { display: block !important; } }
        @media (min-width: 481px) and (max-width: 1024px) { .tablet-only { display: block !important; } }
        @media (min-width: 1025px) { .desktop-only { display: block !important; } }

        /* PASTE THE REST OF YOUR CSS BELOW THIS LINE */
        /* ============================================================
   1. DEVICE DISPLAY LOGIC (The "Switcher")
   ============================================================ */
.mobile-only, .tablet-only, .desktop-only { 
    display: none !important; 
}

/* Mobile: Phones */
@media (max-width: 480px) { 
    .mobile-only { display: block !important; } 
}

/* Tablet: iPads/Tablets */
@media (min-width: 481px) and (max-width: 1024px) { 
    .tablet-only { display: block !important; } 
}

/* Desktop: Laptops/Monitors */
@media (min-width: 1025px) { 
    .desktop-only { display: block !important; } 
}

/* ============================================================
   2. SHARED & DESKTOP CORE STYLES 
   ============================================================ */
:root {
    --primary-bg: #f0f2f5;
    --card-bg: #ffffff;
    --today-bg: #2d3436;
    --today-text: #dfe6e9;
    --border-color: #e4e6eb;
    --accent-blue: #0066cc;
    --accent-green: #28a745;
    --accent-red: #dc3545;
    --text-main: #1c1e21;
}

* { box-sizing: border-box; }

body { 
    font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
    margin: 0; 
    padding: 0; 
    background-color: var(--primary-bg); 
    color: var(--text-main); 
}

/* Dashboard Layout Structure */
.container { 
    display: grid; 
    grid-template-columns: 1fr 380px; 
    gap: 20px; 
    padding: 20px; 
    max-width: 1600px; 
    margin: 0 auto; 
}

.card { 
    background: var(--card-bg); 
    border-radius: 8px; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
    padding: 20px; 
    height: fit-content; 
}

/* Header & Controls */
.header-flex { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 20px; 
}

.search-container { 
    display: flex; 
    gap: 10px; 
    margin-bottom: 20px; 
}

input, select, button { 
    padding: 8px 12px; 
    border: 1px solid var(--border-color); 
    border-radius: 6px; 
    font-size: 14px; 
}

button { 
    cursor: pointer; 
    background: #fff; 
    transition: background 0.2s; 
}

button:hover { background: #f5f6f7; }

.btn-primary { background: var(--accent-blue); color: white; border: none; }
.btn-primary:hover { background: #0052a3; }

/* Table Styles */
table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 14px; 
}

th, td { 
    padding: 12px; 
    text-align: left; 
    border-bottom: 1px solid var(--border-color); 
}

th { 
    background: #f8f9fa; 
    position: sticky; 
    top: 0; 
    font-weight: 600; 
}

tr:hover { background-color: #f8f9fa; }

/* Right Column (Today/History) */
#today-section { 
    background: var(--today-bg); 
    color: var(--today-text); 
    position: sticky; 
    top: 20px; 
    max-height: calc(100vh - 40px); 
    overflow-y: auto; 
}

.theme-blue { --today-bg: #004085; }
.theme-green { --today-bg: #155724; }
.theme-red { --today-bg: #721c24; }

/* Dropdowns & UI Elements */
.dropdown { position: relative; display: inline-block; }
.dropdown-options { 
    display: none; 
    position: absolute; 
    background: white; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    border-radius: 8px; 
    z-index: 1000; 
    min-width: 180px; 
    margin-top: 5px; 
}

.dropdown-options div { 
    padding: 10px 15px; 
    cursor: pointer; 
    color: var(--text-main); 
}

.dropdown-options div:hover { background: #f0f2f5; }

/* Metadata rows for the Desktop layout */
.meta-row { 
    display: grid; 
    grid-template-columns: 120px 1fr 40px; 
    gap: 10px; 
    margin-bottom: 8px; 
}
    </style>
</head>
</head>
<body>

    <div class="mobile-only">
        <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view. <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Tap the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Tap the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Tap rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g. <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Tap terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary). The button appears once you load today's vocab. Tap the card to flip and test yourself. Mark done to remove the card from the deck. Tap the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPO Interpreter Dashboard!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To import and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
            <p>Then switch to the <strong>Today's Vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
            <p>Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            <p>The Language Service has provided a template for you to use.</p>
        </div>
    </div>
    
    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPO Interpreter Dashboard</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently Used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Tap to search terms..." onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="header-center-filters-row">
                        <div class="dropdown-container" style="position:relative; flex: 1;">
                            <button class="btn-ui" onclick="toggleDrop('cat-drop', event)" style="width: 100%;">üè∑Ô∏è Cats <span id="cat-badge-val" class="badge-inline hidden">0</span></button>
                            <div id="cat-reset-btn" class="hidden" style="position: absolute; top: -15px; right: 0; color:var(--accent-red); font-size: 10px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</div>
                            <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <div id="master-cat-list"></div>
                            </div>
                        </div>
                        <div class="dropdown-container" style="position:relative; flex: 1;">
                            <button class="btn-ui" onclick="toggleDrop('col-drop', event)" style="width: 100%;">‚ñ• Cols</button>
                            <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                                <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                                <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                            </div> 
                        </div> 
                        <button class="btn-ui" onclick="location.reload()" style="flex: 1;">üîÑ Load New</button> 
                        <button class="btn-ui btn-download" onclick="downloadMaster()" style="flex: 1;">üì• Download</button> 
                        <button class="btn-ui" onclick="togglePane('help-pane', true)" style="flex: 0.5;">‚ùì</button> 
                    </div>
                </div> 
            </div> 
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper" class="hidden"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                    <button onclick="togglePatentInfo()" class="btn-ui" style="height:30px; font-size:10px; padding:0 8px; background:rgba(255,255,255,0.1); color:inherit;">Hide ‚ñ¥</button> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 

            <div id="flashcard-ui" class="hidden">
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
                    <div style="position:absolute; bottom:10px; left:10px; font-size:10px; opacity:0.5;">Click to Flip</div>
                    <div id="flash-count" style="position:absolute; bottom:10px; right:10px; font-size:10px; opacity:0.7;"></div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">Study:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
                            <option value="fr">FR</option>
                        </select>
                    </div>
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark Done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5); padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Tap to import CSV or Word (.docx) table</div> 
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1; padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms..." onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                            <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue); color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue); color:white; border:none;">[+] Add Term</button> 
                        
                        <div class="dropdown-container" style="position:relative;">
                            <button class="btn-ui btn-download" onclick="toggleDrop('today-export-drop', event)">üì• Export</button>
                            <div id="today-export-drop" class="dropdown-options" style="position: absolute; top: 45px; right: 0; background: white; border: 1px solid #d1d5db; z-index: 1000; width: 140px; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21; border-bottom: 1px solid #eee;" onclick="downloadToday('csv')">CSV (.csv)</div>
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21; border-bottom: 1px solid #eee;" onclick="downloadToday('docx')">Word (.docx)</div>
                                <div style="cursor:pointer; padding: 8px; font-size: 12px; color: #1c1e21;" onclick="downloadToday('pdf')">PDF (.pdf)</div>
                            </div>
                        </div>
                    </div> 
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table"> <tbody id="today-body" class="list"></tbody> </table> 
                </div> 
            </div> 
            
            <div style="margin-top:auto; padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
                <div style="font-size:12px; font-weight:600; opacity:0.8;">üí° Click rows to pin terms</div> 
                <div style="display:flex; gap:12px; align-items:center;"> 
                    <button id="flashcard-btn" class="btn-ui hidden" onclick="toggleFlashcards()" style="height:25px; background:var(--accent-blue); color:white; border:none; padding:0 12px;">Flashcards</button>
                    <button onclick="setTheme('light')" style="width:20px; height:20px; border-radius:50%; background:#fff; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('dark')" style="width:20px; height:20px; border-radius:50%; background:#2d3436; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('sepia')" style="width:20px; height:20px; border-radius:50%; background:#f4ecd8; border:1px solid #999; cursor:pointer;"></button> 
                </div> 
            </div> 
        </section> 
    </div>

    <div class="pane-controls hidden">
        <button id="btn-split-view" class="toggle-btn" onclick="setLayout('split')">Split View</button>
        <button class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <button class="toggle-btn" onclick="setLayout('today')">Today's Vocab</button>
        <button class="toggle-btn" onclick="setLayout('today'); togglePatentInfo();">Patent Info ‚ñ¥</button>
        <button id="btn-flash-mobile" class="toggle-btn hidden" onclick="setLayout('today'); toggleFlashcards();" style="background: var(--accent-blue); color: white;">üé¥ Flashcards</button>
        <span style="color:#666; margin: 0 5px;">|</span>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html', 'Guidelines')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law', 'Case Law')">Case Law ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html', 'EPC')">EPC ‚ñ¥</button>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
        let activeFlashcards = [];

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
            pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" }
        };

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
                itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
                    itemsDiv.appendChild(div);
                });
            }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
            localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) { 
            document.getElementById(id).classList.toggle('active', show);
            const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target=\"_blank\">${url}</a>`); }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
            document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ? linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            sel.innerHTML = '';
            Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = headerTranslations[k][currentMetaLang]; sel.appendChild(opt);
            });
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
            document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type; const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow() {
            const type = document.getElementById('header-select').value;
            const table = document.getElementById('meta-table-body');
            let num = ''; if(['opp', 'res', 'apl'].includes(type)) num = table.querySelectorAll(`tr[data-type="${type}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = type; tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[type][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" placeholder="..."></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            document.getElementById('patent-info-wrapper').classList.toggle('hidden');
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                const clean = r.data.map(row => ({
                    en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                    definition: row.Definition || row.definition || '',
                    category: (row.Category || row.category || '').replace(/[\[\]"]/g, '').split(',').map(s => s.trim()).filter(s => s).join(', ')
                }));
                saveToHistory(file.name, clean); launchApp(clean);
            }});
        };

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.querySelector('.pane-controls').classList.remove('hidden');
            masterList = new List('main-section', { 
                valueNames: ['en', 'de', 'fr', 'category', 'definition'], 
                item: `<tr class="master-row"><td class="en col-en"></td><td class="de col-de"></td><td class="fr col-fr"></td><td class="category col-cat"></td></tr>` 
            }, data);
            masterList.items.forEach(item => {
                const v = item.values(); if (v.definition && v.definition.trim()) item.elm.querySelector('.en').innerHTML += 'üí°';
                item.elm.onclick = () => openRowDetails(v);
            });
            const cats = [...new Set(data.flatMap(i => i.category.split(',').map(s => s.trim())))].filter(s => s).sort();
            const filterEl = document.getElementById('master-cat-list'); filterEl.innerHTML = '';
            cats.forEach(c => {
                const label = document.createElement('label'); label.style.display = 'block'; label.innerHTML = `<input type="checkbox" value="${c}" class="cat-chk"> ${c}`;
                label.querySelector('input').onchange = updateFilters; filterEl.appendChild(label);
            });
            if (window.innerWidth <= 768) setLayout('master');
        }

        function updateFilters() {
            const sel = Array.from(document.querySelectorAll('.cat-chk:checked')).map(i => i.value);
            const badge = document.getElementById('cat-badge-val');
            const resetBtn = document.getElementById('cat-reset-btn');
            if(sel.length > 0) { badge.classList.remove('hidden'); badge.textContent = sel.length; resetBtn.classList.remove('hidden');
            } 
            else { badge.classList.add('hidden'); resetBtn.classList.add('hidden');
            }
            masterList.filter(item => sel.length === 0 || sel.every(s => item.values().category.includes(s)));
        }

        function resetCategories() { document.querySelectorAll('.cat-chk').forEach(c => c.checked = false); updateFilters(); }
        function toggleCol(col, show) { document.getElementById('main-list').classList.toggle(`hide-${col}`, !show); }

        // --- NEW WORKING CAPACITOR DOWNLOAD LOGIC ---
        async function performDownload(csvData, fileName) {
            if (window.Capacitor && Capacitor.Plugins.Filesystem) {
                try {
                    const { Filesystem, Share } = Capacitor.Plugins;
                    const result = await Filesystem.writeFile({
                        path: fileName,
                        data: csvData,
                        directory: 'DOCUMENTS',
                        encoding: 'utf8'
                    });

                    if (Share) {
                        await Share.share({
                            title: 'Export Glossary',
                            url: result.uri,
                            dialogTitle: 'Share CSV file'
                        });
                    } else {
                        alert("File saved to Documents: " + fileName);
                    }
                } catch (err) {
                    console.error('Download failed', err);
                    alert("Export failed: " + err.message);
                }
            } else {
                const blob = new Blob(["\ufeff" + csvData], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Master Download trigger
        function downloadMaster() { 
            if (!masterList || masterList.items.length === 0) return;
            const csvData = Papa.unparse(masterList.visibleItems.map(item => {
                const v = item.values();
                return { EN: v.en, DE: v.de, FR: v.fr, Category: v.category, Definition: v.definition };
            }));
            performDownload(csvData, "epo_master_glossary.csv");
        }

        const dropArea = document.getElementById('drop-area');
        dropArea.onclick = () => { let i = document.createElement('input'); i.type='file'; i.onchange=(e)=>handleToday(e.target.files[0]); i.click(); };
        dropArea.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); };
        dropArea.ondragenter = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drag-over'); };
        dropArea.ondragleave = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); };
        dropArea.ondrop = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleToday(e.dataTransfer.files[0]); };

        function handleToday(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'csv') {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                    const norm = r.data.map(row => {
                        let o = { en: '', de: '', fr: '' }; 
                        Object.keys(row).forEach(k => { 
                            const l = k.toLowerCase(); 
                            if(l==='en'||l==='english') o.en=row[k]; 
                            if(l==='de'||l==='german') o.de=row[k]; 
                            if(l==='fr'||l==='french') o.fr=row[k]; 
                        });
                        return o;
                    });
                    initToday(norm);
                }});
            } else if (ext === 'docx') {
                const r = new FileReader();
                r.onload = (e) => mammoth.convertToHtml({arrayBuffer: e.target.result}).then(res => {
                    const temp = document.createElement('div'); temp.innerHTML = res.value; 
                    const rows = Array.from(temp.querySelectorAll('tr'));
                    if (rows.length < 1) return; 
                    const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());
                    initToday(rows.slice(1).map(tr => { 
                        let o = { en: '', de: '', fr: '' }; 
                        tr.querySelectorAll('td').forEach((td, i) => { 
                            if(headers[i].includes('en') || headers[i].includes('english')) o.en = td.innerText.trim();
                            if(headers[i].includes('de') || headers[i].includes('german')) o.de = td.innerText.trim();
                            if(headers[i].includes('fr') || headers[i].includes('french')) o.fr = td.innerText.trim();
                        }); 
                        return o; 
                    }));
                });
                r.readAsArrayBuffer(file);
            }
        }

        function initToday(data) {
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn').classList.remove('hidden');
            if (window.innerWidth <= 768) document.getElementById('btn-flash-mobile').classList.remove('hidden');

            const hasEn = data.some(row => row.en && row.en.trim() !== "");
            const hasDe = data.some(row => row.de && row.de.trim() !== "");
            const hasFr = data.some(row => row.fr && row.fr.trim() !== "");

            let rowTemplate = '<tr onclick="togglePin(this)" style="cursor:pointer;">';
            if (hasEn) rowTemplate += '<td class="en"></td>';
            if (hasDe) rowTemplate += '<td class="de"></td>';
            if (hasFr) rowTemplate += '<td class="fr"></td>';
            rowTemplate += '</tr>';

            todayList = new List('today-section', { valueNames: ['en', 'de', 'fr'], item: rowTemplate }, data);
        }

        function toggleInlineAdd() {
            const header = document.getElementById('inline-add-header');
            const search = document.getElementById('today-search');
            const btn = document.getElementById('btn-toggle-add');
            const isAdding = header.classList.toggle('hidden');
            search.classList.toggle('hidden', !isAdding);
            btn.textContent = isAdding ? '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value.trim(), de = document.getElementById('new-de').value.trim(), fr = document.getElementById('new-fr').value.trim();
            if (!en) return;
            if (!todayList) initToday([{ en, de, fr }]); else todayList.add({ en, de, fr });
            document.getElementById('new-en').value = '';
            document.getElementById('new-de').value = ''; document.getElementById('new-fr').value = '';
            toggleInlineAdd();
        }

        function togglePin(row) {
            const item = { en: row.querySelector('.en')?.textContent || '', de: row.querySelector('.de')?.textContent || '', fr: row.querySelector('.fr')?.textContent || '' };
            const idx = pinnedItems.findIndex(i => i.en === item.en); if (idx > -1) pinnedItems.splice(idx, 1); else pinnedItems.push(item);
            renderPinned();
        }

        function renderPinned() {
            const area = document.getElementById('today-pinned-area'), body = document.getElementById('pinned-body');
            body.innerHTML = ''; area.classList.toggle('hidden', !pinnedItems.length);
            pinnedItems.forEach(item => {
                const tr = document.createElement('tr'); tr.style.background = 'rgba(0,102,204,0.2)';
                tr.onclick = () => { pinnedItems = pinnedItems.filter(i => i.en !== item.en); renderPinned(); };
                tr.innerHTML = `<td style=\"width:33%;\">üìå ${item.en}</td><td style=\"width:33%;\">${item.de}</td><td style=\"width:33%;\">${item.fr}</td>`;
                body.appendChild(tr);
            });
        }

        function resetFlashcards() {
            if (!todayList || todayList.items.length === 0) return;
            activeFlashcards = [...todayList.items.map(i => i.values())];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            flashcardIndex = 0;
            showFlashcard();
        }

        function toggleFlashcards() {
            const isVisible = document.getElementById('flashcard-ui').classList.toggle('hidden');
            if (!isVisible) resetFlashcards();
        }

        function showFlashcard() {
            const content = document.getElementById('flashcard-content'), langLabel = document.getElementById('flashcard-lang'), countLabel = document.getElementById('flash-count');
            if (activeFlashcards.length === 0) {
                langLabel.textContent = "Finished";
                content.textContent = "All terms learned!"; countLabel.textContent = "0 left"; return;
            }
            const item = activeFlashcards[flashcardIndex], source = document.getElementById('flash-source-lang').value;
            isFlashcardFlipped = false;
            langLabel.textContent = source === 'en' ? 'English' : (source === 'de' ? 'German' : 'French');
            content.textContent = item[source];
            countLabel.textContent = `${activeFlashcards.length} left`;
        }

        function flipFlashcard() {
            if (activeFlashcards.length === 0) return;
            const item = activeFlashcards[flashcardIndex], source = document.getElementById('flash-source-lang').value;
            const content = document.getElementById('flashcard-content'), langLabel = document.getElementById('flashcard-lang');
            isFlashcardFlipped = !isFlashcardFlipped;
            if (isFlashcardFlipped) {
                const targets = ['en', 'de', 'fr'].filter(l => l !== source);
                langLabel.textContent = "Translations";
                content.innerHTML = `${item[targets[0]]}<br><span style="font-weight:normal; font-size:14px; opacity:0.7;">${item[targets[1]]}</span>`;
            } else showFlashcard();
        }

        function markFlashcardDone() {
            if (activeFlashcards.length === 0) return;
            activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = 0;
            showFlashcard();
        }

        function nextFlashcard() { if (activeFlashcards.length === 0) return;
        flashcardIndex = (flashcardIndex + 1) % activeFlashcards.length; showFlashcard(); }
        function prevFlashcard() { if (activeFlashcards.length === 0) return;
        flashcardIndex = (flashcardIndex - 1 + activeFlashcards.length) % activeFlashcards.length; showFlashcard();
        }

        function setLayout(mode) {
            const m = document.getElementById('main-section'), t = document.getElementById('today-section');
            m.classList.remove('hidden', 'full-width'); t.classList.remove('hidden', 'full-width');
            document.getElementById('main-list').classList.remove('hidden'); 
            document.getElementById('legal-iframe-container').classList.add('hidden');
            document.getElementById('main-title').textContent = 'Glossary';
            if(mode === 'master') { t.classList.add('hidden'); m.classList.add('full-width'); }
            if(mode === 'today') { m.classList.add('hidden'); t.classList.add('full-width'); }
        }

        function showLegal(url, title) {
            const container = document.getElementById('legal-iframe-container'), iframe = document.getElementById('legal-frame');
            if (!container.classList.contains('hidden') && iframe.src === url) { setLayout('split'); return; }
            document.getElementById('main-list').classList.add('hidden');
            container.classList.remove('hidden'); iframe.src = url; document.getElementById('main-title').textContent = title;
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t; }
        function toggleDrop(id, e) { e.stopPropagation(); const el = document.getElementById(id); const isVis = el.style.display === 'block'; document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); el.style.display = isVis ? 'none' : 'block'; }

        // Metadata extraction for exports
        function getPatentMetadata() {
            const meta = [];
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const label = tr.querySelector('.info-label')?.textContent || "";
                const value = tr.querySelector('.input-inline-edit')?.value || "";
                if (value) meta.push(`${label}: ${value}`);
            });
            return meta;
        }

        // Enhanced Export for Today View
        async function downloadToday(format) { 
            if (!todayList || todayList.items.length === 0) return;
            
            const items = todayList.items.map(i => i.values());
            const metadata = getPatentMetadata();
            const timestamp = new Date().toISOString().slice(0,10);
            const fileName = `today_vocab_${timestamp}`;

            if (format === 'csv') {
                const csvData = Papa.unparse(items);
                // Also utilizing the Capacitor-friendly download here
                performDownload(csvData, `${fileName}.csv`);
            } 
            
            else if (format === 'docx') {
                const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun } = window.docx;
                
                const metaParagraphs = metadata.map(line => new Paragraph({
                    children: [new TextRun({ text: line, size: 20 })]
                }));

                const rows = items.map(item => new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph(item.en || "")] }),
                        new TableCell({ children: [new Paragraph(item.de || "")] }),
                        new TableCell({ children: [new Paragraph(item.fr || "")] }),
                    ],
                }));

                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({ text: "Vocabulary List Export", heading: "Heading1" }),
                            ...metaParagraphs,
                            new Paragraph({ text: "", spacing: { before: 200 } }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ text: "English", bold: true })] }),
                                            new TableCell({ children: [new Paragraph({ text: "German", bold: true })] }),
                                            new TableCell({ children: [new Paragraph({ text: "French", bold: true })] }),
                                        ],
                                    }),
                                    ...rows
                                ],
                            }),
                        ],
                    }],
                });

                Packer.toBlob(doc).then(blob => saveAs(blob, `${fileName}.docx`));
            } 
            
            else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text("Vocabulary List Export", 14, 15);
                
                doc.setFontSize(10);
                let currentY = 22;
                metadata.forEach(line => {
                    doc.text(line, 14, currentY);
                    currentY += 6;
                });

                const body = items.map(i => [i.en, i.de, i.fr]);
                doc.autoTable({
                    startY: currentY + 5,
                    head: [['English', 'German', 'French']],
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 102, 204] }
                });
                doc.save(`${fileName}.pdf`);
            }
        }

        window.onload = () => { loadHistory(); populateHeaderSelect(); ['pat', 'app', 'tit'].forEach(id => { document.getElementById('header-select').value = id; addMetaRow(); }); };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
    </script>
        </div>

    <div class="tablet-only">
       

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>Help</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view. <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Tap the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Tap the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Tap rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g. <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Tap terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary). The button appears once you load today's vocab. Tap the card to flip and test yourself. Mark done to remove the card from the deck. Tap the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>Welcome to EPO Interpreter Dashboard!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To import and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
            <p>Then switch to the <strong>Today's Vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
            <p>Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            <p>The Language Service has provided a template for you to use.</p>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPO Interpreter Dashboard</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO Glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">‚ùì Get started</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently Used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Tap here and start typing to search..." style="flex:2;" onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('cat-drop', event)">üè∑Ô∏è Categories <span id="cat-badge-val" class="badge-inline hidden">0</span> <span id="cat-reset-btn" class="hidden" style="color:var(--accent-red); margin-left:8px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</span></button>
                        <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <div id="master-cat-list"></div>
                        </div>
                    </div>
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('col-drop', event)">‚ñ• Columns</button>
                        <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                            <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                        </div> 
                    </div> 
                    <button class="btn-ui" onclick="location.reload()">üîÑ Load New</button> 
                    <button class="btn-ui btn-download" onclick="downloadMaster()">üì• Download</button> 
                    <button class="btn-ui" onclick="togglePane('help-pane', true)">‚ùì Help</button> 
                </div> 
            </div> 

            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;" referrerpolicy="no-referrer"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                    <button onclick="togglePatentInfo()" class="btn-ui" style="height:30px; font-size:10px; padding:0 8px; background:rgba(255,255,255,0.1); color:inherit;">Hide ‚ñ¥</button> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 

            <div id="flashcard-ui" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">Study:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
                            <option value="fr">FR</option>
                        </select>
                        <span id="flash-count" style="font-size:10px; margin-left:8px; opacity:0.7;"></span>
                    </div>
                    <button onclick="toggleFlashcards()" class="btn-ui" style="height:25px; padding:0 10px; font-size:10px; background:rgba(255,255,255,0.1); color:inherit;">Close √ó</button>
                </div>
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
                    <div style="position:absolute; bottom:10px; left:0; right:0; font-size:10px; opacity:0.5;">Click to Flip</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark Done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="patent-hidden-indicator" class="hidden" style="text-align:center; margin-bottom:10px;"> <button onclick="togglePatentInfo()" style="background:none; border:1px solid rgba(128,128,128,0.5); color:inherit; font-size:10px; padding:2px 10px; border-radius:4px; cursor:pointer;">Show Patent Info ‚ñæ</button> </div> 
            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5); padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Drag and drop CSV or Word (.docx) file or tap to open.</div> 
            
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1; padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms..." onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                            <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue); color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue); color:white; border:none;">[+] Add Term</button> 
                        <button onclick="downloadToday()" class="btn-ui btn-download">üì• Export</button> 
                    </div> 
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table"> <tbody id="today-body" class="list"></tbody> </table> 
                </div> 
            </div> 
            
            <div style="margin-top:auto; padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
                <div style="font-size:12px; font-weight:600; opacity:0.8;">üí° Tap rows to pin terms</div> 
            </div> 
        </section> 
    </div>

    <div class="pane-controls hidden">
        <button id="nav-btn-master" class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <span style="color:#666; margin: 0 5px;">|</span>
        <button id="nav-btn-today" class="toggle-btn" onclick="setLayout('today')">Today‚Äôs vocab</button>
        <button id="flashcard-btn-float" class="toggle-btn hidden" onclick="toggleFlashcards()" style="background:var(--accent-blue); color:white; border:none;">üé¥ Flashcards</button>
        
        <div id="theme-toggles" style="display:none; gap:6px; margin-left:5px;">
            <div class="theme-circle" onclick="setTheme('light')" style="background:#fff;"></div>
            <div class="theme-circle" onclick="setTheme('dark')" style="background:#2d3436;"></div>
            <div class="theme-circle" onclick="setTheme('sepia')" style="background:#f4ecd8;"></div>
        </div>
        
        <span style="color:#666; margin: 0 5px;">|</span>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html', 'Guidelines')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law/2025/index.html', 'Case Law')">Case Law ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html', 'EPC')">EPC ‚ñ¥</button>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
        let activeFlashcards = [];
        let previousLayout = 'master'; 

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
            pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" }
        };

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
                itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
                    itemsDiv.appendChild(div);
                });
            }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
            localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) { 
            document.getElementById(id).classList.toggle('active', show);
            const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target=\"_blank\">${url}</a>`); }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
            document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ? linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            sel.innerHTML = '';
            Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = headerTranslations[k][currentMetaLang]; sel.appendChild(opt);
            });
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
            document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type; const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow(type = null, value = '') {
            if (!type) type = document.getElementById('header-select').value;
            const table = document.getElementById('meta-table-body');
            let num = ''; if(['opp', 'res', 'apl'].includes(type)) num = table.querySelectorAll(`tr[data-type="${type}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = type; tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[type][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" value="${value}" placeholder="..."></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            const infoWrapper = document.getElementById('patent-info-wrapper');
            const hiddenIndicator = document.getElementById('patent-hidden-indicator');
            const isCurrentlyHidden = infoWrapper.classList.toggle('hidden');
            if (isCurrentlyHidden) { hiddenIndicator.classList.remove('hidden'); } else { hiddenIndicator.classList.add('hidden'); }
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                const clean = r.data.map(row => ({
                    en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                    definition: row.Definition || row.definition || '',
                    category: (row.Category || row.category || '').replace(/[\[\]"]/g, '').split(',').map(s => s.trim()).filter(s => s).join(', ')
                }));
                saveToHistory(file.name, clean); launchApp(clean);
            }});
        };

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.querySelector('.pane-controls').classList.remove('hidden');
            masterList = new List('main-section', { 
                valueNames: ['en', 'de', 'fr', 'category', 'definition'], 
                item: `<tr class="master-row"><td class="en col-en"></td><td class="de col-de"></td><td class="fr col-fr"></td><td class="category col-cat"></td></tr>` 
            }, data);
            masterList.items.forEach(item => {
                const v = item.values(); if (v.definition && v.definition.trim()) item.elm.querySelector('.en').innerHTML += 'üí°';
                item.elm.onclick = () => openRowDetails(v);
            });
            const cats = [...new Set(data.flatMap(i => i.category.split(',').map(s => s.trim())))].filter(s => s).sort();
            const filterEl = document.getElementById('master-cat-list'); filterEl.innerHTML = '';
            cats.forEach(c => {
                const label = document.createElement('label'); label.style.display = 'block'; label.innerHTML = `<input type="checkbox" value="${c}" class="cat-chk"> ${c}`;
                label.querySelector('input').onchange = updateFilters; filterEl.appendChild(label);
            });
            setLayout('master');
        }

        function updateFilters() {
            const sel = Array.from(document.querySelectorAll('.cat-chk:checked')).map(i => i.value);
            const badge = document.getElementById('cat-badge-val');
            const resetBtn = document.getElementById('cat-reset-btn');
            if(sel.length > 0) { badge.classList.remove('hidden'); badge.textContent = sel.length; resetBtn.classList.remove('hidden');
            } else { badge.classList.add('hidden'); resetBtn.classList.add('hidden'); }
            masterList.filter(item => sel.length === 0 || sel.every(s => item.values().category.includes(s)));
        }

        function resetCategories() { document.querySelectorAll('.cat-chk').forEach(c => c.checked = false); updateFilters(); }
        function toggleCol(col, show) { document.getElementById('main-list').classList.toggle(`hide-${col}`, !show); }
        function downloadMaster() { const csv = Papa.unparse(masterList.items.map(i => i.values())); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'glossary_export.csv'; a.click(); }

        const dropArea = document.getElementById('drop-area');
        dropArea.onclick = () => { let i = document.createElement('input'); i.type='file'; i.onchange=(e)=>handleToday(e.target.files[0]); i.click(); };
        dropArea.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); };
        dropArea.ondragenter = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drag-over'); };
        dropArea.ondragleave = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); };
        dropArea.ondrop = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleToday(e.dataTransfer.files[0]); };
        function handleToday(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const mapKeys = (row) => {
                let o = {};
                Object.keys(row).forEach(k => { 
                    const l = k.toLowerCase(); 
                    if(l==='en'||l==='english') o.en=row[k]; 
                    if(l==='de'||l==='german') o.de=row[k]; 
                    if(l==='fr'||l==='french') o.fr=row[k]; 
                    if(l==='category') o.category=row[k];
                    if(l==='definition') o.definition=row[k];
                });
                return o;
            };

            if (ext === 'csv') {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                    const norm = r.data.map(mapKeys);
                    processTodayData(norm);
                }});
            } else if (ext === 'docx') {
                const r = new FileReader();
                r.onload = (e) => mammoth.convertToHtml({arrayBuffer: e.target.result}).then(res => {
                    const temp = document.createElement('div'); temp.innerHTML = res.value; const rows = Array.from(temp.querySelectorAll('tr'));
                    if (rows.length < 1) return; 
                    const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());
                    const data = rows.slice(1).map(tr => { 
                        let o = {}; tr.querySelectorAll('td').forEach((td, i) => { if(headers[i]) o[headers[i]] = td.innerText.trim(); }); 
                        return mapKeys(o); 
                    });
                    processTodayData(data);
                });
                r.readAsArrayBuffer(file);
            }
        }

        function processTodayData(data) {
            document.getElementById('meta-table-body').innerHTML = '';
            const vocab = [];
            const metaMap = { "patent": "pat", "application": "app", "title": "tit", "priority": "pri", "proprietor": "pro", "opponent": "opp", "respondent": "res", "appellant": "apl" };
            data.forEach(item => {
                let foundMeta = false;
                const enVal = (item.en || "").toLowerCase();
                for (let key in metaMap) {
                    if (enVal.includes(key)) {
                        addMetaRow(metaMap[key], item.de || item.fr || ""); 
                        foundMeta = true;
                        break;
                    }
                }
                if (!foundMeta && item.en) vocab.push(item);
            });
            const currentTypes = Array.from(document.querySelectorAll('#meta-table-body tr')).map(tr => tr.dataset.type);
            ['pat', 'app', 'tit'].forEach(t => { if(!currentTypes.includes(t)) addMetaRow(t); });
            initToday(vocab);
        }

        function initToday(data) {
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn-float').classList.remove('hidden');
            todayList = new List('today-section', { valueNames: ['en', 'de', 'fr'], item: `<tr onclick=\"togglePin(this)\" style=\"cursor:pointer;\"><td class=\"en\"></td><td class=\"de\"></td><td class=\"fr\"></td></tr>` }, data);
        }

        function toggleInlineAdd() {
            const header = document.getElementById('inline-add-header');
            const search = document.getElementById('today-search');
            const btn = document.getElementById('btn-toggle-add');
            const isAdding = header.classList.toggle('hidden');
            search.classList.toggle('hidden', !isAdding);
            btn.textContent = isAdding ? '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value.trim(), de = document.getElementById('new-de').value.trim(), fr = document.getElementById('new-fr').value.trim();
            if (!en) return;
            if (!todayList) initToday([{ en, de, fr }]); else todayList.add({ en, de, fr });
            document.getElementById('new-en').value = '';
            document.getElementById('new-de').value = ''; document.getElementById('new-fr').value = '';
            toggleInlineAdd();
        }

        function togglePin(row) {
            const item = { en: row.querySelector('.en').textContent, de: row.querySelector('.de').textContent, fr: row.querySelector('.fr').textContent };
            const idx = pinnedItems.findIndex(i => i.en === item.en); if (idx > -1) pinnedItems.splice(idx, 1); else pinnedItems.push(item);
            renderPinned();
        }

        function renderPinned() {
            const area = document.getElementById('today-pinned-area'), body = document.getElementById('pinned-body');
            body.innerHTML = ''; area.classList.toggle('hidden', !pinnedItems.length);
            pinnedItems.forEach(item => {
                const tr = document.createElement('tr'); tr.style.background = 'rgba(0,102,204,0.2)';
                tr.onclick = () => { pinnedItems = pinnedItems.filter(i => i.en !== item.en); renderPinned(); };
                tr.innerHTML = `<td style=\"width:33%;\">üìå ${item.en}</td><td style=\"width:33%;\">${item.de}</td><td style=\"width:33%;\">${item.fr}</td>`;
                body.appendChild(tr);
            });
        }

        function resetFlashcards() {
            if (!todayList || todayList.items.length === 0) return;
            activeFlashcards = [...todayList.items.map(i => i.values())];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            flashcardIndex = 0;
            showFlashcard();
        }

        function toggleFlashcards() {
            const flashcardUI = document.getElementById('flashcard-ui');
            const isVisible = flashcardUI.classList.contains('hidden');
            
            if (isVisible) {
                setLayout('today');
                flashcardUI.classList.remove('hidden');
                document.getElementById('patent-info-wrapper').classList.add('hidden');
                resetFlashcards();
            } else {
                flashcardUI.classList.add('hidden');
                document.getElementById('patent-info-wrapper').classList.remove('hidden');
            }
        }

        function showFlashcard() {
            const content = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            const countLabel = document.getElementById('flash-count');
            if (activeFlashcards.length === 0) { langLabel.textContent = "Finished";
            content.textContent = "All terms learned!"; countLabel.textContent = "0 left"; return;
            }
            const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
            isFlashcardFlipped = false;
            langLabel.textContent = source === 'en' ? 'English' : (source === 'de' ? 'German' : 'French');
            content.textContent = item[source];
            countLabel.textContent = `${activeFlashcards.length} left`;
        }

        function flipFlashcard() {
            if (activeFlashcards.length === 0) return;
            const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
            const content = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            isFlashcardFlipped = !isFlashcardFlipped;
            if (isFlashcardFlipped) {
                const targets = ['en', 'de', 'fr'].filter(l => l !== source);
                langLabel.textContent = "Translations";
                content.innerHTML = `${item[targets[0]]}<br><span style="font-weight:normal; font-size:14px; opacity:0.7;">${item[targets[1]]}</span>`;
            } else { showFlashcard(); }
        }

        function markFlashcardDone() {
            if (activeFlashcards.length === 0) return;
            activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = 0;
            showFlashcard();
        }

        function nextFlashcard() { if (activeFlashcards.length === 0) return; flashcardIndex = (flashcardIndex + 1) % activeFlashcards.length; showFlashcard(); }
        function prevFlashcard() { if (activeFlashcards.length === 0) return; flashcardIndex = (flashcardIndex - 1 + activeFlashcards.length) % activeFlashcards.length; showFlashcard(); }

        function setLayout(mode) {
            const m = document.getElementById('main-section'), t = document.getElementById('today-section');
            m.classList.remove('hidden', 'full-width'); t.classList.remove('hidden', 'full-width');
            document.querySelector('.header-with-logo').classList.remove('hidden');
            document.getElementById('main-list').classList.remove('hidden'); 
            document.getElementById('legal-iframe-container').classList.add('hidden');
            document.getElementById('main-title').textContent = 'Glossary';
            document.getElementById('btn-gl').textContent = 'GL ‚ñ¥'; document.getElementById('btn-cl').textContent = 'Case Law ‚ñ¥';
            document.getElementById('btn-epc').textContent = 'EPC ‚ñ¥';
            
            document.getElementById('nav-btn-master').classList.toggle('active', mode === 'master');
            document.getElementById('nav-btn-today').classList.toggle('active', mode === 'today');

            const themeToggles = document.getElementById('theme-toggles');
            if(mode === 'master') { 
                t.classList.add('hidden');
                m.classList.add('full-width'); 
                previousLayout = 'master';
                themeToggles.style.display = 'none';
            }
            if(mode === 'today') { 
                m.classList.add('hidden');
                t.classList.add('full-width');
                previousLayout = 'today'; 
                themeToggles.style.display = 'flex';
            }
        }

        function showLegal(url, title) {
            const container = document.getElementById('legal-iframe-container'), iframe = document.getElementById('legal-frame');
            const btnId = title === 'Guidelines' ? 'btn-gl' : (title === 'Case Law' ? 'btn-cl' : 'btn-epc'), btn = document.getElementById(btnId);
            if (!container.classList.contains('hidden') && iframe.src === url) { setLayout(previousLayout); return; }
            document.querySelector('.header-with-logo').classList.add('hidden');
            document.getElementById('main-list').classList.add('hidden'); 
            container.classList.remove('hidden'); 
            iframe.src = url; 
            document.getElementById('main-title').textContent = title;
            document.getElementById('btn-gl').textContent = 'GL ‚ñ¥'; document.getElementById('btn-cl').textContent = 'Case Law ‚ñ¥';
            document.getElementById('btn-epc').textContent = 'EPC ‚ñ¥';
            const baseText = title === 'Guidelines' ? 'GL' : (title === 'Case Law' ? 'Case Law' : 'EPC');
            btn.textContent = baseText + ' ‚ñæ';
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t; }
        function toggleDrop(id, e) { e.stopPropagation(); const el = document.getElementById(id); const isVis = el.style.display === 'block'; document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); el.style.display = isVis ? 'none' : 'block'; }
        function downloadToday() { if (!todayList || todayList.items.length === 0) return; const csv = Papa.unparse(todayList.items.map(i => i.values())); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'today_glossary.csv'; a.click(); }

        window.onload = () => { 
            loadHistory();
            populateHeaderSelect();
            ['pat', 'app', 'tit'].forEach(id => addMetaRow(id)); 
        };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
    </script>
        </div>

    <div class="desktop-only">
        <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>User Guide</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
             <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view. <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Click the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Click the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Click rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only, e.g. <strong>Chemicals</strong> category, <strong>Appeal</strong> category or terms matching <strong>acid</strong>.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Click terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP (not the EPO Glossary). The button appears once you load today's vocab. Click the card to flip and test yourself. Mark done to remove the card from the deck. Click the Source dropdown to change language.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6;">
            <p><strong>Welcome to EPO Interpreter Dashboard!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To import and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
            <p>Then switch to the <strong>Today's vocab</strong> view and add your own glossary in either CSV or Word (.docx) format.</p>
            <p>Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row (even if you are not using them).</p>
            <p>The Language Service has provided a template for you to use.</p>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom:30px;">EPO Interpreter Dashboard</h1>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO Glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Click here to search..." style="flex:2;" onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('cat-drop', event)">üè∑Ô∏è Categories <span id="cat-badge-val" class="badge-inline hidden">0</span> <span id="cat-reset-btn" class="hidden" style="color:var(--accent-red); margin-left:8px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</span></button>
                        <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <div id="master-cat-list"></div>
                        </div>
                    </div>
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('col-drop', event)">‚ñ• Columns</button>
                        <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                            <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                        </div> 
                    </div> 
                    <button class="btn-ui" onclick="location.reload()">üîÑ Load New</button> 
                    <button class="btn-ui btn-download" onclick="downloadMaster()">üì• Download</button> 
                    <button class="btn-ui" onclick="togglePane('help-pane', true)">‚ùì Help</button> 
                </div> 
            </div> 
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                    <button onclick="togglePatentInfo()" class="btn-ui" style="height:30px; font-size:10px; padding:0 8px; background:rgba(255,255,255,0.1); color:inherit;">Hide ‚ñ¥</button> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 

            <div id="flashcard-ui" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">Source:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
                            <option value="fr">FR</option>
                        </select>
                        <span id="flash-count" style="font-size:10px; margin-left:8px; opacity:0.7;"></span>
                    </div>
                    <button onclick="toggleFlashcards()" class="btn-ui" style="height:25px; padding:0 10px; font-size:10px; background:rgba(255,255,255,0.1); color:inherit;">Close √ó</button>
                </div>
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
                    <div style="position:absolute; bottom:10px; left:0; right:0; font-size:10px; opacity:0.5;">Click to Flip</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="patent-hidden-indicator" class="hidden" style="text-align:center; margin-bottom:10px;"> <button onclick="togglePatentInfo()" style="background:none; border:1px solid rgba(128,128,128,0.5); color:inherit; font-size:10px; padding:2px 10px; border-radius:4px; cursor:pointer;">Show Patent Info ‚ñæ</button> </div> 
            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5); padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Click to import today's vocab here as a CSV or Word (.docx) file. Or just drag and drop.</div> 
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1; padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms..." onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                            <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue); color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue); color:white; border:none;">[+] Add Term</button> 
                        <button onclick="downloadToday()" class="btn-ui btn-download">üì• Export</button> 
                    </div> 
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table"> <tbody id="today-body" class="list"></tbody> </table> 
                </div> 
            </div> 
            
            <div style="margin-top:auto; padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
    <button id="flashcard-btn" class="btn-ui hidden" onclick="toggleFlashcards()" style="height:25px; background:var(--accent-blue); color:white; border:none; padding:0 12px;">Flashcards</button>
    
    <div style="display:flex; gap:12px; align-items:center; margin-left:auto;"> 
        <div style="font-size:12px; font-weight:600; opacity:0.8;">üí° Click rows to pin terms</div> 
        <button onclick="setTheme('light')" style="width:20px; height:20px; border-radius:50%; background:#fff; border:1px solid #999; cursor:pointer;"></button> 
        <button onclick="setTheme('dark')" style="width:20px; height:20px; border-radius:50%; background:#2d3436; border:1px solid #999; cursor:pointer;"></button> 
        <button onclick="setTheme('sepia')" style="width:20px; height:20px; border-radius:50%; background:#f4ecd8; border:1px solid #999; cursor:pointer;"></button> 
    </div> 
</div> 
        </section> 
    </div>

    <div class="pane-controls hidden">
        <button id="btn-split-view" class="toggle-btn" onclick="setLayout('split')">Split View</button>
        <button class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <button class="toggle-btn" onclick="setLayout('today')">Today's Vocab</button>
        <span style="color:#666; margin: 0 5px;">|</span>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html', 'Guidelines')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law/2025/index.html', 'Case Law')">Case Law ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html', 'EPC')">EPC ‚ñ¥</button>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
        let activeFlashcards = [];

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
            pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" }
        };

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
                itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
                    itemsDiv.appendChild(div);
                });
            }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
            localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) { 
            document.getElementById(id).classList.toggle('active', show); 
            const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }
        
        function linkify(text) { return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target=\"_blank\">${url}</a>`); }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
            document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ? linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            sel.innerHTML = '';
            Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = headerTranslations[k][currentMetaLang]; sel.appendChild(opt);
            });
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
            document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type; const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow(type, val = '') {
            const selectedType = type || document.getElementById('header-select').value;
            const table = document.getElementById('meta-table-body');
            let num = ''; if(['opp', 'res', 'apl'].includes(selectedType)) num = table.querySelectorAll(`tr[data-type="${selectedType}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = selectedType; tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[selectedType][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" placeholder="..." value="${val}"></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            const isHidden = document.getElementById('patent-info-wrapper').classList.toggle('hidden');
            document.getElementById('patent-hidden-indicator').classList.toggle('hidden', !isHidden);
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => {
                const clean = r.data.map(row => ({
                    en: row.EN || row.en || '', de: row.DE || row.de || '', fr: row.FR || row.fr || '',
                    definition: row.Definition || row.definition || '',
                    category: (row.Category || row.category || '').replace(/[\[\]"]/g, '').split(',').map(s => s.trim()).filter(s => s).join(', ')
                }));
                saveToHistory(file.name, clean); launchApp(clean);
            }});
        };

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.querySelector('.pane-controls').classList.remove('hidden');
            masterList = new List('main-section', { 
                valueNames: ['en', 'de', 'fr', 'category', 'definition'], 
                item: `<tr class="master-row"><td class="en col-en"></td><td class="de col-de"></td><td class="fr col-fr"></td><td class="category col-cat"></td></tr>` 
            }, data);
            masterList.items.forEach(item => {
                const v = item.values(); if (v.definition && v.definition.trim()) item.elm.querySelector('.en').innerHTML += 'üí°';
                item.elm.onclick = () => openRowDetails(v);
            });
            const cats = [...new Set(data.flatMap(i => i.category.split(',').map(s => s.trim())))].filter(s => s).sort();
            const filterEl = document.getElementById('master-cat-list'); filterEl.innerHTML = '';
            cats.forEach(c => {
                const label = document.createElement('label'); label.style.display = 'block'; label.innerHTML = `<input type="checkbox" value="${c}" class="cat-chk"> ${c}`;
                label.querySelector('input').onchange = updateFilters; filterEl.appendChild(label);
            });

            if (window.innerWidth <= 768) {
                setLayout('master');
            }
        }

        function updateFilters() {
            const sel = Array.from(document.querySelectorAll('.cat-chk:checked')).map(i => i.value);
            const badge = document.getElementById('cat-badge-val');
            const resetBtn = document.getElementById('cat-reset-btn');
            if(sel.length > 0) { badge.classList.remove('hidden'); badge.textContent = sel.length; resetBtn.classList.remove('hidden'); } else { badge.classList.add('hidden'); resetBtn.classList.add('hidden'); }
            masterList.filter(item => sel.length === 0 || sel.every(s => item.values().category.includes(s)));
        }

        function resetCategories() { document.querySelectorAll('.cat-chk').forEach(c => c.checked = false); updateFilters(); }
        function toggleCol(col, show) { document.getElementById('main-list').classList.toggle(`hide-${col}`, !show); }
        function downloadMaster() { const csv = Papa.unparse(masterList.items.map(i => i.values())); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'glossary_export.csv'; a.click(); }

        const dropArea = document.getElementById('drop-area');
        dropArea.onclick = () => { let i = document.createElement('input'); i.type='file'; i.onchange=(e)=>handleToday(e.target.files[0]); i.click(); };
        dropArea.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); };
        dropArea.ondragenter = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('drag-over'); };
        dropArea.ondragleave = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); };
        dropArea.ondrop = (e) => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleToday(e.dataTransfer.files[0]); };

        function handleToday(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const processData = (rawData) => {
                const metaTable = document.getElementById('meta-table-body');
                metaTable.innerHTML = ''; // Reset table for new load
                
                const vocab = [];
                rawData.forEach(row => {
                    let en = '', de = '', fr = '';
                    Object.keys(row).forEach(k => { 
                        const l = k.toLowerCase(); 
                        if(l==='en'||l==='english') en=row[k]; 
                        if(l==='de'||l==='german') de=row[k]; 
                        if(l==='fr'||l==='french') fr=row[k]; 
                    });

                    // Check if EN column matches a patent metadata key
                    let matchedKey = null;
                    for (const key in headerTranslations) {
                        if (en.toLowerCase().includes(headerTranslations[key].en.toLowerCase())) {
                            matchedKey = key;
                            break;
                        }
                    }

                    if (matchedKey) {
                        // Use value from DE or FR if available, otherwise blank
                        addMetaRow(matchedKey, de || fr || '');
                    } else if (en || de || fr) {
                        vocab.push({ en, de, fr });
                    }
                });
                initToday(vocab);
            };

            if (ext === 'csv') {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => processData(r.data) });
            } else if (ext === 'docx') {
                const r = new FileReader(); r.onload = (e) => mammoth.convertToHtml({arrayBuffer: e.target.result}).then(res => {
                    const temp = document.createElement('div'); temp.innerHTML = res.value; const rows = Array.from(temp.querySelectorAll('tr'));
                    if (rows.length < 1) return; 
                    const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());
                    const data = rows.slice(1).map(tr => { 
                        let o = {}; 
                        tr.querySelectorAll('td').forEach((td, i) => { if(headers[i]) o[headers[i]] = td.innerText.trim(); }); 
                        return o; 
                    });
                    processData(data);
                }); r.readAsArrayBuffer(file);
            }
        }

        function initToday(data) {
            document.getElementById('drop-area').classList.add('hidden'); 
            document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn').classList.remove('hidden');
            todayList = new List('today-section', { valueNames: ['en', 'de', 'fr'], item: `<tr onclick=\"togglePin(this)\" style=\"cursor:pointer;\"><td class=\"en\"></td><td class=\"de\"></td><td class=\"fr\"></td></tr>` }, data);
        }

        function toggleInlineAdd() {
            const header = document.getElementById('inline-add-header');
            const search = document.getElementById('today-search');
            const btn = document.getElementById('btn-toggle-add');
            const isAdding = header.classList.toggle('hidden');
            search.classList.toggle('hidden', !isAdding);
            btn.textContent = isAdding ? '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value.trim(), de = document.getElementById('new-de').value.trim(), fr = document.getElementById('new-fr').value.trim();
            if (!en) return;
            if (!todayList) initToday([{ en, de, fr }]); else todayList.add({ en, de, fr });
            document.getElementById('new-en').value = ''; document.getElementById('new-de').value = ''; document.getElementById('new-fr').value = '';
            toggleInlineAdd();
        }

        function togglePin(row) {
            const item = { en: row.querySelector('.en').textContent, de: row.querySelector('.de').textContent, fr: row.querySelector('.fr').textContent };
            const idx = pinnedItems.findIndex(i => i.en === item.en); if (idx > -1) pinnedItems.splice(idx, 1); else pinnedItems.push(item);
            renderPinned();
        }

        function renderPinned() {
            const area = document.getElementById('today-pinned-area'), body = document.getElementById('pinned-body');
            body.innerHTML = ''; area.classList.toggle('hidden', !pinnedItems.length);
            pinnedItems.forEach(item => {
                const tr = document.createElement('tr'); tr.style.background = 'rgba(0,102,204,0.2)';
                tr.onclick = () => { pinnedItems = pinnedItems.filter(i => i.en !== item.en); renderPinned(); };
                tr.innerHTML = `<td style=\"width:33%;\">üìå ${item.en}</td><td style=\"width:33%;\">${item.de}</td><td style=\"width:33%;\">${item.fr}</td>`;
                body.appendChild(tr);
            });
        }

        function resetFlashcards() {
            if (!todayList || todayList.items.length === 0) return;
            activeFlashcards = [...todayList.items.map(i => i.values())];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            flashcardIndex = 0;
            showFlashcard();
        }

        function toggleFlashcards() {
            const isVisible = document.getElementById('flashcard-ui').classList.toggle('hidden');
            document.getElementById('patent-info-wrapper').classList.toggle('hidden', !isVisible);
            if (!isVisible) resetFlashcards();
        }

        function showFlashcard() {
            const content = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            const countLabel = document.getElementById('flash-count');
            
            if (activeFlashcards.length === 0) {
                langLabel.textContent = "Finished";
                content.textContent = "All terms learned!";
                countLabel.textContent = "0 left";
                return;
            }

            const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
            isFlashcardFlipped = false;
            langLabel.textContent = source === 'en' ? 'English' : (source === 'de' ? 'German' : 'French');
            content.textContent = item[source];
            countLabel.textContent = `${activeFlashcards.length} left`;
        }

        function flipFlashcard() {
            if (activeFlashcards.length === 0) return;
            const item = activeFlashcards[flashcardIndex];
            const source = document.getElementById('flash-source-lang').value;
            const content = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            isFlashcardFlipped = !isFlashcardFlipped;
            if (isFlashcardFlipped) {
                const targets = ['en', 'de', 'fr'].filter(l => l !== source);
                langLabel.textContent = "Translations";
                content.innerHTML = `${item[targets[0]]}<br><span style="font-weight:normal; font-size:14px; opacity:0.7;">${item[targets[1]]}</span>`;
            } else {
                showFlashcard();
            }
        }

        function markFlashcardDone() {
            if (activeFlashcards.length === 0) return;
            activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = 0;
            showFlashcard();
        }

        function nextFlashcard() { 
            if (activeFlashcards.length === 0) return; 
            flashcardIndex = (flashcardIndex + 1) % activeFlashcards.length; 
            showFlashcard(); 
        }

        function prevFlashcard() { 
            if (activeFlashcards.length === 0) return; 
            flashcardIndex = (flashcardIndex - 1 + activeFlashcards.length) % activeFlashcards.length; 
            showFlashcard(); 
        }

        function setLayout(mode) {
            const m = document.getElementById('main-section'), t = document.getElementById('today-section');
            m.classList.remove('hidden', 'full-width'); t.classList.remove('hidden', 'full-width');
            document.querySelector('.header-with-logo').classList.remove('hidden');
            document.getElementById('main-list').classList.remove('hidden'); 
            document.getElementById('legal-iframe-container').classList.add('hidden');
            document.getElementById('main-title').textContent = 'Glossary';
            document.getElementById('btn-gl').textContent = 'GL ‚ñ¥'; document.getElementById('btn-cl').textContent = 'Case Law ‚ñ¥'; document.getElementById('btn-epc').textContent = 'EPC ‚ñ¥';
            if(mode === 'master') { t.classList.add('hidden'); m.classList.add('full-width'); }
            if(mode === 'today') { m.classList.add('hidden'); t.classList.add('full-width'); }
        }

        function showLegal(url, title) {
            const container = document.getElementById('legal-iframe-container'), iframe = document.getElementById('legal-frame');
            const btnId = title === 'Guidelines' ? 'btn-gl' : (title === 'Case Law' ? 'btn-cl' : 'btn-epc'), btn = document.getElementById(btnId);
            if (!container.classList.contains('hidden') && iframe.src === url) { setLayout('split'); return; }
            document.querySelector('.header-with-logo').classList.add('hidden');
            document.getElementById('main-list').classList.add('hidden'); 
            container.classList.remove('hidden'); iframe.src = url; document.getElementById('main-title').textContent = title;
            document.getElementById('btn-gl').textContent = 'GL ‚ñ¥'; document.getElementById('btn-cl').textContent = 'Case Law ‚ñ¥'; document.getElementById('btn-epc').textContent = 'EPC ‚ñ¥';
            const baseText = title === 'Guidelines' ? 'GL' : (title === 'Case Law' ? 'Case Law' : 'EPC');
            btn.textContent = baseText + ' ‚ñæ';
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t; }
        function toggleDrop(id, e) { e.stopPropagation(); const el = document.getElementById(id); const isVis = el.style.display === 'block'; document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); el.style.display = isVis ? 'none' : 'block'; }
        function downloadToday() { if (!todayList || todayList.items.length === 0) return; const csv = Papa.unparse(todayList.items.map(i => i.values())); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'today_glossary.csv'; a.click(); }

        window.onload = () => { loadHistory(); populateHeaderSelect(); ['pat', 'app', 'tit'].forEach(id => { document.getElementById('header-select').value = id; addMetaRow(); }); };
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
        document.getElementById('today-search').oninput = (e) => todayList.search(e.target.value);
    </script>
        </div>
<script>
    // 1. Core State & Lists
    let masterList, todayList, pinnedList;
    const historyKey = 'epo_dashboard_history';

    // 2. Initialization (Combined from all versions)
    window.onload = () => {
        loadHistory();
        populateHeaderSelect();
        
        // Initial setup for Metadata rows
        ['pat', 'app', 'tit'].forEach(id => {
            if(document.getElementById('header-select')) {
                document.getElementById('header-select').value = id;
                addMetaRow();
            }
        });

        // Initialize List.js (Make sure these IDs exist in your HTML)
        masterList = new List('main-section', { valueNames: ['en', 'de', 'fr', 'cat'] });
        todayList = new List('today-list-container', { valueNames: ['en', 'de', 'fr'] });
        
        // Service Worker registration (Tablet/Mobile PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    };

    // 3. File Processing (CSV & DOCX)
    function handleFile(file) {
        const reader = new FileReader();
        if (file.name.endsWith('.docx')) {
            reader.onload = e => {
                mammoth.convertToHtml({arrayBuffer: e.target.result})
                    .then(result => processDocx(result.value));
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = e => processCSV(e.target.result);
            reader.readAsText(file);
        }
    }

    function processCSV(csv) {
        const results = Papa.parse(csv, { header: true, skipEmptyLines: true });
        masterList.clear();
        masterList.add(results.data);
        saveToHistory(results.data);
    }

    // 4. "Today" List Management
    function addToToday(en, de, fr) {
        todayList.add({ en, de, fr });
        // Tablet/Desktop specific: Show flashcard if it exists
        if(typeof nextFlashcard === "function") nextFlashcard();
    }

    function downloadToday() {
        if (!todayList || todayList.items.length === 0) return;
        const csv = Papa.unparse(todayList.items.map(i => i.values()));
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'today_glossary.csv';
        a.click();
    }

    // 5. UI Helpers (Dropdowns, Themes, Toggles)
    function toggleDrop(id, e) {
        if(e) e.stopPropagation();
        const el = document.getElementById(id);
        const isVis = el.style.display === 'block';
        document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        if(el) el.style.display = isVis ? 'none' : 'block';
    }

    function setTheme(t) {
        const section = document.getElementById('today-section');
        if(section) section.className = 'theme-' + t;
    }

    function toggleSplitView() {
        const today = document.getElementById('today-section');
        const main = document.getElementById('main-section');
        today.classList.toggle('hidden');
        main.classList.toggle('full-width');
    }

    // 6. Mobile Export (PDF/DOCX) - Only runs if libraries are present
    async function exportToday(format) {
        const items = todayList.items.map(i => i.values());
        const fileName = "Glossary_Export";
        
        if (format === 'pdf' && window.jspdf) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Vocabulary List", 14, 15);
            doc.autoTable({
                head: [['English', 'German', 'French']],
                body: items.map(i => [i.en, i.de, i.fr]),
                startY: 25
            });
            doc.save(`${fileName}.pdf`);
        }
    }

    // 7. Global Listeners
    document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
    
    if(document.getElementById('master-search')) {
        document.getElementById('master-search').oninput = (e) => 
            masterList.search(e.target.value, ['en', 'de', 'fr']);
    }
</script>
</body>
</html>
