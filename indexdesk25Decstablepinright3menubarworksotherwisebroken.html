<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPOS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --today-bg: #2d3436;
            --today-text: #dfe6e9;
            --border-color: #e4e6eb;
            --accent-blue: #0066cc;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --text-main: #1c1e21;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background-color: var(--primary-bg); color: var(--text-main); height: 100vh; overflow: hidden; }

        #app-wrapper { display: flex; height: 100vh; width: 100vw; position: relative; }
        #main-section { flex: 2; padding: 15px; overflow: hidden; background: var(--primary-bg); border-right: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; min-width: 0; }
        #today-section { flex: 1.2; padding: 15px; overflow: hidden; background: var(--today-bg); color: var(--today-text); display: flex; flex-direction: column; transition: all 0.3s ease; }

        #today-section.theme-light { background: #ffffff !important; color: #1c1e21 !important; }
        #today-section.theme-dark { background: #2d3436 !important; color: #dfe6e9 !important; }
        #today-section.theme-sepia { background: #f4ecd8 !important; color: #5b4636 !important; }

        .hidden { display: none !important; }
        .full-width { flex: 1 0 100% !important; border: none !important; }

        .side-pane { 
            position: absolute;
            left: 0; top: 0; bottom: 0; 
            width: 380px; background: white; z-index: 2000; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.15); 
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            padding: 25px; display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .side-pane.active { transform: translateX(0); }
        .pane-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-pane-btn { background: #f3f4f6; border: none; font-size: 24px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .header-with-logo { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; gap: 8px; flex-shrink: 0; min-width: 0; }
        .header-center-filters { display: flex; flex-grow: 1; gap: 6px; align-items: center; min-width: 0; }
        
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
            cursor: pointer;
        }
        input[type="search"], .input-today-header { height: 40px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; min-width: 0; }
        
        .btn-ui { height: 40px; padding: 0 8px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; color: #1c1e21; font-weight: 500; }
        .btn-download { background: var(--accent-green) !important; color: white !important; border: none !important; }
        .badge-inline { background: var(--accent-blue); color: white; border-radius: 10px; padding: 1px 7px; font-size: 10px; margin-left: 4px; }

        #today-list-container { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        .today-sticky-header { position: sticky; top: 0; z-index: 100; background: inherit; padding-bottom: 10px; }
        #today-scroll-area { overflow-y: auto; flex-grow: 1; }

        .full-width #today-body, .full-width #pinned-body { display: block; columns: 2; column-gap: 50px; column-rule: 2px solid rgba(128,128,128,0.5); }
        .full-width #today-body tr, .full-width #pinned-body tr { display: flex; width: 100%; break-inside: avoid; border-bottom: 1px solid rgba(128,128,128,0.2); }
        .full-width #today-body td, .full-width #pinned-body td { flex: 1; padding: 10px 5px; }

        .today-header-container { margin-bottom: 15px; border-bottom: 1px solid rgba(128,128,128,0.3); padding-bottom: 10px; }
        .patent-info-table { width: 100%; font-size: 12px; border-collapse: collapse; background: rgba(0,0,0,0.1); }
        .patent-info-table td { padding: 6px 10px; border: 1px solid rgba(128,128,128,0.2); }
        .info-label { font-weight: bold; color: #3498db; width: 40%; }
        .input-inline-edit { background: transparent; border: none; color: inherit; width: 100%; font-size: 12px; outline: none; }

        .list-table { width: 100%; border-collapse: collapse; background: white; }
        #today-section .list-table { background: transparent; color: inherit; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.1); text-align: left; font-size: 13px; }
        #main-list.hide-en .col-en, #main-list.hide-de .col-de, #main-list.hide-fr .col-fr, #main-list.hide-cat .col-cat { display: none !important; }

        /* Modified Pane Controls for Accordion effect */
        .pane-controls { 
            position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: flex;
            gap: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid var(--border-color); 
            align-items: center;
            transition: left 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out;
            width: auto;
            max-width: 800px;
            overflow: hidden;
        }
        .pane-controls.collapsed {
            width: 85px; /* Large enough for just the Menu button */
            padding: 10px 5px;
        }
        .pane-controls.shifted { left: 400px; }
        
        .toggle-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; font-size: 11px; font-weight: 700; transition: all 0.2s; background: white; white-space: nowrap; }
        .btn-gl { background: #7f8c8d !important; color: white !important; }
        .btn-epc { background: #c0392b !important; color: white !important; }

        .recent-list { margin-top: 25px; text-align: left; }
        .recent-item { padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
        .recent-item:hover { background: #f9f9f9; }

        #drop-area.drag-over { border-color: var(--accent-blue) !important; background: rgba(0, 102, 204, 0.1) !important; }
        
        .inline-add-container { display: flex; gap: 4px; flex: 1; }
        .inline-add-container input { background: rgba(255,255,255,0.1); border: 1px solid rgba(128,128,128,0.3); color: inherit; padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; height: 40px; }
        
        .useful-links a { display: block; color: var(--accent-blue); text-decoration: none; margin-bottom: 8px; font-size: 13px; }
        .useful-links a:hover { text-decoration: underline; }

        #flashcard-container { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; min-height: 140px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(128,128,128,0.3); margin-bottom: 15px; cursor: pointer; }
        #flashcard-content { font-size: 18px; font-weight: bold; }
        #flashcard-lang { font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px; }
        .flash-lang-sel { background: rgba(0,0,0,0.2); color: inherit; border: 1px solid rgba(128,128,128,0.5); font-size: 10px; border-radius: 4px; padding: 2px; }

        .landing-header { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .landing-logo { height: 50px; width: auto; }

        @media only screen and (max-width: 768px) {
            #btn-split-view, #btn-gl, #btn-cl, #btn-epc, .pane-controls span { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="help-pane" class="side-pane">
        <div class="pane-header"><h2>User Guide</h2><button class="close-pane-btn" onclick="togglePane('help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6; overflow-y: auto;">
            <p><strong>üëÄ Views:</strong> Switch between <strong>EPO Glossary</strong> view and <strong>Today</strong> view. <strong>EPO Glossary</strong> is a comprehensive terminology reference. Access the Guidelines, Case Law and EPC via the buttons at the bottom of the screen.</p>
            <p><strong>Today's Vocab</strong> is where you add your vocab list for a specific OP.</p>
            <p><strong>üîç Search:</strong> Filter terms in any language instantly.</p>
            <p><strong>üè∑Ô∏è Categories:</strong> Click the <strong>Categories</strong> button to filter by legal or technical field.</p>
            <p><strong>‚ñ• Columns:</strong> Click the <strong>Columns</strong> button to show/hide languages or categories.</p>
            <p><strong>üí° Definitions:</strong> Click rows with a <strong>light bulb</strong> to see more information or related links.</p>
            <p><strong>üì• Download:</strong> Downloads the filtered <strong>EPO Glossary</strong> terminology only.</p>
            <p><strong>üì• Export:</strong> Exports the <strong>Today's Vocab</strong> terminology including any new terms you add during the OP.</p>
            <p><strong>üìå Pinning:</strong> Click terms in <strong>Today's Vocab</strong> list to keep terms visible at the top while scrolling.</p>
            <p><strong>üé¥ Flashcards:</strong> Flashcards help you practise your vocab for today's OP. The button appears once you load today's vocab. Click the card to flip and test yourself. Mark done to remove the card from the deck.</p>
           
            <div class="useful-links" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4>Useful Links</h4>
                <a href="https://register.epo.org/" target="_blank">EPO Patent Register</a>
                <a href="https://worldwide.espacenet.com/" target="_blank">Espacenet</a>
                <a href="https://notebooklm.google.com/" target="_blank">Google NotebookLM</a>
                <a href="https://www.deepl.com/" target="_blank">DeepL</a>
                <a href="https://claude.ai/" target="_blank">Claude AI</a>
                <a href="https://www.wikipedia.org/" target="_blank">Wikipedia</a>
            </div>
        </div>
    </div>

    <div id="landing-help-pane" class="side-pane">
        <div class="pane-header"><h2>Getting Started</h2><button class="close-pane-btn" onclick="togglePane('landing-help-pane', false)">&times;</button></div>
        <div style="font-size: 14px; line-height: 1.6;">
            <p><strong>Welcome to EPOS!</strong> This tool is designed to help EPO interpreters manage and consult terminology for oral proceedings.</p>
            <div style="margin: 15px 0; padding: 15px; border: 1px solid var(--accent-blue); border-radius: 8px; background: rgba(0, 102, 204, 0.05);">
                <h4 style="margin-top:0;">üöÄ Loading the EPO Glossary</h4>
                <ol>
                    <li>Tap the blue <strong>Load EPO Glossary</strong> button in the middle of the screen.</li>
                    <li>Open the CSV file. The Language Service will periodically provide an updated working version called <strong>EPO glossary.csv</strong>.</li>
                    <li><strong>NB</strong> If using your own file, ensure your CSV has columns titled: <em>EN, DE, FR, Category,</em> and <em>Definition</em> even if they are blank.</li>
                    <li>Recently used glossary files will be remembered during your session. Tap on a recently used file to re-open it.</li>
                </ol>
            </div>
            <p>Once the file has loaded, you can search thousands of terms instantly.</p>
            <p><strong>Oral proceedings</strong></p>
            <p>To import and consult terminology for a specific oral proceedings, you <strong>must</strong> first load the EPO glossary as described above.</p>
            <p>Then switch to the <strong>Today's vocab</strong> view and add your own glossary in either CSV or Word (.docx) format. Ensure your file has columns with <em>EN, DE, FR, Category,</em> and <em>Definition</em> in the first row. The Language Service has provided a template for you to use.</p>
        </div>
    </div>

    <div id="details-pane" class="side-pane">
        <div class="pane-header"><h2 id="det-en" style="color:var(--accent-blue); margin:0;">Term</h2><button class="close-pane-btn" onclick="togglePane('details-pane', false)">&times;</button></div>
        <div id="details-content">
            <div style="margin-bottom:20px;"><h4>Definition</h4><p id="det-def" style="font-style: italic; color: #555;">-</p></div>
            <div style="margin-bottom:20px;"><h4>German (DE)</h4><p id="det-de">-</p></div>
            <div style="margin-bottom:20px;"><h4>French (FR)</h4><p id="det-fr">-</p></div>
            <div style="margin-bottom:20px;"><h4>Category</h4><p id="det-cat">-</p></div>
        </div>
    </div>

    <div id="upload-screen" style="max-width: 450px; margin: 10vh auto; padding: 40px; background: #fff; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <div class="landing-header">
            <img src="logo.jpg" alt="Logo" class="landing-logo">
            <h1 style="margin:0;">EPOS</h1>
        </div>
        <div style="position:relative; margin-bottom: 20px;">
            <button class="btn-ui" style="width:100%; background: var(--accent-blue); color:white; height:50px; font-size:14px;">Load EPO Glossary</button>
            <input type="file" id="master-file-input" accept=".csv" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
        </div>
        <button class="btn-ui" style="width:100%; margin-bottom:20px; border: 1px solid var(--accent-blue); color: var(--accent-blue);" onclick="togglePane('landing-help-pane', true)">New here‚ùì Read this first</button>
        <div id="recent-container" class="recent-list hidden">
            <h4 style="margin-bottom: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recently used</h4>
            <div id="recent-items"></div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <section id="main-section">
            <div class="header-with-logo">
                <h2 id="main-title" style="margin:0; font-size:18px;">Glossary</h2>
                <div class="header-center-filters">
                    <input type="search" id="master-search" placeholder="Click here to search..." style="flex:2;" onsearch="masterList.search(this.value, ['en', 'de', 'fr'])">
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('cat-drop', event)">üè∑Ô∏è Categories <span id="cat-badge-val" class="badge-inline hidden">0</span> <span id="cat-reset-btn" class="hidden" style="color:var(--accent-red); margin-left:8px; font-weight:bold; cursor:pointer;" onclick="event.stopPropagation(); resetCategories()">Reset √ó</span></button>
                        <div id="cat-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <div id="master-cat-list"></div>
                        </div>
                    </div>
                   
                    <div class="dropdown-container" style="position:relative;">
                        <button class="btn-ui" onclick="toggleDrop('col-drop', event)">‚ñ• Columns</button>
                        <div id="col-drop" class="dropdown-options" style="position: absolute; top: 45px; background: white; border: 1px solid #d1d5db; z-index: 1000; max-height: 350px; width: 220px; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; padding: 10px;">
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('en', this.checked)"> English</label>
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('de', this.checked)"> German</label> 
                            <label style="display:block; margin-bottom:8px;"><input type="checkbox" checked onchange="toggleCol('fr', this.checked)"> French</label> 
                            <label style="display:block;"><input type="checkbox" checked onchange="toggleCol('cat', this.checked)"> Category</label> 
                        </div> 
                    </div> 
             
                    <button class="btn-ui" onclick="location.reload()">üîÑ Load New</button> 
                    <button class="btn-ui btn-download" onclick="downloadMaster()">üì• Download</button> 
                    <button class="btn-ui" onclick="togglePane('help-pane', true)">‚ùì Help</button> 
                </div> 
            </div> 
        
            <div id="main-scroll-area" style="flex-grow:1; overflow-y:auto;"> 
                <div id="main-list"> 
                    <table class="list-table"> 
                        <thead><tr><th class="col-en">English</th><th class="col-de">German</th><th class="col-fr">French</th><th class="col-cat">Category</th></tr></thead> 
                        <tbody class="list"></tbody> 
                    </table> 
                </div> 
                <div id="legal-iframe-container" class="hidden" style="height:100%"><iframe id="legal-frame" style="width:100%; height:100%; border:none;"></iframe></div> 
            </div> 
        </section> 
        
        <section id="today-section" class="theme-dark"> 
            <div id="patent-info-wrapper"> 
                <div style="display:flex; gap:5px; margin-bottom:10px;"> 
                    <select id="header-select" style="height:30px; font-size:11px; flex:1; background:rgba(0,0,0,0.3); color:inherit; border:1px solid #666; border-radius:4px;"></select> 
                    <button onclick="addMetaRow()" class="btn-ui" style="height:30px; width:30px; padding:0; background:rgba(255,255,255,0.1); color:inherit;">+</button> 
                    <div style="display:flex; border:1px solid #555; border-radius:4px; overflow:hidden;"> 
                        <button class="lang-toggle-btn active" onclick="setMetaLang('en')" style="padding:0 8px; font-size:10px; cursor:pointer;">EN</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('de')" style="padding:0 8px; font-size:10px; cursor:pointer;">DE</button> 
                        <button class="lang-toggle-btn" onclick="setMetaLang('fr')" style="padding:0 8px; font-size:10px; cursor:pointer;">FR</button> 
                    </div> 
                    <button onclick="togglePatentInfo()" class="btn-ui" style="height:30px; font-size:10px; padding:0 8px; background:rgba(255,255,255,0.1); color:inherit;">Hide ‚ñ¥</button> 
                </div> 
                <div id="patent-table-content" class="today-header-container"> 
                    <table class="patent-info-table" id="meta-table-body"></table> 
                </div> 
            </div> 

            <div id="flashcard-ui" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">Source:</span>
                        <select id="flash-source-lang" class="flash-lang-sel" onchange="resetFlashcards()">
                            <option value="en" selected>EN</option>
                            <option value="de">DE</option>
                            <option value="fr">FR</option>
                        </select>
                        <span id="flash-count" style="font-size:10px; margin-left:8px; opacity:0.7;"></span>
                    </div>
                    <button onclick="toggleFlashcards()" class="btn-ui" style="height:25px; padding:0 10px; font-size:10px; background:rgba(255,255,255,0.1); color:inherit;">Close √ó</button>
                </div>
                <div id="flashcard-container" onclick="flipFlashcard()">
                    <div id="flashcard-lang">---</div>
                    <div id="flashcard-content">No terms loaded</div>
                    <div style="position:absolute; bottom:10px; left:0; right:0; font-size:10px; opacity:0.5;">Click to Flip</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="prevFlashcard()" class="btn-ui" style="flex:1; background:rgba(255,255,255,0.1); color:inherit;">Previous</button>
                    <button onclick="markFlashcardDone()" class="btn-ui" style="flex:1.5; background:var(--accent-green); color:white; border:none;">Mark done ‚úÖ</button>
                    <button onclick="nextFlashcard()" class="btn-ui" style="flex:1; background:var(--accent-blue); color:white; border:none;">Next</button>
                </div>
            </div>

            <div id="patent-hidden-indicator" class="hidden" style="text-align:center; margin-bottom:10px;"> <button onclick="togglePatentInfo()" style="background:none; border:1px solid rgba(128,128,128,0.5); color:inherit; font-size:10px; padding:2px 10px; border-radius:4px; cursor:pointer;">Show Patent Info ‚ñæ</button> </div> 
            <div id="drop-area" style="border: 2px dashed rgba(128,128,128,0.5); padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;">Click to import today's vocab here as a CSV or Word (.docx) file. Or just drag and drop.</div> 
            <div id="today-list-container" class="hidden"> 
                <div class="today-sticky-header"> 
                    <div style="display:flex; gap:8px; margin-bottom:10px;"> 
                        <input type="search" id="today-search" style="flex:1; padding:10px; border-radius:6px; background:rgba(255,255,255,0.1); color:inherit; border:1px solid rgba(128,128,128,0.3);" placeholder="Filter today's terms..." onsearch="todayList.search(this.value)"> 
                        <div id="inline-add-header" class="inline-add-container hidden"> 
                            <input type="text" id="new-en" placeholder="EN term..."> 
                            <input type="text" id="new-de" placeholder="DE term..."> 
                            <input type="text" id="new-fr" placeholder="FR term..."> 
                            <button onclick="addNewTermInline()" class="btn-ui" style="background:var(--accent-blue); color:white; border:none; height:40px;">Add</button> 
                        </div> 
                        <button onclick="toggleInlineAdd()" class="btn-ui" id="btn-toggle-add" style="background:var(--accent-blue); color:white; border:none;">[+] Add Term</button> 
                        <button onclick="downloadToday()" class="btn-ui btn-download">üì• Export</button> 
                    </div> 
                    <div id="today-pinned-area" class="hidden"><table class="list-table"><tbody id="pinned-body"></tbody></table></div> 
                </div> 
                <div id="today-scroll-area"> 
                    <table class="list-table"> <tbody id="today-body" class="list"></tbody> </table> 
                </div> 
            </div> 
            
            <div style="margin-top:auto; padding-top:12px; border-top:1px solid rgba(128,128,128,0.2); display:flex; justify-content:space-between; align-items:center;"> 
                <button id="flashcard-btn" class="btn-ui hidden" onclick="toggleFlashcards()" style="height:25px; background:var(--accent-blue); color:white; border:none; padding:0 12px;">Flashcards</button>
                <div style="display:flex; gap:12px; align-items:center; margin-left:auto;"> 
                    <div style="font-size:12px; font-weight:600; opacity:0.8;">üí° Click rows to pin terms</div> 
                    <button onclick="setTheme('light')" style="width:20px; height:20px; border-radius:50%; background:#fff; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('dark')" style="width:20px; height:20px; border-radius:50%; background:#2d3436; border:1px solid #999; cursor:pointer;"></button> 
                    <button onclick="setTheme('sepia')" style="width:20px; height:20px; border-radius:50%; background:#f4ecd8; border:1px solid #999; cursor:pointer;"></button> 
                </div> 
            </div> 
        </section> 
    </div>

    <div class="pane-controls hidden" id="bottom-controls">
        <button id="btn-hide-menu" class="toggle-btn" style="background: #f0f2f5;" onclick="toggleMenu(true)">Hide ‚óÇ</button>
        <button id="btn-expand-menu" class="toggle-btn hidden" style="background: var(--accent-blue); color: white; border: none;" onclick="toggleMenu(false)">Menu ‚ò∞</button>
        
        <button id="btn-split-view" class="toggle-btn" onclick="setLayout('split')">Split View</button>
        <button class="toggle-btn" onclick="setLayout('master')">EPO Glossary</button>
        <button class="toggle-btn" onclick="setLayout('today')">Today's Vocab</button>
        <span id="sep-line" style="color:#666; margin: 0 5px;">|</span>
        <button id="btn-gl" class="toggle-btn btn-gl" onclick="showLegal('https://www.epo.org/en/legal/guidelines-epc/2025/index.html', 'Guidelines')">GL ‚ñ¥</button>
        <button id="btn-cl" class="toggle-btn btn-cl" onclick="showLegal('https://www.epo.org/en/legal/case-law/2025/index.html', 'Case Law')">Case Law ‚ñ¥</button>
        <button id="btn-epc" class="toggle-btn btn-epc" onclick="showLegal('https://www.epo.org/en/legal/epc/2020/convention.html', 'EPC')">EPC ‚ñ¥</button>
    </div>

    <script>
        let masterList, todayList, pinnedItems = [];
        let currentMetaLang = 'en';
        let flashcardIndex = 0;
        let isFlashcardFlipped = false;
        let activeFlashcards = [];

        const headerTranslations = {
            pat: { en: "Patent Number", de: "Patentnummer", fr: "Num√©ro de brevet" },
            app: { en: "Application Number", de: "Anmeldenummer", fr: "Num√©ro de d√©p√¥t" },
            tit: { en: "Title", de: "Titel", fr: "Titre" },
            pri: { en: "Priority date", de: "Priorit√§tstag", fr: "Date de priorit√©" },
            pro: { en: "Proprietor", de: "Patentinhaber", fr: "Titulaire" },
            opp: { en: "Opponent", de: "Einsprechender", fr: "Opposant(e)" },
            res: { en: "Respondent", de: "Beschwerdegegner", fr: "Intim√©(e)" },
            apl: { en: "Appellant", de: "Beschwerdef√ºhrer", fr: "Requ√©rant(e)" }
        };

        // NEW: Function to toggle the Menu Accordion
        function toggleMenu(collapsed) {
            const controls = document.getElementById('bottom-controls');
            const hideBtn = document.getElementById('btn-hide-menu');
            const menuBtn = document.getElementById('btn-expand-menu');
            const otherBtns = controls.querySelectorAll('.toggle-btn:not(#btn-hide-menu):not(#btn-expand-menu)');
            const sepLine = document.getElementById('sep-line');

            if (collapsed) {
                controls.classList.add('collapsed');
                hideBtn.classList.add('hidden');
                menuBtn.classList.remove('hidden');
                sepLine.classList.add('hidden');
                otherBtns.forEach(b => b.classList.add('hidden'));
            } else {
                controls.classList.remove('collapsed');
                hideBtn.classList.remove('hidden');
                menuBtn.classList.add('hidden');
                sepLine.classList.remove('hidden');
                otherBtns.forEach(b => b.classList.remove('hidden'));
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const container = document.getElementById('recent-container');
            const itemsDiv = document.getElementById('recent-items');
            if (history.length > 0) {
                container.classList.remove('hidden');
                itemsDiv.innerHTML = '';
                history.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<span>üìÑ ${item.name}</span><span style="font-size:11px; color:#999;">${item.date}</span>`;
                    div.onclick = () => launchApp(item.data);
                    itemsDiv.appendChild(div);
                });
            }
        }

        function saveToHistory(name, data) {
            let history = JSON.parse(localStorage.getItem('glossary_history') || '[]');
            const newItem = { name, data, date: new Date().toLocaleDateString() };
            history = [newItem, ...history.filter(h => h.name !== name)].slice(0, 5);
            localStorage.setItem('glossary_history', JSON.stringify(history));
        }

        function togglePane(id, show) {
            document.getElementById(id).classList.toggle('active', show);
            const isAnyPaneActive = document.getElementById('help-pane').classList.contains('active') || document.getElementById('details-pane').classList.contains('active');
            document.querySelector('.pane-controls').classList.toggle('shifted', isAnyPaneActive);
        }

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank">${url}</a>`);
        }

        function openRowDetails(values) {
            document.getElementById('det-en').textContent = values.en;
            document.getElementById('det-de').textContent = values.de || '-';
            document.getElementById('det-fr').textContent = values.fr || '-';
            document.getElementById('det-cat').textContent = values.category || '-';
            document.getElementById('det-def').innerHTML = values.definition ? linkify(values.definition) : 'No definition available.';
            togglePane('details-pane', true);
        }

        function populateHeaderSelect() {
            const sel = document.getElementById('header-select');
            sel.innerHTML = '';
            Object.keys(headerTranslations).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = headerTranslations[k][currentMetaLang];
                sel.appendChild(opt);
            });
        }

        function setMetaLang(lang) {
            currentMetaLang = lang;
            document.querySelectorAll('.lang-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === lang));
            populateHeaderSelect();
            document.querySelectorAll('#meta-table-body tr').forEach(tr => {
                const type = tr.dataset.type;
                const num = tr.dataset.num || '';
                tr.querySelector('.info-label').textContent = headerTranslations[type][lang] + (num ? ' ' + num : '');
            });
        }

        function addMetaRow(type, val = '') {
            const selectedType = type || document.getElementById('header-select').value;
            const table = document.getElementById('meta-table-body');
            let num = '';
            if(['opp', 'res', 'apl'].includes(selectedType)) num = table.querySelectorAll(`tr[data-type="${selectedType}"]`).length + 1;
            const tr = document.createElement('tr');
            tr.dataset.type = selectedType;
            tr.dataset.num = num;
            tr.innerHTML = `<td class="info-label">${headerTranslations[selectedType][currentMetaLang]} ${num}</td><td><input class="input-inline-edit" placeholder="..." value="${val}"></td><td style="width:20px;"><button onclick="this.parentElement.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">√ó</button></td>`;
            table.appendChild(tr);
        }

        function togglePatentInfo() {
            const isHidden = document.getElementById('patent-info-wrapper').classList.toggle('hidden');
            document.getElementById('patent-hidden-indicator').classList.toggle('hidden', !isHidden);
        }

        function launchApp(data) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.querySelector('.pane-controls').classList.remove('hidden');
            
            masterList = new List('main-list', {
                valueNames: ['col-en', 'col-de', 'col-fr', 'col-cat', { name: 'definition', attr: 'data-def' }],
                item: `<tr><td class="col-en"></td><td class="col-de"></td><td class="col-fr"></td><td class="col-cat"></td><td class="hidden definition"></td></tr>`
            }, data);

            const cats = [...new Set(data.map(i => i.category).filter(Boolean))].sort();
            const catDiv = document.getElementById('master-cat-list');
            catDiv.innerHTML = cats.map(c => `<label style="display:block; margin-bottom:8px;"><input type="checkbox" onchange="filterMaster()"> ${c}</label>`).join('');
            
            masterList.on('updated', () => {
                masterList.list.querySelectorAll('tr').forEach(tr => {
                    tr.onclick = () => {
                        const idx = Array.from(tr.parentNode.children).indexOf(tr);
                        openRowDetails(masterList.items[idx].values());
                    };
                    if (masterList.items[Array.from(tr.parentNode.children).indexOf(tr)].values().definition) {
                        tr.style.cursor = 'pointer';
                        tr.innerHTML = tr.innerHTML.replace('</td></tr>', ' üí°</td></tr>');
                    }
                });
            });
            masterList.update();
        }

        function filterMaster() {
            const checked = Array.from(document.querySelectorAll('#master-cat-list input:checked')).map(i => i.nextSibling.textContent.trim());
            document.getElementById('cat-badge-val').textContent = checked.length;
            document.getElementById('cat-badge-val').classList.toggle('hidden', checked.length === 0);
            document.getElementById('cat-reset-btn').classList.toggle('hidden', checked.length === 0);
            masterList.filter(item => checked.length === 0 || checked.includes(item.values().category));
        }

        function resetCategories() {
            document.querySelectorAll('#master-cat-list input').forEach(i => i.checked = false);
            filterMaster();
        }

        function toggleCol(col, show) {
            document.getElementById('main-list').classList.toggle('hide-' + col, !show);
        }

        function setLayout(mode) {
            const main = document.getElementById('main-section');
            const today = document.getElementById('today-section');
            const btn = document.getElementById('btn-split-view');
            
            document.getElementById('legal-iframe-container').classList.add('hidden');
            document.getElementById('main-list').classList.remove('hidden');
            document.getElementById('main-title').textContent = 'Glossary';

            if (mode === 'split') {
                main.classList.remove('hidden', 'full-width');
                today.classList.remove('hidden', 'full-width');
                btn.textContent = 'Split View';
            } else if (mode === 'master') {
                main.classList.remove('hidden'); main.classList.add('full-width');
                today.classList.add('hidden');
                btn.textContent = 'Split View';
            } else {
                main.classList.add('hidden');
                today.classList.remove('hidden'); today.classList.add('full-width');
                btn.textContent = 'Split View';
            }
        }

        function showLegal(url, title) {
            const main = document.getElementById('main-section');
            const today = document.getElementById('today-section');
            const frame = document.getElementById('legal-frame');
            const container = document.getElementById('legal-iframe-container');
            const list = document.getElementById('main-list');
            const titleEl = document.getElementById('main-title');
            const btn = document.getElementById('btn-epc');

            main.classList.remove('hidden'); main.classList.add('full-width');
            today.classList.add('hidden');
            list.classList.add('hidden');
            container.classList.remove('hidden');
            frame.src = url;
            titleEl.textContent = title;
            
            document.querySelectorAll('.btn-gl, .btn-cl, .btn-epc').forEach(b => b.textContent = b.textContent.replace(' ‚ñæ', ' ‚ñ¥'));
            document.getElementById('btn-gl').textContent = 'GL ‚ñ¥';
            document.getElementById('btn-cl').textContent = 'Case Law ‚ñ¥';
            document.getElementById('btn-epc').textContent = 'EPC ‚ñ¥';
            const baseText = title === 'Guidelines' ? 'GL' : (title === 'Case Law' ? 'Case Law' : 'EPC');
            const targetBtn = title === 'Guidelines' ? document.getElementById('btn-gl') : (title === 'Case Law' ? document.getElementById('btn-cl') : document.getElementById('btn-epc'));
            targetBtn.textContent = baseText + ' ‚ñæ';
        }

        function setTheme(t) { document.getElementById('today-section').className = 'theme-' + t; }
        
        function toggleDrop(id, e) { 
            e.stopPropagation(); 
            const el = document.getElementById(id);
            const isVis = el.style.display === 'block'; 
            document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none'); 
            el.style.display = isVis ? 'none' : 'block'; 
        }

        function downloadMaster() {
            if (!masterList) return;
            const data = masterList.matchingItems.map(i => i.values());
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'epo_glossary_filtered.csv';
            a.click();
        }

        function downloadToday() { 
            if (!todayList || todayList.items.length === 0) return;
            const csv = Papa.unparse(todayList.items.map(i => i.values())); 
            const blob = new Blob([csv], { type: 'text/csv' }); 
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; a.download = 'today_glossary.csv'; a.click();
        }

        document.getElementById('master-file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const data = results.data.map(r => ({
                        en: r.EN || '', de: r.DE || '', fr: r.FR || '', category: r.Category || '', definition: r.Definition || ''
                    }));
                    saveToHistory(file.name, data);
                    launchApp(data);
                }
            });
        };

        const dropArea = document.getElementById('drop-area');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => dropArea.addEventListener(n, e => { e.preventDefault(); e.stopPropagation(); }));
        dropArea.addEventListener('dragover', () => dropArea.classList.add('drag-over'));
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
        dropArea.addEventListener('drop', e => {
            dropArea.classList.remove('drag-over');
            handleTodayFile(e.dataTransfer.files[0]);
        });
        dropArea.onclick = () => {
            const i = document.createElement('input'); i.type = 'file'; i.accept = '.csv,.docx';
            i.onchange = (e) => handleTodayFile(e.target.files[0]);
            i.click();
        };

        function handleTodayFile(file) {
            if (!file) return;
            if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mammoth.convertToHtml({ arrayBuffer: e.target.result }).then(res => {
                        const div = document.createElement('div'); div.innerHTML = res.value;
                        const rows = Array.from(div.querySelectorAll('tr'));
                        const data = rows.slice(1).map(tr => {
                            const tds = tr.querySelectorAll('td');
                            return { en: tds[0]?.innerText || '', de: tds[1]?.innerText || '', fr: tds[2]?.innerText || '', category: tds[3]?.innerText || '', definition: tds[4]?.innerText || '' };
                        });
                        setupTodayList(data);
                    });
                };
                reader.readAsArrayBuffer(file);
            } else {
                Papa.parse(file, {
                    header: true, skipEmptyLines: true,
                    complete: (res) => setupTodayList(res.data.map(r => ({ en: r.EN || '', de: r.DE || '', fr: r.FR || '', category: r.Category || '', definition: r.Definition || '' })))
                });
            }
        }

        function setupTodayList(data) {
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('today-list-container').classList.remove('hidden');
            document.getElementById('flashcard-btn').classList.remove('hidden');
            todayList = new List('today-list-container', {
                valueNames: ['col-en', 'col-de', 'col-fr'],
                item: `<tr><td class="col-en"></td><td class="col-de"></td><td class="col-fr"></td></tr>`
            }, data);
            
            todayList.on('updated', renderTodayRows);
            renderTodayRows();
            activeFlashcards = [...data];
            resetFlashcards();
        }

        function renderTodayRows() {
            const body = document.getElementById('today-body');
            body.querySelectorAll('tr').forEach((tr, i) => {
                const item = todayList.matchingItems[i];
                if (!item) return;
                const vals = item.values();
                tr.innerHTML = `<td class="col-en">${vals.en}</td><td class="col-de">${vals.de}</td><td class="col-fr">${vals.fr}</td>`;
                tr.onclick = () => togglePin(item);
                if (pinnedItems.some(p => p.en === vals.en)) tr.style.opacity = '0.3';
            });
        }

        function togglePin(item) {
            const vals = item.values();
            const idx = pinnedItems.findIndex(p => p.en === vals.en);
            if (idx > -1) pinnedItems.splice(idx, 1);
            else pinnedItems.push(vals);
            
            const area = document.getElementById('today-pinned-area');
            const body = document.getElementById('pinned-body');
            area.classList.toggle('hidden', pinnedItems.length === 0);
            body.innerHTML = pinnedItems.map(p => `<tr onclick='removePin("${p.en}")'><td class="col-en">${p.en}</td><td class="col-de">${p.de}</td><td class="col-fr">${p.fr}</td></tr>`).join('');
            renderTodayRows();
        }

        window.removePin = (en) => {
            pinnedItems = pinnedItems.filter(p => p.en !== en);
            const area = document.getElementById('today-pinned-area');
            area.classList.toggle('hidden', pinnedItems.length === 0);
            document.getElementById('pinned-body').innerHTML = pinnedItems.map(p => `<tr onclick='removePin("${p.en}")'><td class="col-en">${p.en}</td><td class="col-de">${p.de}</td><td class="col-fr">${p.fr}</td></tr>`).join('');
            renderTodayRows();
        };

        function toggleInlineAdd() {
            const cont = document.getElementById('inline-add-header');
            const btn = document.getElementById('btn-toggle-add');
            const isHidden = cont.classList.toggle('hidden');
            btn.textContent = isHidden ? '[+] Add Term' : 'Cancel';
        }

        function addNewTermInline() {
            const en = document.getElementById('new-en').value;
            const de = document.getElementById('new-de').value;
            const fr = document.getElementById('new-fr').value;
            if (!en && !de && !fr) return;
            todayList.add({ en, de, fr, category: '', definition: '' });
            activeFlashcards.push({ en, de, fr });
            document.getElementById('new-en').value = '';
            document.getElementById('new-de').value = '';
            document.getElementById('new-fr').value = '';
            toggleInlineAdd();
            resetFlashcards();
        }

        function toggleFlashcards() {
            document.getElementById('flashcard-ui').classList.toggle('hidden');
            document.getElementById('today-list-container').classList.toggle('hidden');
        }

        function resetFlashcards() {
            flashcardIndex = 0;
            isFlashcardFlipped = false;
            updateFlashcard();
        }

        function updateFlashcard() {
            const card = activeFlashcards[flashcardIndex];
            const lang = document.getElementById('flash-source-lang').value;
            const display = document.getElementById('flashcard-content');
            const langLabel = document.getElementById('flashcard-lang');
            const count = document.getElementById('flash-count');
            
            if (!card) {
                display.textContent = "No more cards!";
                langLabel.textContent = "---";
                count.textContent = "";
                return;
            }

            count.textContent = `${flashcardIndex + 1} / ${activeFlashcards.length}`;
            if (!isFlashcardFlipped) {
                langLabel.textContent = lang.toUpperCase();
                display.textContent = card[lang] || "(empty)";
                display.style.color = "inherit";
            } else {
                const targets = ['en', 'de', 'fr'].filter(l => l !== lang);
                langLabel.textContent = targets.join(' / ').toUpperCase();
                display.textContent = targets.map(l => card[l] || "-").join(' | ');
                display.style.color = "var(--accent-blue)";
            }
        }

        function flipFlashcard() { isFlashcardFlipped = !isFlashcardFlipped; updateFlashcard(); }
        function nextFlashcard() { if (flashcardIndex < activeFlashcards.length - 1) { flashcardIndex++; isFlashcardFlipped = false; updateFlashcard(); } }
        function prevFlashcard() { if (flashcardIndex > 0) { flashcardIndex--; isFlashcardFlipped = false; updateFlashcard(); } }
        function markFlashcardDone() {
            activeFlashcards.splice(flashcardIndex, 1);
            if (flashcardIndex >= activeFlashcards.length) flashcardIndex = Math.max(0, activeFlashcards.length - 1);
            isFlashcardFlipped = false;
            updateFlashcard();
        }

        window.onload = () => { 
            loadHistory(); 
            populateHeaderSelect(); 
            ['pat', 'app', 'tit'].forEach(id => { document.getElementById('header-select').value = id; addMetaRow(); }); 
        };
        
        document.onclick = () => document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
        document.getElementById('master-search').oninput = (e) => masterList.search(e.target.value, ['en', 'de', 'fr']);
    </script>
</body>
</html>
